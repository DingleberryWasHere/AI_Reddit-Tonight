<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dingle AI | Content Creator Suite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- Professional Font Stack -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Montserrat:wght@800;900&family=Oswald:wght@700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root { --accent: #111827; --accent-hover: #374151; }
        /* Strict Viewport Lock to prevent "scroll breakdown" */
        html, body { height: 100%; height: 100dvh; width: 100%; overflow: hidden; overscroll-behavior: none; }
        body { font-family: 'Inter', sans-serif; background-color: #f9fafb; color: #111827; antialiased; }
        
        /* Glassmorphism & UI Utilities */
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border: 1px solid #e5e7eb; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 4px; }
        
        /* Premium Slider */
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%;
            background: #111827; margin-top: -6px; cursor: pointer;
            box-shadow: 0 0 0 2px #fff, 0 4px 6px rgba(0,0,0,0.1); transition: transform 0.1s;
        }
        input[type=range]::-webkit-slider-thumb:hover { transform: scale(1.1); }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; cursor: pointer; background: #e5e7eb; border-radius: 2px;
        }

        /* Animations */
        @keyframes pulse-subtle { 0%, 100% { opacity: 1; } 50% { opacity: 0.8; } }
        .animate-pulse-slow { animation: pulse-subtle 3s infinite; }
        .trial-glow { box-shadow: 0 0 0 2px #3b82f6, 0 0 15px rgba(59, 130, 246, 0.3); }
        
        /* File Input Hide */
        .sr-only-input { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); border: 0; }
    </style>
</head>
<body class="h-full w-full flex flex-col md:flex-row text-gray-900">

    <!-- Sidebar Configuration -->
    <div id="sidebar" class="w-full md:w-[460px] flex flex-col border-r border-gray-200 bg-white z-30 shadow-2xl h-full transition-transform duration-300">
        
        <!-- App Header -->
        <div class="px-6 py-5 border-b border-gray-100 flex justify-between items-center shrink-0 bg-white">
            <div>
                <h1 class="text-xl font-bold tracking-tight text-gray-900 flex items-center gap-2.5">
                    <div class="bg-gray-900 text-white p-1.5 rounded-lg shadow-sm"><i data-lucide="bot" class="w-4 h-4"></i></div>
                    DINGLE <span class="text-gray-400 font-medium">AI</span>
                </h1>
            </div>
            <div class="flex gap-2">
                <button onclick="resetApp()" class="p-2 hover:bg-gray-100 rounded-lg text-gray-400 hover:text-red-500 transition-colors" title="Reset Workspace">
                    <i data-lucide="rotate-ccw" class="w-4 h-4"></i>
                </button>
            </div>
        </div>

        <!-- Free Trial Banner (Dynamic) -->
        <div id="trialBanner" class="hidden mx-6 mt-6 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-100 rounded-xl relative overflow-hidden group shrink-0">
            <!-- Close Button -->
            <button onclick="dismissTrial()" class="absolute top-2 right-2 p-1 text-blue-300 hover:text-blue-600 rounded-full hover:bg-blue-100 transition-colors z-10">
                <i data-lucide="x" class="w-3.5 h-3.5"></i>
            </button>
            
            <div class="absolute top-0 right-0 p-3 opacity-10 group-hover:opacity-20 transition-opacity pointer-events-none"><i data-lucide="zap" class="w-12 h-12 text-blue-600"></i></div>
            <h3 class="text-blue-900 font-bold text-sm flex items-center gap-2"><i data-lucide="sparkles" class="w-3 h-3 text-blue-600"></i> Free Trial Available</h3>
            <p class="text-xs text-blue-700 mt-1 leading-relaxed pr-4">Experience Dingle AI Pro with 1 free generation credit.</p>
            <button onclick="activateTrial()" class="mt-3 w-full bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold py-2 rounded-lg shadow-sm transition-all flex justify-center items-center gap-2">
                Activate 1-Time Trial
            </button>
        </div>

        <!-- Scrollable Workspace -->
        <div class="flex-1 overflow-y-auto p-6 space-y-8 custom-scrollbar">

            <!-- API Configuration -->
            <div class="space-y-3" id="apiConfigSection">
                <div class="flex justify-between items-end">
                    <label class="text-[11px] font-bold text-gray-400 uppercase tracking-wider">Access Key</label>
                    <span id="keyStatus" class="text-[10px] font-medium text-green-600 flex items-center gap-1 hidden bg-green-50 px-2 py-0.5 rounded-full"><i data-lucide="check" class="w-3 h-3"></i> Connected</span>
                </div>
                <div class="relative group">
                    <input id="apiKey" type="password" oninput="saveKey()" class="w-full bg-gray-50 border border-gray-200 text-gray-800 text-xs rounded-xl px-4 py-3 focus:ring-2 focus:ring-gray-900 focus:border-transparent outline-none transition-all font-mono" placeholder="Paste Google Gemini API Key">
                    <div class="absolute right-3 top-3 text-gray-400 group-hover:text-gray-600 cursor-help" title="Required for AI generation"><i data-lucide="key" class="w-4 h-4"></i></div>
                </div>
                <div id="trialActiveBadge" class="hidden items-center gap-2 text-xs text-blue-600 font-medium bg-blue-50 px-3 py-2 rounded-lg border border-blue-100">
                    <div class="w-2 h-2 bg-blue-500 rounded-full animate-pulse"></div> Trial Active (1 Credit Remaining)
                </div>
            </div>

            <!-- Workflow: Script -->
            <section class="space-y-4">
                <div class="flex items-center justify-between">
                    <h2 class="text-xs font-bold text-gray-900 flex items-center gap-2">
                        <span class="w-5 h-5 rounded bg-gray-100 flex items-center justify-center text-gray-600 font-serif">1</span>
                        SCRIPTWRITER
                    </h2>
                    <div class="flex gap-1">
                        <button onclick="randomTopic()" class="p-1.5 text-gray-400 hover:text-gray-900 hover:bg-gray-100 rounded transition-colors" title="Surprise Me"><i data-lucide="shuffle" class="w-3.5 h-3.5"></i></button>
                        <button onclick="cleanScript()" class="p-1.5 text-gray-400 hover:text-gray-900 hover:bg-gray-100 rounded transition-colors" title="Clean Text"><i data-lucide="eraser" class="w-3.5 h-3.5"></i></button>
                    </div>
                </div>
                
                <div class="flex gap-2">
                    <input id="topicInput" type="text" value="r/confessions" class="flex-1 bg-white border border-gray-200 rounded-lg px-3 py-2 text-xs focus:border-gray-900 outline-none transition-colors shadow-sm" placeholder="Topic (e.g., 'Work Stories')">
                    <button onclick="generateScript()" id="scriptBtn" class="bg-gray-900 text-white px-4 rounded-lg font-bold text-xs hover:bg-gray-800 transition-all shadow-md active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed">
                        Generate
                    </button>
                </div>

                <div class="relative">
                    <textarea id="scriptText" oninput="updateStats()" rows="4" class="w-full bg-gray-50 border-0 rounded-xl p-3 text-xs focus:ring-1 focus:ring-gray-200 outline-none text-gray-700 resize-none leading-relaxed" placeholder="Script content..."></textarea>
                    <div id="scriptStats" class="absolute bottom-3 right-3 text-[10px] text-gray-400 font-mono bg-white/80 px-2 py-1 rounded shadow-sm border border-gray-100">0w | 0s</div>
                </div>
            </section>

            <!-- Workflow: Audio -->
            <section class="space-y-4">
                <h2 class="text-xs font-bold text-gray-900 flex items-center gap-2">
                    <span class="w-5 h-5 rounded bg-gray-100 flex items-center justify-center text-gray-600 font-serif">2</span>
                    VOICE & AUDIO
                </h2>

                <div class="grid grid-cols-2 gap-3">
                    <button onclick="selectVoice('Puck')" id="voice-Puck" class="voice-btn relative bg-gray-900 text-white border border-transparent rounded-xl py-2.5 text-xs font-bold shadow-md transition-all">
                        Puck <span class="opacity-50 font-normal ml-1">(M)</span>
                        <div class="absolute top-1 right-1 w-1.5 h-1.5 bg-green-400 rounded-full"></div>
                    </button>
                    <button onclick="selectVoice('Kore')" id="voice-Kore" class="voice-btn relative bg-white text-gray-600 border border-gray-200 hover:border-gray-300 rounded-xl py-2.5 text-xs font-bold transition-all">
                        Kore <span class="opacity-50 font-normal ml-1">(F)</span>
                    </button>
                </div>

                <div class="bg-white border border-gray-200 rounded-xl p-4 space-y-4 shadow-sm">
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <label class="flex items-center gap-2 cursor-pointer hover:text-blue-600 transition-colors group">
                                <div class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center group-hover:bg-blue-50 text-gray-500 group-hover:text-blue-600">
                                    <i data-lucide="music" class="w-4 h-4"></i>
                                </div>
                                <div>
                                    <div class="text-[10px] font-bold text-gray-900">Backing Track</div>
                                    <div id="musicName" class="text-[9px] text-gray-400 truncate w-24">None selected</div>
                                </div>
                                <input type="file" id="bgMusicInput" accept="audio/*" class="sr-only-input" onchange="handleMusicUpload(this)">
                            </label>
                            
                            <!-- Simple Volume Mixer -->
                             <div class="flex items-center gap-2">
                                <i data-lucide="volume-1" class="w-3 h-3 text-gray-400"></i>
                                <input type="range" id="musicVolSlider" min="0" max="0.4" step="0.01" value="0.1" class="w-16 custom-range" oninput="updateMixer()">
                             </div>
                        </div>
                        
                        <div class="flex items-center justify-between pt-2 border-t border-gray-100">
                            <span class="text-[10px] font-medium text-gray-500">Speed</span>
                            <input type="range" id="speedSlider" min="0.8" max="1.5" step="0.05" value="1.0" class="w-24 custom-range">
                        </div>
                    </div>
                </div>
                
                <button onclick="generateAudio()" id="audioBtn" class="w-full group bg-white border border-gray-200 hover:border-gray-900 hover:bg-gray-50 text-gray-900 py-2.5 rounded-lg font-bold text-xs transition-all flex justify-center items-center gap-2">
                    <i data-lucide="wand-2" class="w-3.5 h-3.5 text-gray-400 group-hover:text-gray-900 transition-colors"></i> Synthesize Speech
                </button>
            </section>

            <!-- Workflow: Visuals -->
            <section class="space-y-4">
                <h2 class="text-xs font-bold text-gray-900 flex items-center gap-2">
                    <span class="w-5 h-5 rounded bg-gray-100 flex items-center justify-center text-gray-600 font-serif">3</span>
                    COMPOSITOR
                </h2>

                <div class="space-y-2">
                     <select id="bgMode" onchange="toggleBgMode()" class="w-full bg-white border border-gray-200 text-gray-700 text-xs font-medium rounded-lg px-3 py-2.5 outline-none focus:border-gray-900 cursor-pointer">
                        <option value="upload">Custom Video File (MP4)</option>
                        <option value="tunnel">Procedural: Neon Tunnel</option>
                        <option value="particles">Procedural: Void Particles</option>
                        <option value="solid">Solid Background</option>
                    </select>

                    <div id="videoUploadContainer" class="border-2 border-dashed border-gray-200 rounded-xl p-6 text-center transition-all hover:border-gray-400 hover:bg-gray-50 group" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event)">
                        <input type="file" id="bgVideoInput" accept="video/*" class="sr-only-input" onchange="handleVideoUpload(this.files[0])">
                        <label for="bgVideoInput" class="cursor-pointer flex flex-col items-center gap-2">
                            <div class="p-3 bg-gray-50 rounded-full group-hover:scale-110 transition-transform"><i data-lucide="upload-cloud" class="w-5 h-5 text-gray-400 group-hover:text-gray-900"></i></div>
                            <span class="text-[10px] text-gray-400 font-bold uppercase tracking-wide group-hover:text-gray-600">Drop 1080p/4K Video</span>
                        </label>
                    </div>
                </div>

                <!-- Text Styles -->
                <div class="bg-white border border-gray-200 rounded-xl p-4 grid grid-cols-2 gap-3 shadow-sm">
                    <div class="col-span-2">
                        <label class="text-[9px] font-bold text-gray-400 uppercase mb-1.5 block">Typography</label>
                        <select id="fontSelect" onchange="redrawCanvas()" class="w-full bg-gray-50 border-0 rounded-lg text-xs py-2 px-2 font-medium text-gray-800 focus:ring-0 cursor-pointer">
                            <option value="Montserrat">Montserrat (Viral Standard)</option>
                            <option value="Bangers">Bangers (Comic/Loud)</option>
                            <option value="Oswald">Oswald (Tall/Condensed)</option>
                            <option value="Inter">Inter (Clean/Modern)</option>
                        </select>
                    </div>
                    
                    <div>
                         <label class="text-[9px] font-bold text-gray-400 uppercase mb-1.5 block">Size</label>
                         <input type="range" id="textSizeSlider" min="30" max="100" value="60" class="custom-range w-full" oninput="redrawCanvas()">
                    </div>
                    <div>
                         <label class="text-[9px] font-bold text-gray-400 uppercase mb-1.5 block">Position</label>
                         <input type="range" id="textPosSlider" min="-300" max="300" value="0" class="custom-range w-full" oninput="redrawCanvas()">
                    </div>
                    <div class="col-span-2 flex justify-between items-center pt-2 border-t border-gray-100">
                        <span class="text-[10px] text-gray-500">Colors</span>
                        <div class="flex gap-2">
                            <input type="color" id="textColor" value="#ffffff" class="w-6 h-6 rounded cursor-pointer border-0 p-0" oninput="redrawCanvas()" title="Main Text">
                            <input type="color" id="highlightColor" value="#fbbf24" class="w-6 h-6 rounded cursor-pointer border-0 p-0" oninput="redrawCanvas()" title="Highlight Text">
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Bottom Spacer -->
            <div class="h-10"></div>
        </div>

        <!-- Sticky Footer -->
        <div class="p-5 border-t border-gray-200 bg-white space-y-3 z-40 shrink-0">
            <div class="grid grid-cols-2 gap-3">
                <button onclick="togglePlayback()" id="playBtn" disabled class="bg-gray-100 text-gray-400 cursor-not-allowed py-3.5 rounded-xl font-bold text-xs transition-all flex items-center justify-center gap-2 hover:bg-gray-200">
                    <i data-lucide="play" class="w-4 h-4"></i> PREVIEW
                </button>
                
                <button onclick="toggleCinemaMode()" id="renderBtn" disabled class="bg-gray-100 text-gray-400 cursor-not-allowed py-3.5 rounded-xl font-bold text-xs transition-all flex items-center justify-center gap-2 hover:bg-gray-200">
                    <i data-lucide="film" class="w-4 h-4"></i> RENDER
                </button>
            </div>
            <div id="statusText" class="text-[10px] text-center text-gray-400 font-mono flex items-center justify-center gap-1.5">
                <span class="w-1.5 h-1.5 rounded-full bg-gray-300"></span> System Ready
            </div>
        </div>
    </div>

    <!-- MAIN CANVAS AREA -->
    <div class="flex-1 bg-gray-100 relative flex justify-center items-center overflow-hidden bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]">
        
        <!-- Toast Container -->
        <div id="toastContainer" class="absolute top-8 z-[100] flex flex-col gap-2 items-center w-full pointer-events-none"></div>

        <!-- Canvas Wrapper (Aspect Ratio Lock) -->
        <div id="canvasWrapper" class="relative shadow-2xl rounded-[2.5rem] overflow-hidden border-[10px] border-gray-900 bg-black aspect-[9/16] h-auto max-h-[90dvh] transition-transform duration-500">
            
            <!-- Core Canvas -->
            <canvas id="mainCanvas" class="w-full h-full object-cover block"></canvas>
            
            <!-- Video Source (Hidden) -->
            <video id="sourceVideo" class="hidden" loop muted playsinline crossorigin="anonymous"></video>

            <!-- Render/Cinema Overlay -->
            <div id="cinemaOverlay" class="absolute inset-0 bg-black/90 backdrop-blur-md z-50 flex flex-col items-center justify-center hidden opacity-0 transition-opacity duration-300">
                <div class="bg-white p-8 rounded-3xl shadow-2xl text-center space-y-6 w-[340px] border border-gray-100 transform scale-95 transition-transform duration-300" id="renderModal">
                    <div class="space-y-1">
                        <h2 class="text-2xl font-black tracking-tight text-gray-900">EXPORT VIDEO</h2>
                        <p class="text-xs text-gray-500">Configure your final render settings.</p>
                    </div>
                    
                    <div class="space-y-4 text-left">
                        <div class="space-y-1.5">
                            <label class="text-[10px] font-bold text-gray-400 uppercase pl-1">Quality</label>
                            <select id="renderRes" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 text-sm font-bold text-gray-800 outline-none focus:border-gray-900">
                                <option value="1080">1080p (Fast • Standard)</option>
                                <option value="2160">4K UHD (Slow • High Quality)</option>
                            </select>
                        </div>
                        
                         <div class="space-y-1.5">
                            <label class="text-[10px] font-bold text-gray-400 uppercase pl-1">Frame Rate</label>
                             <div class="flex bg-gray-50 border border-gray-200 rounded-xl p-1">
                                 <button onclick="setFps(30)" id="fps30" class="flex-1 py-2 rounded-lg bg-gray-900 text-white text-xs font-bold shadow-sm transition-all">30 FPS</button>
                                 <button onclick="setFps(60)" id="fps60" class="flex-1 py-2 rounded-lg text-gray-500 text-xs font-bold hover:text-gray-900 transition-all">60 FPS</button>
                             </div>
                        </div>
                    </div>

                    <button onclick="startRendering()" id="startRenderBtn" class="w-full bg-red-600 hover:bg-red-700 text-white py-3.5 rounded-xl font-bold text-sm shadow-lg shadow-red-100 transition-all flex items-center justify-center gap-2 group">
                        <i data-lucide="download" class="w-4 h-4 group-hover:scale-110 transition-transform"></i> START RENDER
                    </button>
                    
                    <button onclick="toggleCinemaMode()" class="text-xs text-gray-400 hover:text-gray-900 font-medium">Cancel</button>
                </div>
                
                <!-- Progress State -->
                <div id="renderProgressContainer" class="hidden absolute inset-0 bg-black flex flex-col items-center justify-center text-white space-y-6">
                    <div class="relative w-20 h-20">
                        <div class="absolute inset-0 border-4 border-gray-800 rounded-full"></div>
                        <div class="absolute inset-0 border-4 border-t-red-600 rounded-full animate-spin"></div>
                    </div>
                    <div class="text-center space-y-2">
                        <h3 class="font-bold text-2xl tracking-tight">RENDERING...</h3>
                        <p class="text-sm text-gray-500 font-mono">Do not close this tab</p>
                    </div>
                </div>
            </div>

            <!-- Play Overlay -->
            <div id="playOverlay" onclick="togglePlayback()" class="absolute inset-0 z-10 cursor-pointer flex items-center justify-center bg-black/20 opacity-0 hover:opacity-100 transition-opacity">
                <div class="bg-white/20 backdrop-blur-sm p-6 rounded-full border border-white/30 shadow-2xl transform hover:scale-110 transition-transform">
                     <i data-lucide="play" class="w-12 h-12 text-white fill-white"></i>
                </div>
            </div>
        </div>
        
        <!-- Audio Hidden -->
        <audio id="ttsPlayer" class="hidden" crossorigin="anonymous"></audio>
        <audio id="musicPlayer" class="hidden" loop crossorigin="anonymous"></audio>

    </div>

    <script>
        // --- CONSTANTS ---
        const FREE_TRIAL_KEY = "AIzaSyDLJpNCwSL8VV4KKaIj6yQpdDuYKqpdXEo";
        const CANVAS_WIDTH = 1080;
        const CANVAS_HEIGHT = 1920;
        
        // --- STATE ---
        let renderFps = 30;
        let audioBlob = null;
        let wordMeta = [];
        let isPlaying = false;
        let isRendering = false;
        let animationId;
        
        // Audio Context (Created on User Interaction)
        let audioCtx; 
        
        // 3D
        let scene, camera, renderer, meshGroup;

        // --- DOM ---
        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d', { alpha: false }); // Optimize for speed
        const ttsPlayer = document.getElementById('ttsPlayer');
        const musicPlayer = document.getElementById('musicPlayer');
        const sourceVideo = document.getElementById('sourceVideo');

        // --- INIT ---
        window.onload = () => {
            lucide.createIcons();
            initCanvas();
            checkTrialStatus();
            loadKey();
            init3D();
        };

        function initCanvas() {
            canvas.width = CANVAS_WIDTH;
            canvas.height = CANVAS_HEIGHT;
            redrawCanvas(); 
        }

        // --- FREE TRIAL LOGIC ---
        function checkTrialStatus() {
            const dismissed = localStorage.getItem('viralgen_trial_dismissed');
            const used = localStorage.getItem('viralgen_trial_used');
            const manualKey = localStorage.getItem('viralgen_key');
            
            // Should we show the banner?
            // Show if: not used, not dismissed, and no manual key saved
            if(!used && !dismissed && !manualKey) {
                document.getElementById('trialBanner').classList.remove('hidden');
            } 
            
            // If active, show badge regardless of banner
            if (used === 'active') {
                showTrialActiveState();
            }
        }

        function activateTrial() {
            if(localStorage.getItem('viralgen_trial_used') === 'exhausted') {
                showToast("Free trial already used.", "error");
                return;
            }
            localStorage.setItem('viralgen_trial_used', 'active');
            showTrialActiveState();
            showToast("Free Trial Activated! 1 Credit Added.");
        }
        
        function dismissTrial() {
            localStorage.setItem('viralgen_trial_dismissed', 'true');
            document.getElementById('trialBanner').classList.add('hidden');
        }

        function showTrialActiveState() {
            document.getElementById('trialBanner').classList.add('hidden');
            document.getElementById('apiKey').value = "FREE-TRIAL-ACTIVE-••••••••";
            document.getElementById('apiKey').disabled = true;
            document.getElementById('trialActiveBadge').classList.remove('hidden');
            document.getElementById('trialActiveBadge').classList.add('flex');
            document.getElementById('keyStatus').classList.remove('hidden');
        }
        
        function consumeTrial() {
            if(localStorage.getItem('viralgen_trial_used') === 'active') {
                localStorage.setItem('viralgen_trial_used', 'exhausted');
                document.getElementById('trialActiveBadge').innerHTML = "Trial Exhausted. Add Key.";
                document.getElementById('trialActiveBadge').classList.replace('text-blue-600','text-red-600');
                document.getElementById('trialActiveBadge').classList.replace('bg-blue-50','bg-red-50');
                document.getElementById('trialActiveBadge').classList.replace('border-blue-100','border-red-100');
            }
        }
        
        function getEffectiveKey() {
            if(localStorage.getItem('viralgen_trial_used') === 'active') return FREE_TRIAL_KEY;
            const uiKey = document.getElementById('apiKey').value;
            if(uiKey && !uiKey.startsWith("FREE-TRIAL")) return uiKey;
            return localStorage.getItem('viralgen_key');
        }

        // --- RENDER PIPELINE ---
        function drawFrame() {
            // 1. Background
            const mode = document.getElementById('bgMode').value;
            
            if (mode === 'upload') {
                if (sourceVideo.readyState >= 2) {
                    const rV = sourceVideo.videoWidth / sourceVideo.videoHeight;
                    const rC = canvas.width / canvas.height;
                    let dW, dH, dX, dY;
                    if (rV > rC) { dH = canvas.height; dW = dH * rV; dX = (canvas.width - dW) / 2; dY = 0; }
                    else { dW = canvas.width; dH = dW / rV; dX = 0; dY = (canvas.height - dH) / 2; }
                    ctx.drawImage(sourceVideo, dX, dY, dW, dH);
                } else {
                    ctx.fillStyle = "#000"; ctx.fillRect(0,0,canvas.width, canvas.height); // Buffer safety
                }
            } else if (mode === 'solid') {
                ctx.fillStyle = '#111827'; ctx.fillRect(0, 0, canvas.width, canvas.height);
            } else {
                if(renderer) {
                    animate3D();
                    ctx.drawImage(renderer.domElement, 0, 0, canvas.width, canvas.height);
                }
            }

            // 2. Dimmer
            ctx.fillStyle = 'rgba(0,0,0,0.35)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // 3. Captions
            if ((isPlaying || isRendering) && !ttsPlayer.paused) {
                const prog = ttsPlayer.currentTime / ttsPlayer.duration;
                const item = wordMeta.find(m => prog <= m.endPerc);
                if (item) drawCaption(item.word);
                
                // Progress Bar
                const bw = canvas.width * 0.85;
                const bh = 15;
                const bx = (canvas.width - bw) / 2;
                const by = canvas.height - 180;
                
                ctx.fillStyle = 'rgba(255,255,255,0.2)';
                ctx.beginPath(); ctx.roundRect(bx, by, bw, bh, 99); ctx.fill();
                ctx.fillStyle = '#ffffff';
                ctx.shadowColor = 'rgba(255,255,255,0.5)'; ctx.shadowBlur = 20;
                ctx.beginPath(); ctx.roundRect(bx, by, bw * prog, bh, 99); ctx.fill();
                ctx.shadowBlur = 0;
            } else {
                if(!isPlaying && !isRendering) drawCaption("VIRAL VIDEO");
            }
        }

        function drawCaption(text) {
            const size = parseInt(document.getElementById('textSizeSlider').value);
            const yOff = parseInt(document.getElementById('textPosSlider').value);
            const font = document.getElementById('fontSelect').value;
            const colMain = document.getElementById('textColor').value;
            const colHigh = document.getElementById('highlightColor').value;

            const clean = text.replace(/[^a-zA-Z0-9]/g, "").toUpperCase();
            const isHigh = ['WHAT','WHY','NO','STOP','DIED','KILLED','SECRET','MONEY','WTF','OMG'].includes(clean) || clean.length > 7;

            // Responsive Scaling
            const scale = canvas.width / 1080;
            const finalSize = scale * (isHigh ? size * 1.6 : size * 2.5);
            
            ctx.font = `900 ${finalSize}px "${font}", sans-serif`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            
            const x = canvas.width / 2;
            const y = (canvas.height / 2) + (yOff * scale);

            // Stroke
            ctx.lineJoin = 'round';
            ctx.miterLimit = 2;
            ctx.lineWidth = finalSize * 0.15;
            ctx.strokeStyle = 'black';
            ctx.strokeText(text.toUpperCase(), x, y);

            // Fill
            ctx.fillStyle = isHigh ? colHigh : colMain;
            ctx.fillText(text.toUpperCase(), x, y);
        }

        function redrawCanvas() { if(!isPlaying) requestAnimationFrame(drawFrame); }

        // --- AUDIO ENGINE V2 (ROBUST) ---
        function ensureAudioContext() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
            return audioCtx;
        }

        // --- RECORDING ---
        async function startRendering() {
            if (!audioBlob) return showToast("No audio generated yet.", "error");
            
            isRendering = true;
            document.getElementById('renderModal').classList.add('hidden');
            document.getElementById('renderProgressContainer').classList.remove('hidden');

            const ctxTarget = ensureAudioContext();
            
            // Setup High Res Canvas
            const res = parseInt(document.getElementById('renderRes').value);
            canvas.width = res;
            canvas.height = res * (16/9);

            // Create Destination for Mixed Audio
            const dest = ctxTarget.createMediaStreamDestination();
            
            const audioBuffer = await fetch(ttsPlayer.src).then(r=>r.arrayBuffer()).then(b=>ctxTarget.decodeAudioData(b));
            const ttsSource = ctxTarget.createBufferSource();
            ttsSource.buffer = audioBuffer;
            ttsSource.connect(dest);
            
            // Music handling (Buffer approach for safety)
            let musicSource;
            if(musicPlayer.src) {
                try {
                    const mBuf = await fetch(musicPlayer.src).then(r=>r.arrayBuffer()).then(b=>ctxTarget.decodeAudioData(b));
                    musicSource = ctxTarget.createBufferSource();
                    musicSource.buffer = mBuf;
                    musicSource.loop = true;
                    // Apply volume
                    const gain = ctxTarget.createGain();
                    gain.gain.value = musicPlayer.volume;
                    musicSource.connect(gain).connect(dest);
                } catch(e) { console.warn("Music load failed for render", e); }
            }

            // Canvas Stream
            const stream = canvas.captureStream(renderFps);
            const combinedStream = new MediaStream([...stream.getVideoTracks(), ...dest.stream.getAudioTracks()]);
            
            const recorder = new MediaRecorder(combinedStream, {
                mimeType: 'video/webm; codecs=vp9',
                videoBitsPerSecond: res === 2160 ? 25000000 : 8000000
            });
            
            const chunks = [];
            recorder.ondataavailable = e => chunks.push(e.data);
            recorder.onstop = () => {
                const b = new Blob(chunks, { type: 'video/webm' });
                const url = URL.createObjectURL(b);
                const a = document.createElement('a');
                a.href = url;
                a.download = `DingleAI_Export_${Date.now()}.webm`;
                a.click();
                
                // Cleanup
                isRendering = false;
                canvas.width = CANVAS_WIDTH; // Reset prev
                canvas.height = CANVAS_HEIGHT;
                document.getElementById('renderProgressContainer').classList.add('hidden');
                document.getElementById('renderModal').classList.remove('hidden');
                toggleCinemaMode();
            };

            // SYNC START
            recorder.start();
            ttsSource.start(0);
            if(musicSource) musicSource.start(0);
            
            if(document.getElementById('bgMode').value === 'upload') {
                sourceVideo.currentTime = 0;
                sourceVideo.play();
            }

            // Duration check
            const duration = ttsPlayer.duration * 1000;
            const startTime = performance.now();

            function renderLoop() {
                if(!isRendering) return;
                drawFrame();
                if (performance.now() - startTime > duration + 1000) { // +1s buffer
                    recorder.stop();
                    ttsSource.stop();
                    if(musicSource) musicSource.stop();
                    sourceVideo.pause();
                } else {
                    requestAnimationFrame(renderLoop);
                }
            }
            renderLoop();
        }

        // --- PLAYBACK ---
        function togglePlayback() {
            if (isPlaying) {
                ttsPlayer.pause();
                musicPlayer.pause();
                sourceVideo.pause();
                isPlaying = false;
                cancelAnimationFrame(animationId);
                
                document.getElementById('playBtn').innerHTML = '<i data-lucide="play" class="w-4 h-4"></i> PREVIEW';
                document.getElementById('playBtn').classList.replace('bg-red-50', 'bg-gray-100');
                document.getElementById('playBtn').classList.replace('text-red-600', 'text-gray-400');
            } else {
                if (!audioBlob) return showToast("Generate audio first!", "error");
                
                // Ducking Listener
                ttsPlayer.onplay = () => { musicPlayer.volume = document.getElementById('musicVolSlider').value * 0.3; };
                ttsPlayer.onended = () => { 
                    musicPlayer.volume = document.getElementById('musicVolSlider').value; 
                    togglePlayback(); 
                };

                ttsPlayer.playbackRate = document.getElementById('speedSlider').value;
                musicPlayer.volume = document.getElementById('musicVolSlider').value;

                ttsPlayer.play();
                if(musicPlayer.src) musicPlayer.play();
                if(document.getElementById('bgMode').value === 'upload') sourceVideo.play();

                isPlaying = true;
                document.getElementById('playBtn').innerHTML = '<i data-lucide="square" class="w-4 h-4"></i> STOP';
                document.getElementById('playBtn').classList.replace('bg-gray-100', 'bg-red-50');
                document.getElementById('playBtn').classList.replace('text-gray-400', 'text-red-600');
                
                animate();
            }
            lucide.createIcons();
        }

        function animate() {
            if(isPlaying) {
                drawFrame();
                animationId = requestAnimationFrame(animate);
            }
        }

        // --- GENERATION API ---
        async function generateScript() {
            const key = getEffectiveKey();
            if(!key) return showToast("API Key Required", "error");
            
            const btn = document.getElementById('scriptBtn');
            btn.innerHTML = '...'; btn.disabled = true;

            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: 
                        `Write a viral ${document.getElementById('topicInput').value} script. 
                        Format: Pure text (no bold/markdown). 
                        Style: First-person Reddit story. 
                        Length: 130 words.` 
                    }] }] })
                });
                const d = await res.json();
                if(d.error) throw new Error(d.error.message);
                document.getElementById('scriptText').value = d.candidates[0].content.parts[0].text;
                updateStats();
                consumeTrial();
                showToast("Script Generated");
            } catch(e) {
                console.error(e);
                showToast("Script Error: " + e.message, "error");
            }
            btn.innerHTML = 'Generate'; btn.disabled = false;
        }

        async function generateAudio() {
            const key = getEffectiveKey();
            const text = document.getElementById('scriptText').value;
            if(!key || !text) return showToast("Missing inputs", "error");

            const btn = document.getElementById('audioBtn');
            btn.innerHTML = 'Generating...'; btn.disabled = true;

            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${key}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: text }] }],
                        generationConfig: {
                            responseModalities: ["AUDIO"],
                            speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: selectedVoice } } }
                        }
                    })
                });
                const d = await res.json();
                if(d.error) throw new Error(d.error.message);

                const bin = atob(d.candidates[0].content.parts[0].inlineData.data);
                const bytes = new Uint8Array(bin.length);
                for(let i=0; i<bin.length; i++) bytes[i] = bin.charCodeAt(i);
                
                // WAV Header
                const wav = new ArrayBuffer(44 + bytes.length);
                const v = new DataView(wav);
                const w = (o, s) => { for(let i=0; i<s.length; i++) v.setUint8(o+i, s.charCodeAt(i)); };
                w(0,'RIFF'); v.setUint32(4, 36+bytes.length, true); w(8,'WAVE'); w(12,'fmt '); 
                v.setUint32(16, 16, true); v.setUint16(20, 1, true); v.setUint16(22, 1, true); 
                v.setUint32(24, 24000, true); v.setUint32(28, 48000, true); v.setUint16(32, 2, true); 
                v.setUint16(34, 16, true); w(36,'data'); v.setUint32(40, bytes.length, true);
                new Uint8Array(wav, 44).set(bytes);

                audioBlob = new Blob([wav], { type: 'audio/wav' });
                ttsPlayer.src = URL.createObjectURL(audioBlob);

                // Sync Analysis
                const words = text.replace(/\n/g, " ").split(" ").filter(w => w.length > 0);
                let total = 0;
                const weighted = words.map(w => {
                    let v = w.length;
                    if(w.includes('.')) v+=8; else if(w.includes(',')) v+=4;
                    total += v;
                    return { w, v };
                });
                let acc = 0;
                wordMeta = weighted.map(i => { acc += i.v; return { word: i.w, endPerc: acc/total }; });

                consumeTrial();
                showToast("Audio Ready");
                
                // Enable UI
                document.getElementById('playBtn').disabled = false;
                document.getElementById('playBtn').classList.replace('bg-gray-100', 'bg-gray-900');
                document.getElementById('playBtn').classList.replace('text-gray-400', 'text-white');
                document.getElementById('playBtn').classList.replace('cursor-not-allowed', 'cursor-pointer');
                
                document.getElementById('renderBtn').disabled = false;
                document.getElementById('renderBtn').classList.replace('bg-gray-100', 'bg-gray-900');
                document.getElementById('renderBtn').classList.replace('text-gray-400', 'text-white');
                document.getElementById('renderBtn').classList.replace('cursor-not-allowed', 'cursor-pointer');

            } catch(e) {
                console.error(e);
                showToast("Audio Error: " + e.message, "error");
            }
            btn.innerHTML = '<i data-lucide="wand-2" class="w-3.5 h-3.5"></i> Synthesize Speech';
            btn.disabled = false;
            lucide.createIcons();
        }

        // --- UTILS ---
        function showToast(msg, type='success') {
            const el = document.createElement('div');
            el.className = `px-4 py-2 rounded-full text-xs font-bold shadow-lg flex items-center gap-2 transform transition-all translate-y-2 opacity-0 ${type==='error'?'bg-red-600 text-white':'bg-gray-900 text-white'}`;
            el.innerHTML = type==='error' ? `<i data-lucide="alert-circle" class="w-3 h-3"></i> ${msg}` : `<i data-lucide="check" class="w-3 h-3 text-green-400"></i> ${msg}`;
            document.getElementById('toastContainer').appendChild(el);
            lucide.createIcons();
            requestAnimationFrame(() => el.classList.remove('translate-y-2', 'opacity-0'));
            setTimeout(() => el.remove(), 3000);
        }

        let selectedVoice = "Puck";
        function selectVoice(v) {
            selectedVoice = v;
            document.querySelectorAll('.voice-btn').forEach(b => {
                b.className = "voice-btn relative bg-white text-gray-600 border border-gray-200 hover:border-gray-300 rounded-xl py-2.5 text-xs font-bold transition-all";
                if(b.querySelector('div')) b.querySelector('div').remove();
            });
            const active = document.getElementById(`voice-${v}`);
            active.className = "voice-btn relative bg-gray-900 text-white border border-transparent rounded-xl py-2.5 text-xs font-bold shadow-md transition-all";
            active.innerHTML += `<div class="absolute top-1 right-1 w-1.5 h-1.5 bg-green-400 rounded-full"></div>`;
        }

        function toggleBgMode() {
            const mode = document.getElementById('bgMode').value;
            if(mode !== 'upload' && mode !== 'solid') init3D();
            if(mode === 'upload') document.getElementById('videoUploadContainer').classList.remove('hidden');
            else document.getElementById('videoUploadContainer').classList.add('hidden');
            redrawCanvas();
        }

        function toggleCinemaMode() {
            const overlay = document.getElementById('cinemaOverlay');
            if(overlay.classList.contains('hidden')) {
                overlay.classList.remove('hidden');
                setTimeout(()=>overlay.classList.remove('opacity-0'), 10);
                document.getElementById('renderModal').classList.remove('scale-95');
            } else {
                overlay.classList.add('opacity-0');
                document.getElementById('renderModal').classList.add('scale-95');
                setTimeout(()=>overlay.classList.add('hidden'), 300);
            }
        }

        function setFps(v) {
            renderFps = v;
            document.getElementById('fps30').className = v === 30 ? "flex-1 py-2 rounded-lg bg-gray-900 text-white text-xs font-bold shadow-sm transition-all" : "flex-1 py-2 rounded-lg text-gray-500 text-xs font-bold hover:text-gray-900 transition-all";
            document.getElementById('fps60').className = v === 60 ? "flex-1 py-2 rounded-lg bg-gray-900 text-white text-xs font-bold shadow-sm transition-all" : "flex-1 py-2 rounded-lg text-gray-500 text-xs font-bold hover:text-gray-900 transition-all";
        }

        function updateStats() {
            const w = document.getElementById('scriptText').value.split(/\s+/).length;
            document.getElementById('scriptStats').innerText = `${w}w | ~${Math.round(w/2.5)}s`;
        }

        function saveKey() {
            // Hide trial banner if user enters a key manually
            if(document.getElementById('apiKey').value.length > 10) {
                 document.getElementById('trialBanner').classList.add('hidden');
            }
            localStorage.setItem('viralgen_key', document.getElementById('apiKey').value);
            document.getElementById('keyStatus').classList.remove('hidden');
        }
        function loadKey() {
            const k = localStorage.getItem('viralgen_key');
            if(k) { document.getElementById('apiKey').value = k; document.getElementById('keyStatus').classList.remove('hidden'); }
        }
        function resetApp() { if(confirm("Reset everything?")) { localStorage.clear(); location.reload(); } }
        function randomTopic() { document.getElementById('topicInput').value = ["Horror Story", "Karen", "Revenge", "Bad Date"][Math.floor(Math.random()*4)]; }
        function cleanScript() { document.getElementById('scriptText').value = document.getElementById('scriptText').value.replace(/[*_#]/g, ''); }
        function updateMixer() { musicPlayer.volume = document.getElementById('musicVolSlider').value; }
        
        // Handlers
        function handleVideoUpload(f) { if(f) { sourceVideo.src = URL.createObjectURL(f); document.getElementById('bgMode').value = 'upload'; toggleBgMode(); } }
        function handleMusicUpload(i) { if(i.files[0]) { document.getElementById('musicName').innerText = i.files[0].name.slice(0,10)+'...'; musicPlayer.src = URL.createObjectURL(i.files[0]); } }
        function handleDragOver(e) { e.preventDefault(); e.currentTarget.classList.add('border-blue-400','bg-blue-50'); }
        function handleDragLeave(e) { e.preventDefault(); e.currentTarget.classList.remove('border-blue-400','bg-blue-50'); }
        function handleDrop(e) { e.preventDefault(); e.currentTarget.classList.remove('border-blue-400','bg-blue-50'); if(e.dataTransfer.files[0]) handleVideoUpload(e.dataTransfer.files[0]); }

        // 3D Placeholder
        function init3D() {
            if(renderer) return;
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, 1080/1920, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ alpha: true });
            renderer.setSize(1080, 1920);
            const g = new THREE.BoxGeometry(1,1,1);
            const m = new THREE.MeshBasicMaterial({ color: 0x4f46e5, wireframe: true });
            meshGroup = new THREE.Group();
            for(let i=0; i<80; i++) { const mesh = new THREE.Mesh(g, m); mesh.position.z = -i; mesh.rotation.z = i*0.1; meshGroup.add(mesh); }
            scene.add(meshGroup);
            camera.position.z = 2;
        }
        function animate3D() {
            if(meshGroup) { meshGroup.rotation.z += 0.005; camera.position.z -= 0.05; if(camera.position.z < -20) camera.position.z = 2; renderer.render(scene, camera); }
        }

    </script>
</body>
</html>
