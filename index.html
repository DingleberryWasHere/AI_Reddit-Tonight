<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dingle AI | Light</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Montserrat:wght@800;900&family=Bangers&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f9fafb; color: #111827; overflow: hidden; }
        
        /* Custom Scrollbar (Light Mode) */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #9ca3af; }

        /* Ranges */
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%;
            background: #000; margin-top: -6px; cursor: pointer;
            box-shadow: 0 0 0 2px #fff, 0 2px 4px rgba(0,0,0,0.1);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; cursor: pointer; background: #e5e7eb; border-radius: 2px;
        }

        /* Canvas Container */
        .canvas-container {
            height: 85vh;
            aspect-ratio: 9/16;
            max-width: 100%;
            position: relative;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            border: 4px solid #fff;
        }

        .sr-only-input { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); border: 0; }
        
        /* Loaders */
        .loader {
            border: 2px solid rgba(0,0,0,0.1);
            border-radius: 50%;
            border-top: 2px solid #000;
            width: 16px;
            height: 16px;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="h-screen w-screen flex flex-col md:flex-row" ondragover="event.preventDefault()" ondrop="event.preventDefault()">

    <div class="w-full md:w-[420px] flex flex-col border-r border-gray-200 bg-white z-30 shrink-0 h-full shadow-sm">
        
        <div class="px-6 py-5 border-b border-gray-100 flex justify-between items-center sticky top-0 bg-white z-40">
            <h1 class="text-xl font-bold tracking-tight text-gray-900 flex items-center gap-2">
                <div class="bg-black text-white p-1.5 rounded-lg"><i data-lucide="zap" class="w-4 h-4"></i></div>
                Dingle<span class="text-gray-400">AI</span>
            </h1>
            <button onclick="resetApp()" class="p-2 hover:bg-gray-100 rounded-lg text-gray-400 hover:text-red-500 transition-colors" title="Reset">
                <i data-lucide="rotate-ccw" class="w-4 h-4"></i>
            </button>
        </div>

        <div class="flex-1 overflow-y-auto p-6 space-y-8">

            <div class="space-y-3">
                <div class="flex justify-between items-center">
                    <label class="text-[11px] font-bold text-gray-400 uppercase tracking-widest">Access Key</label>
                    <span id="keyStatus" class="hidden text-[10px] font-bold text-emerald-600 bg-emerald-50 px-2 py-1 rounded-full border border-emerald-100">Connected</span>
                </div>
                <div class="relative group">
                    <input id="apiKey" type="password" oninput="saveKey()" class="w-full bg-gray-50 border border-gray-200 text-gray-800 text-xs rounded-xl px-4 py-3 focus:bg-white focus:border-black focus:ring-1 focus:ring-black outline-none transition-all font-mono shadow-sm" placeholder="Paste Gemini API Key">
                </div>
            </div>

            <section class="space-y-4">
                <div class="flex items-center justify-between">
                    <h2 class="text-xs font-bold text-gray-900 flex items-center gap-2">
                        <span class="w-6 h-6 rounded-lg bg-gray-100 flex items-center justify-center text-gray-500 font-bold border border-gray-200">1</span>
                        THE SCRIPT
                    </h2>
                    <button onclick="cleanScript()" class="text-xs font-medium text-gray-400 hover:text-black transition-colors">Clean Text</button>
                </div>
                
                <div class="grid grid-cols-2 gap-3">
                     <button onclick="fetchReddit()" id="redditBtn" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2.5 rounded-xl font-bold text-xs transition-all shadow-sm flex items-center justify-center gap-2 active:scale-95">
                        <i data-lucide="flame" class="w-4 h-4"></i> Fetch Viral
                     </button>
                     <button onclick="generateScript()" id="scriptBtn" class="bg-black hover:bg-gray-800 text-white px-4 py-2.5 rounded-xl font-bold text-xs transition-all shadow-sm flex items-center justify-center gap-2 active:scale-95">
                        <i data-lucide="sparkles" class="w-4 h-4 text-yellow-400"></i> AI Gen
                     </button>
                </div>
                <input id="topicInput" type="text" value="r/confessions" class="w-full bg-white border border-gray-200 rounded-xl px-4 py-2.5 text-xs text-gray-900 focus:border-black focus:ring-1 focus:ring-black outline-none transition-all shadow-sm" placeholder="Topic or Subreddit...">

                <div class="relative">
                    <textarea id="scriptText" oninput="updateStats()" rows="6" class="w-full bg-white border border-gray-200 rounded-xl p-4 text-xs focus:border-black outline-none text-gray-700 resize-none leading-relaxed shadow-sm transition-all" placeholder="Your script will appear here..."></textarea>
                    <div id="scriptStats" class="absolute bottom-3 right-3 text-[10px] text-gray-400 font-mono bg-gray-50 px-2 py-1 rounded border border-gray-100">0w | 0s</div>
                </div>
            </section>

            <section class="space-y-4">
                <h2 class="text-xs font-bold text-gray-900 flex items-center gap-2">
                    <span class="w-6 h-6 rounded-lg bg-gray-100 flex items-center justify-center text-gray-500 font-bold border border-gray-200">2</span>
                    THE VOICE
                </h2>
                
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="selectVoice('Puck')" id="voice-Puck" class="voice-btn relative bg-black text-white border border-transparent rounded-xl py-3 text-xs font-bold shadow-md transition-all">Puck <span class="opacity-60 font-normal ml-1">(M)</span></button>
                    <button onclick="selectVoice('Kore')" id="voice-Kore" class="voice-btn relative bg-white text-gray-500 border border-gray-200 hover:border-gray-400 rounded-xl py-3 text-xs font-bold transition-all">Kore <span class="opacity-60 font-normal ml-1">(F)</span></button>
                </div>

                <div class="bg-gray-50 border border-gray-200 rounded-xl p-4 space-y-4">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-3">
                             <button onclick="loadPresetAudio()" class="w-8 h-8 rounded-lg bg-emerald-500 hover:bg-emerald-600 text-white flex items-center justify-center transition-all shadow-sm active:scale-95" title="Load 'Relaxed' Preset">
                                <i data-lucide="music" class="w-4 h-4"></i>
                             </button>
                             <label class="w-8 h-8 rounded-lg bg-white border border-gray-200 flex items-center justify-center hover:border-black text-gray-400 hover:text-black transition-all cursor-pointer shadow-sm" title="Upload Custom">
                                <i data-lucide="upload" class="w-4 h-4"></i>
                                <input type="file" id="bgMusicInput" accept="audio/*" class="sr-only-input" onchange="handleMusicUpload(this)">
                             </label>
                             <div class="flex flex-col">
                                <span class="text-[10px] font-bold text-gray-900">Background Audio</span>
                                <span id="musicName" class="text-[10px] text-gray-400 truncate w-24">None selected</span>
                             </div>
                        </div>
                        
                        <div class="flex items-center gap-2 bg-white px-2 py-1 rounded-lg border border-gray-200">
                            <i data-lucide="volume-2" class="w-3 h-3 text-gray-400"></i>
                            <input type="range" id="musicVolSlider" min="0" max="0.4" step="0.01" value="0.1" class="w-16" oninput="updateMixer()">
                        </div>
                    </div>
                </div>

                <button onclick="generateAudio()" id="audioBtn" class="w-full bg-white border-2 border-gray-100 hover:border-black text-gray-900 py-3 rounded-xl font-bold text-xs transition-all flex justify-center items-center gap-2 active:scale-95">
                    <i data-lucide="mic" class="w-4 h-4 text-black"></i> Synthesize Speech
                </button>
            </section>

            <section class="space-y-4">
                <h2 class="text-xs font-bold text-gray-900 flex items-center gap-2">
                    <span class="w-6 h-6 rounded-lg bg-gray-100 flex items-center justify-center text-gray-500 font-bold border border-gray-200">3</span>
                    THE LOOK
                </h2>

                <div class="space-y-3">
                    <select id="bgMode" onchange="toggleBgMode()" class="w-full bg-white border border-gray-200 text-gray-900 text-xs font-medium rounded-xl px-3 py-3 outline-none focus:border-black shadow-sm cursor-pointer appearance-none">
                        <option value="minecraft">Gameplay: Minecraft Parkour</option>
                        <option value="upload">Upload Custom Video</option>
                        <option value="solid">Solid Color (Black)</option>
                    </select>
                    
                    <div id="videoUploadContainer" class="hidden border-2 border-dashed border-gray-300 rounded-xl p-6 text-center hover:bg-gray-50 hover:border-black transition-all cursor-pointer group" onclick="document.getElementById('bgVideoInput').click()">
                         <input type="file" id="bgVideoInput" accept="video/*" class="sr-only-input" onchange="handleVideoUpload(this.files[0])">
                         <div class="flex flex-col items-center gap-2">
                             <div class="p-2 bg-gray-100 rounded-full group-hover:bg-white"><i data-lucide="film" class="w-4 h-4 text-gray-500 group-hover:text-black"></i></div>
                             <span class="text-[11px] text-gray-500 font-medium">Select .MP4 file</span>
                         </div>
                    </div>
                </div>

                <div class="bg-gray-50 border border-gray-200 rounded-xl p-5 grid grid-cols-2 gap-x-4 gap-y-5">
                    <div class="col-span-2">
                        <label class="text-[10px] font-bold text-gray-400 uppercase mb-2 block">Font Style</label>
                        <select id="fontSelect" onchange="redrawCanvas()" class="w-full bg-white border border-gray-200 rounded-lg text-xs py-2 px-3 text-gray-900 focus:border-black shadow-sm outline-none">
                            <option value="Montserrat">Montserrat (Viral)</option>
                            <option value="Bangers">Bangers (Comic)</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="text-[10px] font-bold text-gray-400 uppercase mb-2 block">Size</label>
                        <input type="range" id="textSizeSlider" min="40" max="120" value="75" class="w-full" oninput="redrawCanvas()">
                    </div>
                    <div>
                         <label class="text-[10px] font-bold text-gray-400 uppercase mb-2 block">Y Position</label>
                         <input type="range" id="textPosSlider" min="-400" max="400" value="0" class="w-full" oninput="redrawCanvas()">
                    </div>

                    <div class="col-span-2 flex justify-between items-center pt-3 border-t border-gray-200">
                        <span class="text-[11px] font-medium text-gray-500">Highlight Colors</span>
                        <div class="flex gap-3">
                            <input type="color" id="textColor" value="#ffffff" class="w-6 h-6 rounded-full cursor-pointer border-2 border-gray-200 p-0 overflow-hidden" oninput="redrawCanvas()">
                            <input type="color" id="highlightColor" value="#fbbf24" class="w-6 h-6 rounded-full cursor-pointer border-2 border-gray-200 p-0 overflow-hidden" oninput="redrawCanvas()">
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <div class="p-5 border-t border-gray-200 bg-white space-y-4 z-40">
            <div class="grid grid-cols-2 gap-3">
                <button onclick="togglePlayback()" id="playBtn" disabled class="bg-gray-100 text-gray-400 cursor-not-allowed py-3.5 rounded-xl font-bold text-xs transition-all flex items-center justify-center gap-2 hover:bg-gray-200">
                    <i data-lucide="play" class="w-4 h-4"></i> PREVIEW
                </button>
                <button onclick="toggleCinemaMode()" id="renderBtn" disabled class="bg-gray-100 text-gray-400 cursor-not-allowed py-3.5 rounded-xl font-bold text-xs transition-all flex items-center justify-center gap-2 hover:bg-gray-200">
                    <i data-lucide="download" class="w-4 h-4"></i> EXPORT
                </button>
            </div>
            <div id="statusText" class="text-[10px] text-center text-gray-400 font-medium flex items-center justify-center gap-1.5">
                <span class="w-1.5 h-1.5 rounded-full bg-emerald-500"></span> System Ready
            </div>
        </div>
    </div>

    <div class="flex-1 bg-gray-50 relative flex justify-center items-center p-6 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]">
        
        <div id="toastContainer" class="fixed top-5 right-5 z-[100] flex flex-col gap-2 pointer-events-none"></div>

        <div class="canvas-container" id="canvasWrapper">
            <canvas id="mainCanvas" class="w-full h-full object-contain block bg-black"></canvas>
            
            <video id="sourceVideo" class="absolute top-0 left-0 w-px h-px opacity-0 pointer-events-none" loop muted playsinline crossorigin="anonymous"></video>
            
            <div id="playOverlay" onclick="togglePlayback()" class="absolute inset-0 z-10 cursor-pointer flex items-center justify-center bg-black/20 opacity-0 hover:opacity-100 transition-opacity">
                <div class="bg-white/20 backdrop-blur-md p-6 rounded-full border border-white/40 shadow-xl transform hover:scale-110 transition-transform">
                    <i data-lucide="play" class="w-10 h-10 text-white fill-white"></i>
                </div>
            </div>

            <div id="cinemaOverlay" class="absolute inset-0 bg-white/90 backdrop-blur-md z-50 flex flex-col items-center justify-center hidden">
                <div class="bg-white p-8 rounded-2xl shadow-2xl text-center space-y-6 w-[85%] max-w-[320px] border border-gray-100" id="renderModal">
                    <div>
                        <h2 class="text-xl font-black text-gray-900">RENDER VIDEO</h2>
                        <p class="text-xs text-gray-500 mt-1">Prepare for export</p>
                    </div>
                    <div class="space-y-3 text-left">
                        <div class="space-y-1.5">
                            <label class="text-[10px] font-bold text-gray-400 uppercase">Resolution</label>
                            <select id="renderRes" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-2.5 text-xs text-gray-900 outline-none focus:border-black">
                                <option value="1080">1080p (FHD)</option>
                                <option value="2160">4K (UHD)</option>
                            </select>
                        </div>
                    </div>
                    <button onclick="startRendering()" class="w-full bg-black hover:bg-gray-800 text-white py-3.5 rounded-xl font-bold text-xs shadow-lg transition-all flex items-center justify-center gap-2">
                        <i data-lucide="film" class="w-4 h-4"></i> START CAPTURE
                    </button>
                    <button onclick="toggleCinemaMode()" class="text-xs text-gray-400 hover:text-gray-900 font-medium">Cancel</button>
                </div>
                
                <div id="renderProgressContainer" class="hidden flex flex-col items-center justify-center space-y-4 w-full px-8">
                    <div class="loader w-10 h-10 border-gray-300 border-t-black"></div>
                    <div class="text-center">
                        <h3 class="font-bold text-gray-900 text-lg">RENDERING...</h3>
                        <p class="text-xs text-gray-500 mt-1">Don't close this tab.</p>
                        <p id="renderTime" class="text-[10px] text-gray-400 font-mono mt-2">0.0s</p>
                    </div>
                </div>
            </div>
        </div>
        
        <audio id="ttsPlayer" class="hidden" crossorigin="anonymous"></audio>
        <audio id="musicPlayer" class="hidden" loop crossorigin="anonymous"></audio>
    </div>

    <script>
        // --- CONFIG & STATE ---
        const CANVAS_WIDTH = 1080;
        const CANVAS_HEIGHT = 1920;
        let selectedVoice = 'Puck';
        let renderFps = 30;
        let audioBlob = null;
        let wordMeta = [];
        let isPlaying = false;
        let isRendering = false;
        let animationId;
        let audioCtx; 

        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d', { alpha: false });
        const ttsPlayer = document.getElementById('ttsPlayer');
        const musicPlayer = document.getElementById('musicPlayer');
        const sourceVideo = document.getElementById('sourceVideo');

        // --- INIT ---
        window.onload = () => {
            lucide.createIcons();
            initCanvas();
            loadKey();
            // Load default minecraft if available
            document.getElementById('bgMode').value = 'minecraft';
            toggleBgMode();
        };

        function initCanvas() {
            canvas.width = CANVAS_WIDTH;
            canvas.height = CANVAS_HEIGHT;
            ctx.fillStyle = '#000';
            ctx.fillRect(0,0,CANVAS_WIDTH, CANVAS_HEIGHT);
            drawCaption("READY"); 
        }

        // --- DRAWING LOOP ---
        function drawFrame() {
            const mode = document.getElementById('bgMode').value;
            
            // 1. Draw Background
            if (mode === 'upload' || mode === 'minecraft') {
                if (sourceVideo.readyState >= 2) {
                    const rV = sourceVideo.videoWidth / sourceVideo.videoHeight;
                    const rC = canvas.width / canvas.height;
                    let dW, dH, dX, dY;
                    if (rV > rC) { dH = canvas.height; dW = dH * rV; dX = (canvas.width - dW) / 2; dY = 0; }
                    else { dW = canvas.width; dH = dW / rV; dX = 0; dY = (canvas.height - dH) / 2; }
                    ctx.drawImage(sourceVideo, dX, dY, dW, dH);
                }
            } else if (mode === 'solid') {
                ctx.fillStyle = '#000'; ctx.fillRect(0, 0, canvas.width, canvas.height);
            }

            // 2. Dark Overlay
            ctx.fillStyle = 'rgba(0,0,0,0.5)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // 3. Draw Text
            if ((isPlaying || isRendering) && !ttsPlayer.paused) {
                const currentTime = ttsPlayer.currentTime;
                const activeWord = wordMeta.find(w => currentTime >= w.start && currentTime <= w.end);
                
                if (activeWord) drawCaption(activeWord.word);
                else {
                     const lastWord = wordMeta[wordMeta.length - 1];
                     if(currentTime > lastWord?.end) drawCaption(""); 
                     else if (wordMeta.length > 0 && currentTime < wordMeta[0].start) drawCaption(wordMeta[0].word);
                }

                // Progress Bar (Minimal)
                const prog = currentTime / ttsPlayer.duration;
                ctx.fillStyle = '#fbbf24'; 
                ctx.fillRect(0, canvas.height - 10, canvas.width * prog, 10);
            } else if (!isPlaying && !isRendering) {
                drawCaption("PREVIEW");
            }
        }

        function drawCaption(text) {
            if(!text) return;
            const size = parseInt(document.getElementById('textSizeSlider').value);
            const yOff = parseInt(document.getElementById('textPosSlider').value);
            const font = document.getElementById('fontSelect').value;
            const colMain = document.getElementById('textColor').value;
            const colHigh = document.getElementById('highlightColor').value;
            
            const clean = text.replace(/[^a-zA-Z0-9]/g, "").toUpperCase();
            const isHigh = ['WHAT','WHY','NO','STOP','DIED','KILLED','SECRET','MONEY','WTF','OMG', 'SCARY', 'CHEATING', 'PREGNANT', 'ILLEGAL'].includes(clean) || clean.length > 8;
            
            const scale = canvas.width / 1080;
            const finalSize = scale * (isHigh ? size * 1.3 : size * 2.2);
            
            ctx.font = `900 ${finalSize}px "${font}", sans-serif`;
            ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            
            const x = canvas.width / 2;
            const y = (canvas.height / 2) + (yOff * scale);
            
            ctx.lineJoin = 'round'; ctx.miterLimit = 2; ctx.lineWidth = finalSize * 0.15; ctx.strokeStyle = 'black'; 
            ctx.strokeText(text.toUpperCase(), x, y);
            ctx.fillStyle = isHigh ? colHigh : colMain; 
            ctx.fillText(text.toUpperCase(), x, y);
        }

        function redrawCanvas() { if(!isPlaying) requestAnimationFrame(drawFrame); }

        // --- PLAYBACK ---
        function togglePlayback() { isPlaying ? stopPlayback() : startPlayback(); }

        function startPlayback() {
            if (!audioBlob) return showToast("Generate audio first!", "error");
            ttsPlayer.volume = 1.0;
            ttsPlayer.onplay = () => { musicPlayer.volume = document.getElementById('musicVolSlider').value * 0.2; };
            ttsPlayer.onended = () => { musicPlayer.volume = document.getElementById('musicVolSlider').value; stopPlayback(); };
            musicPlayer.volume = document.getElementById('musicVolSlider').value;
            ttsPlayer.play();
            if(musicPlayer.src) musicPlayer.play();
            if(['upload','minecraft'].includes(document.getElementById('bgMode').value)) sourceVideo.play();
            isPlaying = true;
            updateUIState(true);
            animate();
        }

        function stopPlayback() {
            ttsPlayer.pause(); ttsPlayer.currentTime = 0;
            musicPlayer.pause();
            if(['upload','minecraft'].includes(document.getElementById('bgMode').value)) sourceVideo.pause();
            isPlaying = false;
            cancelAnimationFrame(animationId);
            updateUIState(false);
            redrawCanvas();
        }

        function updateUIState(playing) {
            const btn = document.getElementById('playBtn');
            btn.innerHTML = playing ? '<i data-lucide="square" class="w-4 h-4"></i> STOP' : '<i data-lucide="play" class="w-4 h-4"></i> PREVIEW';
            btn.className = playing ? "bg-red-500 hover:bg-red-600 text-white py-3.5 rounded-xl font-bold text-xs transition-all flex items-center justify-center gap-2" : "bg-black hover:bg-gray-800 text-white py-3.5 rounded-xl font-bold text-xs transition-all flex items-center justify-center gap-2";
            lucide.createIcons();
        }

        function animate() { if(isPlaying) { drawFrame(); animationId = requestAnimationFrame(animate); } }

        // --- FETCH REDDIT (VIRAL) ---
        async function fetchReddit() {
            const btn = document.getElementById('redditBtn');
            const originalHtml = btn.innerHTML;
            btn.innerHTML = '<div class="loader"></div>'; btn.disabled = true;

            const subs = ['confessions', 'tifu', 'AmItheAsshole', 'entitledparents'];
            const sub = subs[Math.floor(Math.random() * subs.length)];
            
            try {
                const res = await fetch(`https://www.reddit.com/r/${sub}/top.json?limit=25&t=day`);
                const data = await res.json();
                const posts = data.data.children.filter(p => p.data.selftext.length > 50 && p.data.selftext.length < 1500);
                if(posts.length === 0) throw new Error("No good posts.");
                
                const post = posts[Math.floor(Math.random() * posts.length)].data;
                let text = post.selftext.replace(/Edit:?.*$/si, '').trim().replace(/\(.*\)/g, '').replace(/\[.*\]/g, ''); 
                if(text.length > 600) text = text.substring(0, 600) + "...";

                document.getElementById('topicInput').value = `r/${sub}: ${post.title}`;
                document.getElementById('scriptText').value = `${post.title}. ${text}`;
                updateStats();
                showToast(`Fetched from r/${sub}!`);
            } catch(e) {
                showToast("Failed to fetch Reddit.", "error");
            }
            btn.innerHTML = originalHtml; btn.disabled = false;
        }

        // --- EXPORT ---
        function ensureAudioContext() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();
            return audioCtx;
        }

        async function startRendering() {
            if (!audioBlob) return showToast("No audio to render", "error");
            isRendering = true;
            document.getElementById('renderModal').classList.add('hidden');
            document.getElementById('renderProgressContainer').classList.remove('hidden');

            const res = parseInt(document.getElementById('renderRes').value);
            canvas.width = res; canvas.height = res * (16/9);
            
            const ctxTarget = ensureAudioContext();
            const dest = ctxTarget.createMediaStreamDestination();
            
            const audioBuffer = await fetch(ttsPlayer.src).then(r=>r.arrayBuffer()).then(b=>ctxTarget.decodeAudioData(b));
            const ttsSource = ctxTarget.createBufferSource();
            ttsSource.buffer = audioBuffer; ttsSource.connect(dest);
            
            let musicSource;
            if(musicPlayer.src) {
                const mBuf = await fetch(musicPlayer.src).then(r=>r.arrayBuffer()).then(b=>ctxTarget.decodeAudioData(b));
                musicSource = ctxTarget.createBufferSource();
                musicSource.buffer = mBuf; musicSource.loop = true;
                const gain = ctxTarget.createGain();
                gain.gain.value = document.getElementById('musicVolSlider').value * 0.2;
                musicSource.connect(gain).connect(dest);
            }

            const stream = canvas.captureStream(renderFps);
            const combinedStream = new MediaStream([...stream.getVideoTracks(), ...dest.stream.getAudioTracks()]);
            const recorder = new MediaRecorder(combinedStream, { mimeType: 'video/webm; codecs=vp9', videoBitsPerSecond: 8000000 });
            const chunks = [];
            recorder.ondataavailable = e => { if (e.data.size > 0) chunks.push(e.data); };
            
            recorder.onstop = () => {
                const b = new Blob(chunks, { type: 'video/webm' });
                const url = URL.createObjectURL(b);
                const a = document.createElement('a');
                a.href = url; a.download = `Dingle_Light_${Date.now()}.webm`;
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
                
                isRendering = false;
                canvas.width = CANVAS_WIDTH; canvas.height = CANVAS_HEIGHT;
                document.getElementById('renderProgressContainer').classList.add('hidden');
                document.getElementById('renderModal').classList.remove('hidden');
                toggleCinemaMode();
                showToast("Export Successful!");
            };

            recorder.start(); ttsSource.start(0); if(musicSource) musicSource.start(0);
            if(['upload','minecraft'].includes(document.getElementById('bgMode').value)) { sourceVideo.currentTime = 0; sourceVideo.play(); }

            const duration = ttsPlayer.duration * 1000;
            const startTime = performance.now();
            
            function renderLoop() {
                if(!isRendering) return;
                drawFrame();
                const elapsed = performance.now() - startTime;
                document.getElementById('renderTime').innerText = (elapsed / 1000).toFixed(1) + "s / " + (duration/1000).toFixed(1) + "s";
                if (elapsed > duration + 500) {
                    recorder.stop(); ttsSource.stop(); if(musicSource) musicSource.stop();
                    if(['upload','minecraft'].includes(document.getElementById('bgMode').value)) sourceVideo.pause();
                } else requestAnimationFrame(renderLoop);
            }
            renderLoop();
        }

        // --- ASSET HANDLERS ---
        async function generateScript() {
            const key = document.getElementById('apiKey').value;
            if(!key) return showToast("API Key Required", "error");
            const btn = document.getElementById('scriptBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<div class="loader"></div>'; btn.disabled = true;
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: `Write a viral short-form script about: ${document.getElementById('topicInput').value}. Style: First-person Reddit confession. Length: 120 words max. Hook the first sentence. No formatting.` }] }] })
                });
                const d = await res.json();
                document.getElementById('scriptText').value = d.candidates[0].content.parts[0].text;
                updateStats();
                showToast("Script Generated");
            } catch(e) { showToast("AI Error", "error"); }
            btn.innerHTML = originalText; btn.disabled = false;
        }

        async function generateAudio() {
            const key = document.getElementById('apiKey').value;
            const text = document.getElementById('scriptText').value;
            if(!key || !text) return showToast("API Key & Text required", "error");
            const btn = document.getElementById('audioBtn');
            const originalHtml = btn.innerHTML;
            btn.innerHTML = '<div class="loader"></div>'; btn.disabled = true;
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${key}`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: text }] }], generationConfig: { responseModalities: ["AUDIO"], speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: selectedVoice } } } } })
                });
                const d = await res.json();
                const bin = atob(d.candidates[0].content.parts[0].inlineData.data);
                const bytes = new Uint8Array(bin.length);
                for(let i=0; i<bin.length; i++) bytes[i] = bin.charCodeAt(i);
                
                const wav = createWav(bytes);
                audioBlob = new Blob([wav], { type: 'audio/wav' });
                ttsPlayer.src = URL.createObjectURL(audioBlob);
                
                ttsPlayer.onloadedmetadata = () => {
                    const totalDuration = ttsPlayer.duration;
                    const words = text.replace(/\s+/g, ' ').trim().split(' ');
                    let totalWeight = 0;
                    const wordWeights = words.map(w => {
                        let weight = w.length;
                        if(w.includes('.') || w.includes('?')) weight += 6;
                        else if(w.includes(',')) weight += 3;
                        totalWeight += weight;
                        return { word: w, weight: weight };
                    });
                    let currentTime = 0;
                    wordMeta = wordWeights.map(item => {
                        const duration = (item.weight / totalWeight) * totalDuration;
                        const meta = { word: item.word, start: currentTime, end: currentTime + duration };
                        currentTime += duration;
                        return meta;
                    });
                    showToast("Audio Ready"); enableControls();
                };
            } catch(e) { showToast(e.message, "error"); }
            btn.innerHTML = originalHtml; btn.disabled = false;
        }

        // --- UTILS ---
        function createWav(bytes) {
            const buffer = new ArrayBuffer(44 + bytes.length);
            const view = new DataView(buffer);
            const writeString = (view, offset, string) => { for (let i = 0; i < string.length; i++) view.setUint8(offset + i, string.charCodeAt(i)); };
            writeString(view, 0, 'RIFF'); view.setUint32(4, 36 + bytes.length, true); writeString(view, 8, 'WAVE'); writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true); view.setUint16(20, 1, true); view.setUint16(22, 1, true); view.setUint32(24, 24000, true);
            view.setUint32(28, 48000, true); view.setUint16(32, 2, true); view.setUint16(34, 16, true); writeString(view, 36, 'data');
            view.setUint32(40, bytes.length, true); new Uint8Array(buffer, 44).set(bytes);
            return buffer;
        }
        function enableControls() {
            ['playBtn','renderBtn'].forEach(id => {
                const b = document.getElementById(id); b.disabled = false; b.classList.replace('cursor-not-allowed', 'cursor-pointer'); b.classList.replace('text-gray-400', 'text-white'); b.classList.replace('bg-gray-100', 'bg-black');
            });
        }
        function showToast(msg, type='success') {
            const el = document.createElement('div');
            el.className = `px-4 py-3 rounded-lg text-xs font-bold shadow-lg flex items-center gap-2 transform transition-all translate-x-4 opacity-0 ${type==='error'?'bg-red-500 text-white':'bg-emerald-500 text-white'}`;
            el.innerHTML = `<i data-lucide="${type==='error'?'alert-circle':'check-circle'}" class="w-4 h-4"></i> ${msg}`;
            document.getElementById('toastContainer').appendChild(el); lucide.createIcons();
            requestAnimationFrame(() => el.classList.remove('translate-x-4', 'opacity-0'));
            setTimeout(() => { el.style.opacity = '0'; setTimeout(()=>el.remove(),300) }, 3000);
        }
        function selectVoice(v) {
            selectedVoice = v;
            document.querySelectorAll('.voice-btn').forEach(b => b.className = "voice-btn relative bg-white text-gray-500 border border-gray-200 hover:border-gray-400 rounded-xl py-3 text-xs font-bold transition-all");
            document.getElementById(`voice-${v}`).className = "voice-btn relative bg-black text-white border border-transparent rounded-xl py-3 text-xs font-bold shadow-md transition-all";
        }
        function updateStats() { document.getElementById('scriptStats').innerText = `${document.getElementById('scriptText').value.split(/\s+/).filter(x=>x).length}w`; }
        function saveKey() { localStorage.setItem('dingle_key', document.getElementById('apiKey').value); document.getElementById('keyStatus').classList.remove('hidden'); }
        function loadKey() { const k = localStorage.getItem('dingle_key'); if(k) { document.getElementById('apiKey').value = k; document.getElementById('keyStatus').classList.remove('hidden'); } }
        function resetApp() { if(confirm("Clear workspace?")) location.reload(); }
        function cleanScript() { const t = document.getElementById('scriptText'); t.value = t.value.replace(/[*#_`]/g, ''); }
        
        function handleMusicUpload(el) { if(el.files[0]){ document.getElementById('musicName').innerText = el.files[0].name; musicPlayer.src = URL.createObjectURL(el.files[0]); } }
        function loadPresetAudio() { musicPlayer.src = "relaxed.mp3"; document.getElementById('musicName').innerText = "Preset: Relaxed"; showToast("Preset Loaded"); }
        function updateMixer() { if(!isPlaying) musicPlayer.volume = document.getElementById('musicVolSlider').value; }
        
        function handleVideoUpload(f) { 
            if(f) { 
                sourceVideo.src = URL.createObjectURL(f); document.getElementById('bgMode').value = 'upload'; toggleBgMode(); 
            } 
        }
        function toggleBgMode() {
            const mode = document.getElementById('bgMode').value;
            const uploader = document.getElementById('videoUploadContainer');
            if(mode === 'minecraft') {
                sourceVideo.src = 'minecraft.mp4';
                sourceVideo.load();
                uploader.classList.add('hidden');
            } else if(mode === 'upload') {
                uploader.classList.remove('hidden');
            } else {
                uploader.classList.add('hidden');
            }
            redrawCanvas();
        }
        function toggleCinemaMode() { document.getElementById('cinemaOverlay').classList.toggle('hidden'); }
    </script>
</body>
</html>
