<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dingle AI | Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Montserrat:wght@700;800;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; color: #111827; overflow: hidden; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #9ca3af; }

        /* Sliders */
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%;
            background: #000; margin-top: -6px; cursor: pointer;
            box-shadow: 0 0 0 2px #fff, 0 2px 4px rgba(0,0,0,0.1);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; cursor: pointer; background: #e5e7eb; border-radius: 2px;
        }

        /* Canvas */
        .canvas-container {
            height: 90vh; aspect-ratio: 9/16; max-width: 100%; position: relative;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            background: #000; border-radius: 12px; overflow: hidden; border: 4px solid #fff;
        }
        .sr-only-input { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); border: 0; }
        .loader { border: 2px solid rgba(0,0,0,0.1); border-radius: 50%; border-top: 2px solid #000; width: 16px; height: 16px; animation: spin 0.8s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Tutorial Modal Transitions */
        .step-content { display: none; animation: fadeIn 0.3s ease-in-out; }
        .step-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="h-screen w-screen flex flex-col md:flex-row">

    <div class="w-full md:w-[420px] flex flex-col border-r border-gray-200 bg-white z-30 shrink-0 h-full shadow-sm">
        
        <div class="px-6 py-5 border-b border-gray-100 flex justify-between items-center bg-white">
            <h1 class="text-lg font-bold tracking-tight text-gray-900 flex items-center gap-2">
                <div class="bg-black text-white p-1.5 rounded-lg"><i data-lucide="zap" class="w-4 h-4"></i></div>
                Dingle<span class="text-gray-400">AI</span>
            </h1>
            <div class="flex gap-2">
                <button onclick="startTutorial()" class="w-6 h-6 flex items-center justify-center rounded-full bg-gray-100 text-gray-400 hover:bg-black hover:text-white transition-all" title="Help / Tutorial">
                    <i data-lucide="help-circle" class="w-3.5 h-3.5"></i>
                </button>
                <button onclick="saveSettings()" class="text-xs font-medium text-gray-400 hover:text-black transition-colors flex items-center gap-1">
                    <i data-lucide="save" class="w-3 h-3"></i> Save Key
                </button>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto p-6 space-y-6">

            <div class="space-y-3">
                <div class="flex justify-between items-center">
                    <label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Model & Key</label>
                    <span id="keyStatus" class="hidden text-[10px] font-bold text-emerald-600 bg-emerald-50 px-2 py-0.5 rounded-full">Saved</span>
                </div>
                <div class="space-y-2">
                    <input id="apiKey" type="password" oninput="saveSettings()" class="w-full bg-gray-50 border border-gray-200 text-gray-800 text-xs rounded-xl px-4 py-3 focus:bg-white focus:border-black outline-none transition-all shadow-sm font-mono" placeholder="Paste Gemini API Key">
                    <select id="modelSelect" onchange="saveSettings()" class="w-full bg-white border border-gray-200 text-gray-900 text-xs font-medium rounded-xl px-3 py-2.5 outline-none focus:border-black cursor-pointer shadow-sm">
                        <option value="gemini-2.0-flash-exp">Gemini 2.0 Flash (Fastest)</option>
                        <option value="gemini-1.5-flash">Gemini 1.5 Flash (Stable)</option>
                        <option value="gemini-1.5-pro">Gemini 1.5 Pro (High Quality)</option>
                    </select>
                </div>
            </div>

            <hr class="border-gray-100">

            <section class="space-y-3">
                <div class="flex items-center justify-between">
                    <h2 class="text-xs font-bold text-gray-900 flex items-center gap-2">
                        <span class="w-6 h-6 rounded-lg bg-gray-100 flex items-center justify-center text-gray-500 font-bold border border-gray-200">1</span> SCRIPT
                    </h2>
                    <div class="flex gap-2">
                        <button onclick="fetchReddit()" class="bg-orange-50 text-orange-600 border border-orange-100 hover:bg-orange-100 px-3 py-1 rounded-lg text-[10px] font-bold transition-all flex items-center gap-1"><i data-lucide="flame" class="w-3 h-3"></i> Viral</button>
                        <button onclick="generateAI()" class="bg-gray-100 text-gray-600 border border-gray-200 hover:bg-gray-200 px-3 py-1 rounded-lg text-[10px] font-bold transition-all flex items-center gap-1"><i data-lucide="sparkles" class="w-3 h-3"></i> AI</button>
                    </div>
                </div>
                <input id="topicInput" type="text" value="r/confessions" class="w-full bg-white border border-gray-200 rounded-xl px-4 py-2 text-xs text-gray-900 focus:border-black outline-none shadow-sm" placeholder="Topic...">
                <textarea id="scriptText" rows="5" class="w-full bg-white border border-gray-200 rounded-xl p-4 text-xs focus:border-black outline-none text-gray-700 resize-none leading-relaxed shadow-sm" placeholder="Text content..."></textarea>
            </section>

            <section class="space-y-3">
                <h2 class="text-xs font-bold text-gray-900 flex items-center gap-2">
                    <span class="w-6 h-6 rounded-lg bg-gray-100 flex items-center justify-center text-gray-500 font-bold border border-gray-200">2</span> MIXER
                </h2>
                
                <div class="grid grid-cols-2 gap-3 mb-2">
                    <button onclick="selectVoice('Puck')" id="voice-Puck" class="voice-btn bg-black text-white border border-transparent rounded-xl py-2.5 text-xs font-bold shadow-md">Puck (M)</button>
                    <button onclick="selectVoice('Kore')" id="voice-Kore" class="voice-btn bg-white text-gray-500 border border-gray-200 rounded-xl py-2.5 text-xs font-bold hover:border-gray-400">Kore (F)</button>
                </div>

                <div class="bg-gray-50 border border-gray-200 rounded-xl p-4 space-y-4">
                    <div class="flex justify-between items-center">
                         <div class="flex items-center gap-3">
                             <button onclick="loadPresetAudio()" class="w-8 h-8 rounded-lg bg-emerald-500 hover:bg-emerald-600 text-white flex items-center justify-center transition-all shadow-sm" title="Load Preset">
                                <i data-lucide="music" class="w-4 h-4"></i>
                             </button>
                             <label class="cursor-pointer flex items-center gap-2 text-xs font-medium text-gray-500 hover:text-black transition-colors">
                                 <i data-lucide="upload" class="w-3 h-3"></i> Upload
                                 <input type="file" id="bgMusicInput" accept="audio/*" class="hidden" onchange="handleMusicUpload(this)">
                             </label>
                         </div>
                         <span id="musicName" class="text-[10px] text-gray-400 font-mono truncate max-w-[100px]">No Music</span>
                    </div>
                    
                    <div class="space-y-3 pt-2 border-t border-gray-200">
                        <div>
                            <div class="flex justify-between text-[10px] font-bold text-gray-400 uppercase mb-1"><span>Music Vol</span><span id="volVal" class="text-gray-900">20%</span></div>
                            <input type="range" id="musicVol" min="0" max="1" step="0.05" value="0.2" class="w-full" oninput="document.getElementById('volVal').innerText = Math.round(this.value*100)+'%'">
                        </div>
                        <div>
                            <div class="flex justify-between text-[10px] font-bold text-gray-400 uppercase mb-1"><span>Voice Speed</span><span id="speedVal" class="text-gray-900">1.0x</span></div>
                            <input type="range" id="voiceSpeed" min="0.8" max="1.5" step="0.1" value="1.0" class="w-full" oninput="document.getElementById('speedVal').innerText = this.value+'x'">
                        </div>
                    </div>
                </div>

                <button onclick="synthesizeAudio()" id="synthBtn" class="w-full bg-white border-2 border-gray-100 hover:border-black text-gray-900 py-3 rounded-xl font-bold text-xs transition-all flex justify-center items-center gap-2 active:scale-95">
                    Generate Audio
                </button>
            </section>

            <section class="space-y-3">
                <h2 class="text-xs font-bold text-gray-900 flex items-center gap-2">
                    <span class="w-6 h-6 rounded-lg bg-gray-100 flex items-center justify-center text-gray-500 font-bold border border-gray-200">3</span> VISUALS
                </h2>
                <select id="bgMode" onchange="toggleBgMode()" class="w-full bg-white border border-gray-200 text-gray-900 text-xs font-medium rounded-xl px-3 py-3 outline-none focus:border-black shadow-sm cursor-pointer">
                    <option value="minecraft">Minecraft Gameplay</option>
                    <option value="upload">Custom Upload</option>
                    <option value="solid">Solid Black</option>
                </select>
                
                <div id="uploadZone" class="hidden border-2 border-dashed border-gray-300 rounded-xl p-4 text-center cursor-pointer hover:bg-white hover:border-black transition-all" onclick="document.getElementById('bgVideoInput').click()">
                     <input type="file" id="bgVideoInput" accept="video/*" class="hidden" onchange="handleVideoUpload(this.files[0])">
                     <span class="text-[10px] text-gray-500 font-bold uppercase">Click to Upload .MP4</span>
                </div>

                <div class="bg-gray-50 border border-gray-200 rounded-xl p-4 grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-[10px] font-bold text-gray-400 uppercase mb-1 block">Text Color</label>
                        <input type="color" id="textColor" value="#ffffff" class="w-full h-8 rounded-lg cursor-pointer bg-white border border-gray-200 p-0.5">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-gray-400 uppercase mb-1 block">Highlight</label>
                        <input type="color" id="highlightColor" value="#fbbf24" class="w-full h-8 rounded-lg cursor-pointer bg-white border border-gray-200 p-0.5">
                    </div>
                </div>
                <div class="pt-1">
                    <label class="text-[10px] font-bold text-gray-400 uppercase mb-1 block">Y Position</label>
                    <input type="range" id="textY" min="-300" max="300" value="0" class="w-full" oninput="renderPreview()">
                </div>
            </section>
        </div>

        <div class="p-5 border-t border-gray-200 bg-white grid grid-cols-2 gap-3 z-40">
            <button onclick="togglePlay()" id="playBtn" disabled class="bg-gray-100 text-gray-400 cursor-not-allowed py-3.5 rounded-xl font-bold text-xs transition-all flex items-center justify-center gap-2 hover:bg-gray-200">
                <i data-lucide="play" class="w-4 h-4"></i> PREVIEW
            </button>
            <button onclick="startExport()" id="exportBtn" disabled class="bg-gray-100 text-gray-400 cursor-not-allowed py-3.5 rounded-xl font-bold text-xs transition-all flex items-center justify-center gap-2 hover:bg-gray-200">
                <i data-lucide="download" class="w-4 h-4"></i> EXPORT
            </button>
        </div>
    </div>

    <div class="flex-1 bg-gray-50 relative flex justify-center items-center p-6 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]">
        
        <div id="toast" class="fixed top-5 right-5 z-50 transition-all opacity-0 translate-x-4"></div>

        <div class="canvas-container" id="canvasWrapper">
            <canvas id="mainCanvas" class="w-full h-full object-contain"></canvas>
            <video id="bgVideo" class="absolute top-0 left-0 w-px h-px opacity-0 pointer-events-none" loop muted playsinline></video>
            
            <div id="exportOverlay" class="absolute inset-0 bg-white/95 backdrop-blur-sm z-50 flex flex-col items-center justify-center hidden">
                <div class="text-center space-y-4">
                    <div class="loader mx-auto w-12 h-12 border-gray-200 border-t-black"></div>
                    <h3 class="font-black text-gray-900 tracking-widest text-lg">RENDERING</h3>
                    <p id="renderTime" class="text-xs text-gray-500 font-mono">Initializing...</p>
                    <button onclick="cancelExport()" class="text-[10px] text-red-500 hover:underline font-bold">CANCEL</button>
                </div>
            </div>
        </div>
    </div>

    <div id="tutorialOverlay" class="fixed inset-0 bg-black/80 z-[100] hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded-2xl w-[90%] max-w-[500px] shadow-2xl overflow-hidden relative">
            
            <div id="step-0" class="step-content p-8 text-center space-y-4 active">
                <div class="w-16 h-16 bg-black text-white rounded-2xl mx-auto flex items-center justify-center mb-4 shadow-lg">
                    <i data-lucide="zap" class="w-8 h-8"></i>
                </div>
                <h2 class="text-2xl font-black text-gray-900">Welcome to Dingle AI</h2>
                <p class="text-sm text-gray-500 leading-relaxed">
                    Hey there, you seem new! This tool allows you to generate <b>Viral Shorts</b> in seconds using AI.
                    <br><br>
                    Want a quick tour of how the engine works?
                </p>
                <div class="pt-4 grid grid-cols-2 gap-3">
                    <button onclick="closeTutorial()" class="py-3 rounded-xl text-xs font-bold text-gray-400 hover:bg-gray-50 hover:text-gray-900 transition-all">Skip</button>
                    <button onclick="nextStep(1)" class="py-3 rounded-xl text-xs font-bold bg-black text-white hover:bg-gray-800 shadow-lg transition-all">Start Tour</button>
                </div>
            </div>

            <div id="step-1" class="step-content p-8 text-left space-y-4">
                <div class="flex items-center gap-3 mb-2">
                    <span class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center font-bold text-sm">1</span>
                    <h3 class="font-bold text-lg">The Engine Key</h3>
                </div>
                <p class="text-xs text-gray-500 leading-relaxed">
                    To power the AI, you need a <b>Gemini API Key</b>. It's free from Google AI Studio.
                    <br><br>
                    Paste it into the top box on the left. We save it to your browser automatically, so you only do this once.
                </p>
                <div class="pt-6 flex justify-between items-center">
                    <span class="text-[10px] text-gray-300 font-bold uppercase tracking-widest">Step 1 of 5</span>
                    <button onclick="nextStep(2)" class="px-6 py-2 rounded-lg text-xs font-bold bg-black text-white hover:bg-gray-800 transition-all">Next</button>
                </div>
            </div>

            <div id="step-2" class="step-content p-8 text-left space-y-4">
                <div class="flex items-center gap-3 mb-2">
                    <span class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center font-bold text-sm">2</span>
                    <h3 class="font-bold text-lg">The Content</h3>
                </div>
                <p class="text-xs text-gray-500 leading-relaxed">
                    You have two power buttons in the "SCRIPT" section:
                </p>
                <ul class="text-xs text-gray-600 space-y-2 list-disc pl-4">
                    <li><b>Fetch Viral:</b> Scrapes a real, high-engagement story from Reddit automatically.</li>
                    <li><b>AI Gen:</b> Writes a brand new story based on your topic.</li>
                </ul>
                <div class="pt-6 flex justify-between items-center">
                    <span class="text-[10px] text-gray-300 font-bold uppercase tracking-widest">Step 2 of 5</span>
                    <button onclick="nextStep(3)" class="px-6 py-2 rounded-lg text-xs font-bold bg-black text-white hover:bg-gray-800 transition-all">Next</button>
                </div>
            </div>

            <div id="step-3" class="step-content p-8 text-left space-y-4">
                <div class="flex items-center gap-3 mb-2">
                    <span class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center font-bold text-sm">3</span>
                    <h3 class="font-bold text-lg">The Audio</h3>
                </div>
                <p class="text-xs text-gray-500 leading-relaxed">
                    Select a voice (Puck or Kore). You can also upload background music or use the "Relaxed" preset.
                    <br><br>
                    <b class="text-red-500">IMPORTANT:</b> You MUST click <b>"Generate Audio"</b> every time you change the script. This builds the audio file for the video.
                </p>
                <div class="pt-6 flex justify-between items-center">
                    <span class="text-[10px] text-gray-300 font-bold uppercase tracking-widest">Step 3 of 5</span>
                    <button onclick="nextStep(4)" class="px-6 py-2 rounded-lg text-xs font-bold bg-black text-white hover:bg-gray-800 transition-all">Next</button>
                </div>
            </div>

            <div id="step-4" class="step-content p-8 text-left space-y-4">
                <div class="flex items-center gap-3 mb-2">
                    <span class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center font-bold text-sm">4</span>
                    <h3 class="font-bold text-lg">The Visuals</h3>
                </div>
                <p class="text-xs text-gray-500 leading-relaxed">
                    Choose "Minecraft Gameplay" for instant viral retention, or upload your own MP4 video.
                    <br><br>
                    Use the sliders to adjust text position and customize colors to match the vibe.
                </p>
                <div class="pt-6 flex justify-between items-center">
                    <span class="text-[10px] text-gray-300 font-bold uppercase tracking-widest">Step 4 of 5</span>
                    <button onclick="nextStep(5)" class="px-6 py-2 rounded-lg text-xs font-bold bg-black text-white hover:bg-gray-800 transition-all">Next</button>
                </div>
            </div>

            <div id="step-5" class="step-content p-8 text-left space-y-4">
                <div class="flex items-center gap-3 mb-2">
                    <span class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center font-bold text-sm">5</span>
                    <h3 class="font-bold text-lg">Ready to Launch?</h3>
                </div>
                <p class="text-xs text-gray-500 leading-relaxed">
                    Click <b>PREVIEW</b> to watch your creation in real-time.
                    <br><br>
                    When you are happy, click <b>EXPORT</b>. The engine will render a high-quality .webm video for you to upload to YouTube Shorts or TikTok.
                    <br><br>
                    <b>Go get those views! ðŸš€</b>
                </p>
                <div class="pt-6 flex justify-between items-center">
                    <span class="text-[10px] text-gray-300 font-bold uppercase tracking-widest">Done</span>
                    <button onclick="closeTutorial()" class="px-6 py-2 rounded-lg text-xs font-bold bg-emerald-500 text-white hover:bg-emerald-600 shadow-lg transition-all">Let's Cook</button>
                </div>
            </div>

        </div>
    </div>

    <script>
        // --- CORE ENGINE (Web Audio API) ---
        const CONFIG = { width: 1080, height: 1920 };
        let STATE = {
            voice: 'Puck',
            audioCtx: null,
            bgBuffer: null,
            ttsBuffer: null,
            words: [],
            isPlaying: false,
            isExporting: false,
            startTime: 0,
            animationId: null,
            sourceNodes: []
        };

        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d');
        const video = document.getElementById('bgVideo');

        // --- INITIALIZATION ---
        window.onload = () => {
            lucide.createIcons();
            canvas.width = CONFIG.width; canvas.height = CONFIG.height;
            loadSettings();
            
            // Init Context on click (browser policy)
            document.body.addEventListener('click', initAudio, { once: true });
            
            // Load default video if available
            video.src = 'minecraft.mp4';
            video.load();
            
            renderPreview();

            // Check Tutorial
            if(!localStorage.getItem('dingle_visited_v3')) {
                startTutorial();
            }
        };

        function initAudio() {
            if (!STATE.audioCtx) STATE.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (STATE.audioCtx.state === 'suspended') STATE.audioCtx.resume();
        }

        // --- TUTORIAL LOGIC ---
        function startTutorial() {
            document.getElementById('tutorialOverlay').classList.remove('hidden');
            showStep(0);
        }

        function nextStep(step) {
            // Hide all steps
            document.querySelectorAll('.step-content').forEach(el => el.classList.remove('active'));
            // Show specific step
            document.getElementById(`step-${step}`).classList.add('active');
        }

        function showStep(step) {
            document.querySelectorAll('.step-content').forEach(el => el.classList.remove('active'));
            document.getElementById(`step-${step}`).classList.add('active');
        }

        function closeTutorial() {
            document.getElementById('tutorialOverlay').classList.add('hidden');
            localStorage.setItem('dingle_visited_v3', 'true');
        }

        // --- SETTINGS MGR ---
        function saveSettings() {
            const key = document.getElementById('apiKey').value;
            const model = document.getElementById('modelSelect').value;
            const data = { key: key, model: model };
            localStorage.setItem('dingle_conf', JSON.stringify(data));
            if(key) {
                const badge = document.getElementById('keyStatus');
                badge.classList.remove('hidden');
            }
        }

        function loadSettings() {
            const raw = localStorage.getItem('dingle_conf');
            if (raw) {
                const data = JSON.parse(raw);
                if (data.key) {
                    document.getElementById('apiKey').value = data.key;
                    document.getElementById('keyStatus').classList.remove('hidden');
                }
                if (data.model) document.getElementById('modelSelect').value = data.model;
            }
        }

        // --- ASSET LOADING ---
        async function fetchReddit() {
            const btn = document.querySelector('button[onclick="fetchReddit()"]');
            const originalHtml = btn.innerHTML;
            btn.innerHTML = '...'; btn.disabled = true;
            try {
                const sub = ['confessions', 'tifu', 'AmItheAsshole', 'entitledparents'][Math.floor(Math.random()*4)];
                const res = await fetch(`https://www.reddit.com/r/${sub}/top.json?limit=10&t=day`);
                const json = await res.json();
                const post = json.data.children.filter(p => p.data.selftext.length > 50 && p.data.selftext.length < 800)[0]?.data;
                
                if(!post) throw new Error("No good posts found.");
                
                let cleanText = post.selftext.replace(/Edit:?.*$/si, '').replace(/\[.*?\]/g, '').trim();
                document.getElementById('topicInput').value = `r/${sub}`;
                document.getElementById('scriptText').value = `${post.title}. ${cleanText}`;
                showToast(`Fetched r/${sub}`, 'success');
            } catch(e) { showToast(e.message, 'error'); }
            btn.innerHTML = originalHtml; btn.disabled = false;
        }

        async function generateAI() {
            const key = document.getElementById('apiKey').value;
            const model = document.getElementById('modelSelect').value;
            if(!key) return showToast("API Key Required", 'error');
            
            const btn = document.querySelector('button[onclick="generateAI()"]');
            const originalHtml = btn.innerHTML;
            btn.innerHTML = '...'; btn.disabled = true;

            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${key}`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: `Write a viral short script about: ${document.getElementById('topicInput').value}. Style: Reddit Story. Max 100 words. Hook first sentence.` }] }] })
                });
                const data = await res.json();
                document.getElementById('scriptText').value = data.candidates[0].content.parts[0].text;
                showToast("AI Script Generated", 'success');
            } catch(e) { showToast("AI Error", 'error'); }
            btn.innerHTML = originalHtml; btn.disabled = false;
        }

        // --- AUDIO ENGINE ---
        async function loadPresetAudio() {
            try {
                const res = await fetch('relaxed.mp3');
                const buf = await res.arrayBuffer();
                initAudio();
                STATE.bgBuffer = await STATE.audioCtx.decodeAudioData(buf);
                document.getElementById('musicName').innerText = "Preset: Relaxed";
                showToast("Music Loaded", 'success');
            } catch(e) { showToast("Missing 'relaxed.mp3'", 'error'); }
        }

        function handleMusicUpload(el) {
            if(!el.files[0]) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                initAudio();
                STATE.bgBuffer = await STATE.audioCtx.decodeAudioData(e.target.result);
                document.getElementById('musicName').innerText = el.files[0].name;
                showToast("Custom Music Loaded", 'success');
            };
            reader.readAsArrayBuffer(el.files[0]);
        }

        async function synthesizeAudio() {
            const key = document.getElementById('apiKey').value;
            const text = document.getElementById('scriptText').value;
            const model = document.getElementById('modelSelect').value;
            
            if(!key || !text) return showToast("API Key & Text Needed", 'error');

            const btn = document.getElementById('synthBtn');
            btn.innerHTML = 'Synthesizing...'; btn.disabled = true;

            try {
                // 1. Fetch TTS
                const endpoint = "gemini-2.0-flash-exp"; 
                
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${endpoint}:generateContent?key=${key}`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        contents: [{ parts: [{ text: text }] }], 
                        generationConfig: { responseModalities: ["AUDIO"], speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: STATE.voice } } } } 
                    })
                });
                const data = await res.json();
                const binaryString = atob(data.candidates[0].content.parts[0].inlineData.data);
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) bytes[i] = binaryString.charCodeAt(i);
                
                // 2. Decode
                initAudio();
                STATE.ttsBuffer = await STATE.audioCtx.decodeAudioData(bytes.buffer);
                
                // 3. Generate Timings (Density Calculation)
                const sentences = text.match(/[^.!?]+[.!?]+/g) || [text];
                const totalDur = STATE.ttsBuffer.duration;
                let charCount = text.length;
                let currentTime = 0;
                
                STATE.words = [];
                
                sentences.forEach(sent => {
                    const sentDur = (sent.length / charCount) * totalDur;
                    const sentWords = sent.trim().split(/\s+/);
                    const wordDur = sentDur / sentWords.length;
                    
                    sentWords.forEach(w => {
                        STATE.words.push({
                            word: w,
                            start: currentTime,
                            end: currentTime + wordDur,
                            sentence: sent.trim() 
                        });
                        currentTime += wordDur;
                    });
                });

                showToast("Audio Ready", 'success');
                enableControls();
            } catch(e) { showToast("TTS Failed: " + e.message, 'error'); }
            
            btn.innerHTML = 'Generate Audio'; btn.disabled = false;
        }

        // --- PLAYBACK & RENDER ---
        function togglePlay() { STATE.isPlaying ? stop() : play(); }

        function play() {
            if (!STATE.ttsBuffer) return;
            STATE.sourceNodes = [];
            STATE.startTime = STATE.audioCtx.currentTime;
            
            // TTS Node
            const ttsNode = STATE.audioCtx.createBufferSource();
            ttsNode.buffer = STATE.ttsBuffer;
            ttsNode.playbackRate.value = parseFloat(document.getElementById('voiceSpeed').value);
            ttsNode.connect(STATE.audioCtx.destination);
            ttsNode.start(0);
            ttsNode.onended = () => { if(STATE.isPlaying) stop(); };
            STATE.sourceNodes.push(ttsNode);

            // Music Node
            if (STATE.bgBuffer) {
                const bgNode = STATE.audioCtx.createBufferSource();
                bgNode.buffer = STATE.bgBuffer;
                bgNode.loop = true;
                const gain = STATE.audioCtx.createGain();
                gain.gain.value = parseFloat(document.getElementById('musicVol').value);
                bgNode.connect(gain).connect(STATE.audioCtx.destination);
                bgNode.start(0);
                STATE.sourceNodes.push(bgNode);
            }

            video.currentTime = 0;
            video.play();
            STATE.isPlaying = true;
            document.getElementById('playBtn').innerHTML = '<i data-lucide="square" class="w-3 h-3"></i> STOP';
            document.getElementById('playBtn').classList.replace('bg-gray-100','bg-red-500');
            document.getElementById('playBtn').classList.replace('text-gray-400','text-white');
            
            animate();
        }

        function stop() {
            STATE.sourceNodes.forEach(n => { try{n.stop()}catch(e){} });
            video.pause();
            STATE.isPlaying = false;
            cancelAnimationFrame(STATE.animationId);
            
            const btn = document.getElementById('playBtn');
            btn.innerHTML = '<i data-lucide="play" class="w-3 h-3"></i> PREVIEW';
            btn.classList.replace('bg-red-500','bg-gray-100');
            btn.classList.replace('text-white','text-gray-400');
            
            renderPreview(); 
        }

        function animate() {
            if (!STATE.isPlaying) return;
            const elapsed = (STATE.audioCtx.currentTime - STATE.startTime) * parseFloat(document.getElementById('voiceSpeed').value);
            drawFrame(elapsed);
            STATE.animationId = requestAnimationFrame(animate);
        }

        function drawFrame(time) {
            // Background
            if (document.getElementById('bgMode').value !== 'solid') {
                const aspect = video.videoWidth / video.videoHeight;
                const canvasAspect = canvas.width / canvas.height;
                let dw, dh, dx, dy;
                if (aspect > canvasAspect) { dh = canvas.height; dw = dh * aspect; dx = (canvas.width - dw)/2; dy = 0; }
                else { dw = canvas.width; dh = dw / aspect; dx = 0; dy = (canvas.height - dh)/2; }
                ctx.drawImage(video, dx, dy, dw, dh);
            } else {
                ctx.fillStyle = '#000'; ctx.fillRect(0,0,canvas.width,canvas.height);
            }

            // Dimmer
            ctx.fillStyle = 'rgba(0,0,0,0.5)'; ctx.fillRect(0,0,canvas.width,canvas.height);

            // Text Logic
            const activeData = STATE.words.find(w => time >= w.start && time < w.end) || STATE.words[STATE.words.length-1];
            
            if (activeData && time < (STATE.ttsBuffer.duration * 1.1)) {
                const fontSize = 70;
                ctx.font = `900 ${fontSize}px "Montserrat", sans-serif`;
                ctx.textAlign = 'center';
                
                const yPos = canvas.height/2 + parseInt(document.getElementById('textY').value);
                const currentWord = activeData.word.toUpperCase().replace(/[^A-Z0-9]/g, '');
                const isHighlight = ['WHAT','NO','STOP','DIED','KILLED','MONEY','SECRET','CHEATING'].includes(currentWord);
                
                // Stroke
                ctx.lineJoin = 'round'; ctx.lineWidth = 15; ctx.strokeStyle = 'black';
                ctx.strokeText(currentWord, canvas.width/2, yPos);
                
                // Fill
                ctx.fillStyle = isHighlight ? document.getElementById('highlightColor').value : document.getElementById('textColor').value;
                ctx.fillText(currentWord, canvas.width/2, yPos);
                
                // Progress Bar
                const pct = time / STATE.ttsBuffer.duration;
                ctx.fillStyle = document.getElementById('highlightColor').value;
                ctx.fillRect(0, canvas.height-15, canvas.width*pct, 15);
            }
        }

        function renderPreview() {
            if(STATE.isPlaying) return;
            ctx.fillStyle = '#000'; ctx.fillRect(0,0,canvas.width,canvas.height);
            ctx.font = '900 80px "Montserrat"'; ctx.fillStyle = '#333'; ctx.textAlign = 'center';
            ctx.fillText("PREVIEW", canvas.width/2, canvas.height/2);
        }

        // --- EXPORT (WebM Recording) ---
        async function startExport() {
            if(!STATE.ttsBuffer) return;
            STATE.isExporting = true;
            document.getElementById('exportOverlay').classList.remove('hidden');
            
            const dest = STATE.audioCtx.createMediaStreamDestination();
            
            // Re-create nodes
            const tts = STATE.audioCtx.createBufferSource(); 
            tts.buffer = STATE.ttsBuffer; 
            tts.playbackRate.value = parseFloat(document.getElementById('voiceSpeed').value);
            tts.connect(dest);
            
            if(STATE.bgBuffer) {
                const bg = STATE.audioCtx.createBufferSource(); bg.buffer = STATE.bgBuffer; bg.loop=true;
                const gain = STATE.audioCtx.createGain(); gain.gain.value = document.getElementById('musicVol').value;
                bg.connect(gain).connect(dest);
                bg.start(0);
            }
            tts.start(0);
            video.currentTime = 0; video.play();

            const stream = canvas.captureStream(30);
            const combined = new MediaStream([...stream.getVideoTracks(), ...dest.stream.getAudioTracks()]);
            const recorder = new MediaRecorder(combined, { mimeType: 'video/webm;codecs=vp9', videoBitsPerSecond: 8000000 });
            
            const chunks = [];
            recorder.ondataavailable = e => chunks.push(e.data);
            recorder.onstop = () => {
                const blob = new Blob(chunks, {type:'video/webm'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href=url; a.download='Dingle_Export.webm'; a.click();
                
                STATE.isExporting = false;
                document.getElementById('exportOverlay').classList.add('hidden');
                stop();
            };

            recorder.start();
            
            const dur = STATE.ttsBuffer.duration / parseFloat(document.getElementById('voiceSpeed').value);
            const start = STATE.audioCtx.currentTime;
            
            function loop() {
                if(!STATE.isExporting) return;
                const t = (STATE.audioCtx.currentTime - start) * parseFloat(document.getElementById('voiceSpeed').value);
                drawFrame(t);
                document.getElementById('renderTime').innerText = t.toFixed(1) + 's / ' + dur.toFixed(1) + 's';
                if(t >= dur) recorder.stop();
                else requestAnimationFrame(loop);
            }
            loop();
        }

        function cancelExport() { STATE.isExporting = false; stop(); document.getElementById('exportOverlay').classList.add('hidden'); }

        // --- UTILS ---
        function selectVoice(v) {
            STATE.voice = v;
            document.querySelectorAll('.voice-btn').forEach(b => b.className = "voice-btn bg-white text-gray-500 border border-gray-200 rounded-xl py-2.5 text-xs font-bold hover:border-gray-400");
            document.getElementById('voice-'+v).className = "voice-btn bg-black text-white border border-transparent rounded-xl py-2.5 text-xs font-bold shadow-md";
        }
        function toggleBgMode() {
            const mode = document.getElementById('bgMode').value;
            document.getElementById('uploadZone').style.display = mode === 'upload' ? 'block' : 'none';
            if(mode === 'minecraft') { video.src = 'minecraft.mp4'; video.load(); }
            renderPreview();
        }
        function handleVideoUpload(f) { if(f) video.src = URL.createObjectURL(f); }
        function showToast(msg, type) {
            const t = document.getElementById('toast');
            t.className = `fixed top-5 right-5 z-50 px-4 py-3 rounded-lg font-bold text-xs transition-all shadow-lg ${type=='error'?'bg-red-500 text-white':'bg-emerald-500 text-white'}`;
            t.innerText = msg; t.style.opacity = 1; t.style.transform = 'translateX(0)';
            setTimeout(() => { t.style.opacity = 0; t.style.transform = 'translateX(20px)'; }, 3000);
        }
        function enableControls() { ['playBtn','exportBtn'].forEach(id=>document.getElementById(id).disabled=false); document.getElementById('playBtn').classList.remove('cursor-not-allowed','bg-gray-100','text-gray-400'); document.getElementById('playBtn').classList.add('bg-black','text-white'); document.getElementById('exportBtn').classList.remove('cursor-not-allowed'); }
    </script>
</body>
</html>
