<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dingle Studio | Enterprise v2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* BASE THEME */
        :root { --accent: #111827; --bg: #f9fafb; --border: #e5e7eb; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg); color: #0f172a; overflow: hidden; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        
        /* UTILS */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* CONTROLS */
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 12px; width: 12px; border-radius: 50%;
            background: var(--accent); margin-top: -5px; cursor: pointer; border: 2px solid white;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 2px; cursor: pointer; background: var(--border);
        }

        /* CANVAS */
        .canvas-wrapper {
            height: 90vh; aspect-ratio: 9/16; 
            background: #000; border: 1px solid var(--border); 
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            position: relative; overflow: hidden; border-radius: 4px;
        }

        /* ANIMATIONS */
        .fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .loader { 
            width: 14px; height: 14px; 
            border: 2px solid #e5e7eb; border-top-color: #000; 
            border-radius: 50%; animation: spin 0.8s linear infinite; 
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="h-screen w-screen flex text-sm">

    <div class="w-[420px] h-full bg-white border-r border-gray-200 flex flex-col z-20 shrink-0 shadow-[4px_0_24px_rgba(0,0,0,0.02)]">
        
        <div class="px-5 pt-5 pb-0">
            <div class="flex items-center gap-2 mb-6">
                <div class="w-6 h-6 bg-black text-white rounded flex items-center justify-center">
                    <i data-lucide="zap" class="w-3.5 h-3.5"></i>
                </div>
                <h1 class="font-bold tracking-tight text-gray-900">Dingle<span class="text-gray-400 font-normal">Studio</span></h1>
                
                <div class="ml-auto flex gap-2">
                    <button onclick="toggleSettings()" class="text-gray-400 hover:text-black transition-colors"><i data-lucide="settings" class="w-4 h-4"></i></button>
                </div>
            </div>

            <div class="flex border-b border-gray-100">
                <button onclick="switchTab('studio')" id="tab-btn-studio" class="pb-3 px-4 text-xs font-bold border-b-2 border-black text-black transition-all">
                    Editor
                </button>
                <button onclick="switchTab('projects')" id="tab-btn-projects" class="pb-3 px-4 text-xs font-bold border-b-2 border-transparent text-gray-400 hover:text-gray-600 transition-all">
                    Library
                </button>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto no-scrollbar p-5 relative">
            
            <div id="view-studio" class="space-y-6 fade-in">
                
                <section class="space-y-3">
                    <div class="flex justify-between items-center">
                        <h3 class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Narrative</h3>
                        <div class="flex gap-1">
                            <button onclick="fetchReddit()" class="bg-gray-50 hover:bg-gray-100 border border-gray-200 text-gray-600 px-2 py-1 rounded text-[10px] font-bold flex items-center gap-1 transition-all">
                                <i data-lucide="shuffle" class="w-3 h-3"></i> Viral
                            </button>
                            <button onclick="generateAI()" class="bg-gray-50 hover:bg-gray-100 border border-gray-200 text-gray-600 px-2 py-1 rounded text-[10px] font-bold flex items-center gap-1 transition-all">
                                <i data-lucide="sparkles" class="w-3 h-3"></i> AI
                            </button>
                        </div>
                    </div>
                    <input id="topicInput" type="text" class="w-full bg-white border border-gray-200 rounded px-3 py-2.5 text-xs font-medium focus:border-black outline-none placeholder-gray-400" placeholder="Title / Subreddit...">
                    <textarea id="scriptText" rows="6" class="w-full bg-white border border-gray-200 rounded px-3 py-2.5 text-xs focus:border-black outline-none resize-none leading-relaxed text-gray-600" placeholder="Paste script or generate content..."></textarea>
                </section>

                <hr class="border-gray-50">

                <section class="space-y-3">
                    <h3 class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Audio Engine</h3>
                    
                    <div class="grid grid-cols-2 gap-2 bg-gray-50 p-1 rounded-lg border border-gray-100">
                        <button onclick="selectVoice('Puck')" id="voice-Puck" class="voice-btn bg-white shadow-sm text-black py-2 rounded text-xs font-bold transition-all">Puck (M)</button>
                        <button onclick="selectVoice('Kore')" id="voice-Kore" class="voice-btn text-gray-400 py-2 rounded text-xs font-bold hover:text-gray-600 transition-all">Kore (F)</button>
                    </div>

                    <div class="flex items-center gap-3 border border-gray-200 rounded px-3 py-2">
                        <button onclick="document.getElementById('bgMusicInput').click()" class="shrink-0 w-8 h-8 flex items-center justify-center bg-gray-100 rounded hover:bg-gray-200 text-gray-600 transition-colors">
                            <i data-lucide="music" class="w-4 h-4"></i>
                        </button>
                        <div class="flex-1 min-w-0">
                            <p id="musicName" class="text-[10px] font-bold text-gray-900 truncate">No Background Music</p>
                            <input type="file" id="bgMusicInput" accept="audio/*" class="hidden" onchange="handleMusicUpload(this)">
                        </div>
                        <div class="w-16">
                            <input type="range" id="musicVol" min="0" max="1" step="0.1" value="0.2">
                        </div>
                    </div>

                    <button onclick="synthesizeAudio()" id="synthBtn" class="w-full bg-black text-white hover:bg-gray-800 py-3 rounded font-bold text-xs transition-all flex justify-center items-center gap-2">
                        <span>Generate Audio Track</span>
                    </button>
                </section>

                <hr class="border-gray-50">

                <section class="space-y-4">
                    <h3 class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Composition</h3>
                    
                    <div class="relative">
                        <select id="bgMode" onchange="toggleBgMode()" class="w-full appearance-none bg-white border border-gray-200 text-gray-900 text-xs font-bold rounded px-3 py-2.5 outline-none focus:border-black cursor-pointer">
                            <option value="minecraft">Background: Minecraft Gameplay</option>
                            <option value="satisfying">Background: Satisfying Slime</option>
                            <option value="upload">Custom Video Upload</option>
                            <option value="solid">Solid Black</option>
                        </select>
                        <i data-lucide="chevron-down" class="absolute right-3 top-3 w-4 h-4 text-gray-400 pointer-events-none"></i>
                    </div>

                    <div id="uploadZone" class="hidden">
                         <input type="file" id="bgVideoInput" accept="video/*" class="hidden" onchange="handleVideoUpload(this.files[0])">
                         <button onclick="document.getElementById('bgVideoInput').click()" class="w-full border border-dashed border-gray-300 py-4 rounded text-[10px] font-bold text-gray-400 hover:border-black hover:text-black transition-colors">
                            SELECT .MP4 FILE
                         </button>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="text-[9px] font-bold text-gray-400 uppercase mb-1 block">Text</label>
                            <div class="h-9 w-full border border-gray-200 rounded flex items-center px-1">
                                <input type="color" id="textColor" value="#ffffff" class="w-full h-6 cursor-pointer bg-transparent">
                            </div>
                        </div>
                        <div>
                            <label class="text-[9px] font-bold text-gray-400 uppercase mb-1 block">Highlight</label>
                            <div class="h-9 w-full border border-gray-200 rounded flex items-center px-1">
                                <input type="color" id="highlightColor" value="#fbbf24" class="w-full h-6 cursor-pointer bg-transparent">
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <label class="text-[9px] font-bold text-gray-400 uppercase mb-1 block flex justify-between">
                            <span>Y-Offset</span> <span id="yVal">0</span>
                        </label>
                        <input type="range" id="textY" min="-300" max="300" value="0" class="w-full" oninput="renderPreview(); document.getElementById('yVal').innerText = this.value">
                    </div>
                </section>
                
                <div class="h-10"></div> </div>

            <div id="view-projects" class="hidden space-y-4 fade-in">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xs font-bold text-gray-900">Saved Projects</h2>
                    <button onclick="clearProjects()" class="text-[10px] text-red-500 hover:text-red-600">Clear All</button>
                </div>
                <div id="projectList" class="space-y-2">
                    </div>
            </div>

        </div>

        <div class="p-4 border-t border-gray-200 bg-white grid grid-cols-[1fr_auto_1fr] gap-3 z-30">
            <button onclick="saveProject()" class="border border-gray-200 text-gray-500 hover:text-black hover:border-black rounded py-3 font-bold text-xs transition-all">
                SAVE
            </button>
            
            <button onclick="togglePlay()" id="playBtn" disabled class="w-14 bg-gray-100 text-gray-400 rounded py-3 flex items-center justify-center transition-all cursor-not-allowed">
                <i data-lucide="play" class="w-4 h-4"></i>
            </button>
            
            <button onclick="startExport()" id="exportBtn" disabled class="bg-black text-white opacity-50 cursor-not-allowed rounded py-3 font-bold text-xs transition-all hover:bg-gray-800">
                EXPORT
            </button>
        </div>
    </div>

    <div class="flex-1 bg-gray-50 relative flex flex-col justify-center items-center p-10 bg-[radial-gradient(#e5e7eb_1px,transparent_1px)] [background-size:16px_16px]">
        
        <div id="toast" class="absolute top-6 flex items-center gap-3 bg-white border border-gray-200 px-4 py-3 rounded shadow-lg transition-all opacity-0 -translate-y-4 z-50">
            <div id="toastDot" class="w-2 h-2 rounded-full bg-black"></div>
            <span id="toastMsg" class="text-xs font-bold text-gray-800">Ready</span>
        </div>

        <div class="canvas-wrapper">
            <canvas id="mainCanvas" class="w-full h-full object-contain"></canvas>
            <video id="bgVideo" class="absolute opacity-0 pointer-events-none" loop muted playsinline></video>
            
            <div id="renderOverlay" class="absolute inset-0 bg-white/95 backdrop-blur-sm z-50 flex flex-col items-center justify-center hidden">
                <div class="loader mb-4"></div>
                <h3 class="font-bold text-sm tracking-widest mb-1">RENDERING</h3>
                <p id="renderProgress" class="text-[10px] text-gray-400 font-mono">0%</p>
                <button onclick="cancelExport()" class="mt-6 text-[10px] font-bold text-red-500 hover:underline">CANCEL</button>
            </div>
        </div>
        
        <p class="mt-4 text-[10px] text-gray-400 font-medium">PREVIEW MODE • 1080x1920</p>
    </div>

    <div id="settingsModal" class="fixed inset-0 bg-black/40 z-[100] hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded-lg w-[380px] shadow-2xl p-6">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-sm">Engine Settings</h3>
                <button onclick="toggleSettings()"><i data-lucide="x" class="w-4 h-4 text-gray-400"></i></button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="text-[10px] font-bold text-gray-400 uppercase">Gemini API Key</label>
                    <input id="apiKey" type="password" class="w-full mt-1 bg-gray-50 border border-gray-200 rounded px-3 py-2 text-xs font-mono">
                </div>
                <div>
                    <label class="text-[10px] font-bold text-gray-400 uppercase">Model</label>
                    <select id="modelSelect" class="w-full mt-1 bg-gray-50 border border-gray-200 rounded px-3 py-2 text-xs font-mono">
                        <option value="gemini-2.0-flash-exp">Gemini 2.0 Flash (Fast)</option>
                        <option value="gemini-1.5-pro">Gemini 1.5 Pro (Quality)</option>
                    </select>
                </div>
                <button onclick="saveSettings()" class="w-full bg-black text-white py-3 rounded text-xs font-bold mt-2">Save Configuration</button>
            </div>
        </div>
    </div>

    <script>
        // --- STATE ---
        const CONFIG = { w: 1080, h: 1920 };
        let STATE = {
            voice: 'Puck',
            audioCtx: null,
            bgBuffer: null,
            ttsBuffer: null,
            words: [],
            isPlaying: false,
            isExporting: false,
            startTime: 0,
            animId: null,
            sourceNodes: []
        };

        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d');
        const video = document.getElementById('bgVideo');

        // --- INIT ---
        window.onload = () => {
            lucide.createIcons();
            canvas.width = CONFIG.w; canvas.height = CONFIG.h;
            
            // Auto-load settings
            const conf = JSON.parse(localStorage.getItem('dingle_conf') || '{}');
            if(conf.key) document.getElementById('apiKey').value = conf.key;
            
            // Load Default Video
            video.src = 'https://assets.mixkit.co/videos/preview/mixkit-stars-in-space-background-1610-large.mp4';
            
            // Render Initial State
            renderPreview();
            renderProjects();
            
            // Ensure Studio is active
            switchTab('studio');
            
            // Initialize Audio Context on first interaction
            document.body.addEventListener('click', () => {
                if(!STATE.audioCtx) STATE.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                if(STATE.audioCtx.state === 'suspended') STATE.audioCtx.resume();
            }, { once: true });
        };

        // --- UI LOGIC ---
        function switchTab(tab) {
            document.getElementById('view-studio').classList.add('hidden');
            document.getElementById('view-projects').classList.add('hidden');
            document.getElementById(`view-${tab}`).classList.remove('hidden');

            const btns = document.querySelectorAll('[id^="tab-btn-"]');
            btns.forEach(b => {
                b.classList.remove('border-black', 'text-black');
                b.classList.add('border-transparent', 'text-gray-400');
            });
            const active = document.getElementById(`tab-btn-${tab}`);
            active.classList.remove('border-transparent', 'text-gray-400');
            active.classList.add('border-black', 'text-black');
        }

        function toggleSettings() {
            const el = document.getElementById('settingsModal');
            el.classList.toggle('hidden');
        }

        function saveSettings() {
            const key = document.getElementById('apiKey').value;
            const model = document.getElementById('modelSelect').value;
            localStorage.setItem('dingle_conf', JSON.stringify({ key, model }));
            toggleSettings();
            showToast('Settings Saved', 'success');
        }

        function showToast(msg, type) {
            const t = document.getElementById('toast');
            document.getElementById('toastMsg').innerText = msg;
            document.getElementById('toastDot').className = `w-2 h-2 rounded-full ${type=='error'?'bg-red-500':'bg-emerald-500'}`;
            t.style.opacity = 1; t.style.transform = 'translateY(0)';
            setTimeout(() => { t.style.opacity = 0; t.style.transform = 'translateY(-16px)'; }, 3000);
        }

        // --- REDDIT FETCH (IMPROVED RANDOMIZATION) ---
        async function fetchReddit() {
            const subs = ['confessions', 'tifu', 'AmItheAsshole', 'TrueOffMyChest', 'entitledparents'];
            const sub = subs[Math.floor(Math.random() * subs.length)];
            
            showToast(`Scouring r/${sub}...`, 'neutral');
            
            try {
                // Fetch top 25 of the day to get a good pool
                const res = await fetch(`https://www.reddit.com/r/${sub}/top.json?limit=25&t=day`);
                const json = await res.json();
                
                // Filter: No NSFW, Length 50-800 chars, No Pinned Posts
                const candidates = json.data.children.filter(c => {
                    const p = c.data;
                    return !p.over_18 && !p.stickied && p.selftext.length > 100 && p.selftext.length < 900;
                });

                if(candidates.length === 0) throw new Error("No clean posts found.");

                // PICK RANDOM
                const winner = candidates[Math.floor(Math.random() * candidates.length)].data;
                
                // Clean Text
                let cleanText = winner.selftext.replace(/Edit:?.*$/si, '').replace(/\[.*?\]/g, '').trim();
                
                document.getElementById('topicInput').value = `r/${sub}: ${winner.title}`;
                document.getElementById('scriptText').value = cleanText;
                
                showToast('Fresh Story Loaded', 'success');

            } catch(e) {
                console.error(e);
                showToast('Fetch Failed, Try Again', 'error');
            }
        }

        // --- AI GENERATION ---
        async function generateAI() {
            const key = document.getElementById('apiKey').value;
            if(!key) return toggleSettings();
            
            showToast('AI Writing...', 'neutral');
            const model = document.getElementById('modelSelect').value;
            
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${key}`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: `Write a viral short script. Topic: ${document.getElementById('topicInput').value || 'Random Viral Story'}. Style: Engaging, First Person. Max 120 words. No intro.` }] }] })
                });
                const data = await res.json();
                document.getElementById('scriptText').value = data.candidates[0].content.parts[0].text;
                showToast('Script Generated', 'success');
            } catch(e) { showToast('AI Error', 'error'); }
        }

        // --- AUDIO ENGINE ---
        function handleMusicUpload(el) {
            if(!el.files[0]) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                if(!STATE.audioCtx) STATE.audioCtx = new AudioContext();
                STATE.bgBuffer = await STATE.audioCtx.decodeAudioData(e.target.result);
                document.getElementById('musicName').innerText = el.files[0].name;
                showToast('Music Loaded', 'success');
            };
            reader.readAsArrayBuffer(el.files[0]);
        }

        async function synthesizeAudio() {
            const key = document.getElementById('apiKey').value;
            const text = document.getElementById('scriptText').value;
            
            if(!key) { toggleSettings(); return; }
            if(!text) return showToast('No Script Text', 'error');

            const btn = document.getElementById('synthBtn');
            const original = btn.innerHTML;
            btn.innerHTML = '<div class="loader border-gray-600 border-t-white"></div>'; btn.disabled = true;

            try {
                const endpoint = "gemini-2.0-flash-exp"; 
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${endpoint}:generateContent?key=${key}`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        contents: [{ parts: [{ text: text }] }], 
                        generationConfig: { responseModalities: ["AUDIO"], speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: STATE.voice } } } } 
                    })
                });
                const data = await res.json();
                const binary = atob(data.candidates[0].content.parts[0].inlineData.data);
                const bytes = new Uint8Array(binary.length);
                for(let i=0; i<binary.length; i++) bytes[i] = binary.charCodeAt(i);

                if(!STATE.audioCtx) STATE.audioCtx = new AudioContext();
                STATE.ttsBuffer = await STATE.audioCtx.decodeAudioData(bytes.buffer);
                
                // Calc Timings
                const words = text.replace(/\s+/g, ' ').trim().split(' ');
                const durPerWord = STATE.ttsBuffer.duration / words.length;
                let t = 0;
                STATE.words = words.map(w => {
                    const d = { word: w, start: t, end: t + durPerWord };
                    t += durPerWord;
                    return d;
                });

                showToast('Audio Ready', 'success');
                ['playBtn','exportBtn'].forEach(id => {
                    document.getElementById(id).disabled = false;
                    document.getElementById(id).classList.remove('opacity-50', 'cursor-not-allowed');
                });

            } catch(e) { showToast('Synthesis Failed', 'error'); console.log(e); }
            
            btn.innerHTML = original; btn.disabled = false;
        }

        // --- PLAYBACK & RENDER ---
        function togglePlay() { STATE.isPlaying ? stop() : play(); }

        function play() {
            if(!STATE.ttsBuffer) return;
            STATE.sourceNodes = [];
            STATE.startTime = STATE.audioCtx.currentTime;

            const tts = STATE.audioCtx.createBufferSource();
            tts.buffer = STATE.ttsBuffer;
            tts.connect(STATE.audioCtx.destination);
            tts.start(0);
            tts.onended = () => { if(STATE.isPlaying) stop(); };
            STATE.sourceNodes.push(tts);

            if(STATE.bgBuffer) {
                const bg = STATE.audioCtx.createBufferSource();
                bg.buffer = STATE.bgBuffer; bg.loop = true;
                const gain = STATE.audioCtx.createGain();
                gain.gain.value = document.getElementById('musicVol').value;
                bg.connect(gain).connect(STATE.audioCtx.destination);
                bg.start(0);
                STATE.sourceNodes.push(bg);
            }

            video.currentTime = 0; video.play();
            STATE.isPlaying = true;
            
            const btn = document.getElementById('playBtn');
            btn.innerHTML = '<i data-lucide="square" class="w-4 h-4 fill-current"></i>';
            btn.classList.add('bg-red-500', 'text-white', 'hover:bg-red-600');
            btn.classList.remove('bg-gray-100', 'text-gray-400');
            
            animate();
        }

        function stop() {
            STATE.sourceNodes.forEach(n => { try{n.stop()}catch(e){} });
            video.pause();
            STATE.isPlaying = false;
            cancelAnimationFrame(STATE.animId);
            
            const btn = document.getElementById('playBtn');
            btn.innerHTML = '<i data-lucide="play" class="w-4 h-4"></i>';
            btn.classList.remove('bg-red-500', 'text-white', 'hover:bg-red-600');
            btn.classList.add('bg-gray-100', 'text-gray-400');
            
            renderPreview();
        }

        function animate() {
            if(!STATE.isPlaying) return;
            const t = STATE.audioCtx.currentTime - STATE.startTime;
            drawFrame(t);
            STATE.animId = requestAnimationFrame(animate);
        }

        // --- GRAPHICS ENGINE (With Wrapping) ---
        function drawFrame(time) {
            // Background
            if(document.getElementById('bgMode').value !== 'solid') {
                const aspect = video.videoWidth / video.videoHeight;
                const canvasAspect = canvas.width / canvas.height;
                let dw, dh, dx, dy;
                if(aspect > canvasAspect) { dh = canvas.height; dw = dh * aspect; dx = (canvas.width - dw)/2; dy = 0; }
                else { dw = canvas.width; dh = dw / aspect; dx = 0; dy = (canvas.height - dh)/2; }
                ctx.drawImage(video, dx, dy, dw, dh);
            } else {
                ctx.fillStyle = '#000'; ctx.fillRect(0,0,canvas.width,canvas.height);
            }

            // Dimmer
            ctx.fillStyle = 'rgba(0,0,0,0.5)'; ctx.fillRect(0,0,canvas.width,canvas.height);

            // Text
            const activeData = STATE.words.find(w => time >= w.start && time < w.end) || STATE.words[STATE.words.length-1];
            
            if(activeData && time < STATE.ttsBuffer.duration + 0.5) {
                const fontSize = 80;
                ctx.font = `900 ${fontSize}px "Inter", sans-serif`;
                ctx.textAlign = 'center';
                ctx.lineJoin = 'round'; ctx.lineWidth = 18; ctx.strokeStyle = 'black';
                
                const yBase = canvas.height/2 + parseInt(document.getElementById('textY').value);
                const word = activeData.word.toUpperCase().replace(/[^A-Z0-9']/g, '');
                
                // Color Logic
                const isHighlight = ['WHAT','NO','STOP','DIED','KILLED','SECRET','CRAZY'].some(x => word.includes(x));
                const fillColor = isHighlight ? document.getElementById('highlightColor').value : document.getElementById('textColor').value;
                
                // Simple Draw
                ctx.strokeText(word, canvas.width/2, yBase);
                ctx.fillStyle = fillColor;
                ctx.fillText(word, canvas.width/2, yBase);
            }
        }

        function renderPreview() {
            if(STATE.isPlaying) return;
            ctx.fillStyle = '#111827'; ctx.fillRect(0,0,canvas.width,canvas.height);
            ctx.font = '700 40px "Inter"'; ctx.fillStyle = '#374151'; ctx.textAlign = 'center';
            ctx.fillText("PREVIEW", canvas.width/2, canvas.height/2);
        }

        // --- EXPORT ---
        async function startExport() {
            STATE.isExporting = true;
            document.getElementById('renderOverlay').classList.remove('hidden');
            
            const dest = STATE.audioCtx.createMediaStreamDestination();
            const tts = STATE.audioCtx.createBufferSource(); tts.buffer = STATE.ttsBuffer; tts.connect(dest); tts.start(0);
            
            if(STATE.bgBuffer) {
                const bg = STATE.audioCtx.createBufferSource(); bg.buffer = STATE.bgBuffer; bg.loop=true;
                const g = STATE.audioCtx.createGain(); g.gain.value = document.getElementById('musicVol').value;
                bg.connect(g).connect(dest); bg.start(0);
            }
            
            video.currentTime = 0; video.play();
            const stream = canvas.captureStream(30);
            const recorder = new MediaRecorder(new MediaStream([...stream.getVideoTracks(), ...dest.stream.getAudioTracks()]), { mimeType: 'video/webm;codecs=vp9', videoBitsPerSecond: 8000000 });
            
            const chunks = [];
            recorder.ondataavailable = e => chunks.push(e.data);
            recorder.onstop = () => {
                const url = URL.createObjectURL(new Blob(chunks, {type:'video/webm'}));
                const a = document.createElement('a'); a.href=url; a.download=`Dingle_${Date.now()}.webm`; a.click();
                cancelExport();
            };
            
            recorder.start();
            
            const dur = STATE.ttsBuffer.duration;
            const startT = STATE.audioCtx.currentTime;
            
            function loop() {
                if(!STATE.isExporting) return;
                const t = STATE.audioCtx.currentTime - startT;
                drawFrame(t);
                document.getElementById('renderProgress').innerText = Math.min(100, Math.round((t/dur)*100)) + "%";
                if(t >= dur) recorder.stop();
                else requestAnimationFrame(loop);
            }
            loop();
        }

        function cancelExport() { 
            STATE.isExporting = false; 
            stop(); 
            document.getElementById('renderOverlay').classList.add('hidden'); 
        }

        // --- PROJECT MGR ---
        function saveProject() {
            const p = {
                id: Date.now(),
                title: document.getElementById('topicInput').value || 'Untitled',
                date: new Date().toLocaleDateString(),
                script: document.getElementById('scriptText').value,
                settings: {
                    voice: STATE.voice,
                    bg: document.getElementById('bgMode').value,
                    col1: document.getElementById('textColor').value,
                    col2: document.getElementById('highlightColor').value
                }
            };
            const list = JSON.parse(localStorage.getItem('dingle_projs') || '[]');
            list.unshift(p);
            localStorage.setItem('dingle_projs', JSON.stringify(list));
            showToast('Project Saved', 'success');
            renderProjects();
        }

        function renderProjects() {
            const list = JSON.parse(localStorage.getItem('dingle_projs') || '[]');
            const container = document.getElementById('projectList');
            if(list.length === 0) { container.innerHTML = '<div class="text-center text-xs text-gray-400 py-10">Empty Library</div>'; return; }
            
            container.innerHTML = list.map(p => `
                <div class="group bg-white border border-gray-200 p-3 rounded hover:border-black cursor-pointer relative transition-all" onclick="loadP(${p.id})">
                    <div class="font-bold text-xs truncate pr-6">${p.title}</div>
                    <div class="text-[10px] text-gray-400 mt-1">${p.date} • ${p.settings.voice}</div>
                    <button onclick="event.stopPropagation(); delP(${p.id})" class="absolute top-3 right-3 opacity-0 group-hover:opacity-100 text-gray-400 hover:text-red-500"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function loadP(id) {
            const list = JSON.parse(localStorage.getItem('dingle_projs'));
            const p = list.find(x => x.id === id);
            if(!p) return;
            document.getElementById('topicInput').value = p.title;
            document.getElementById('scriptText').value = p.script;
            selectVoice(p.settings.voice);
            document.getElementById('bgMode').value = p.settings.bg;
            document.getElementById('textColor').value = p.settings.col1;
            document.getElementById('highlightColor').value = p.settings.col2;
            toggleBgMode();
            switchTab('studio');
            showToast('Project Loaded', 'success');
        }

        function delP(id) {
            const list = JSON.parse(localStorage.getItem('dingle_projs')).filter(x => x.id !== id);
            localStorage.setItem('dingle_projs', JSON.stringify(list));
            renderProjects();
        }

        function clearProjects() { localStorage.removeItem('dingle_projs'); renderProjects(); }

        // --- UTILS ---
        function selectVoice(v) {
            STATE.voice = v;
            document.querySelectorAll('.voice-btn').forEach(b => {
                b.className = "voice-btn bg-white text-gray-500 py-2 rounded text-xs font-bold border border-gray-200 hover:border-gray-300";
            });
            document.getElementById('voice-'+v).className = "voice-btn bg-black text-white py-2 rounded text-xs font-bold border border-transparent shadow-md";
        }

        function toggleBgMode() {
            const m = document.getElementById('bgMode').value;
            document.getElementById('uploadZone').style.display = m === 'upload' ? 'block' : 'none';
            if(m === 'minecraft') video.src = 'https://assets.mixkit.co/videos/preview/mixkit-stars-in-space-background-1610-large.mp4'; 
            if(m === 'satisfying') video.src = 'https://assets.mixkit.co/videos/preview/mixkit-pink-and-blue-ink-swirling-in-water-1613-large.mp4';
            video.load();
            renderPreview();
        }
        function handleVideoUpload(f) { if(f) video.src = URL.createObjectURL(f); }
    </script>
</body>
</html>
