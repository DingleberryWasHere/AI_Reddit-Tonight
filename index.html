<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dingle AI | Ultimate Studio</title>
    
    <script>
        (function() {
            const storedVersion = localStorage.getItem('puter_version') || 'v2';
            console.log(`Loading Puter.js ${storedVersion}`);
            document.write('<script src="https://js.puter.com/' + storedVersion + '/"><\/script>');
        })();
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Montserrat:wght@700;800;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #f8fafc; overflow: hidden; }
        
        /* Custom Scrollbar */
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #1e293b; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #64748b; }

        /* Sliders */
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%;
            background: #3b82f6; margin-top: -6px; cursor: pointer;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.2);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; cursor: pointer; background: #334155; border-radius: 2px;
        }

        /* Canvas Phone Look */
        .canvas-container {
            height: 85vh; aspect-ratio: 9/16; max-width: 100%; position: relative;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            background: #000; border-radius: 24px; overflow: hidden; border: 8px solid #1e293b;
        }
        
        /* Modal Transitions */
        .modal { opacity: 0; pointer-events: none; transition: all 0.2s ease-in-out; transform: scale(0.95); }
        .modal.open { opacity: 1; pointer-events: auto; transform: scale(1); }
    </style>
</head>
<body class="h-screen w-screen flex flex-col md:flex-row">

    <div class="w-full md:w-[420px] flex flex-col border-r border-slate-800 bg-slate-900 z-30 shrink-0 h-full shadow-2xl">
        
        <div class="px-6 py-5 border-b border-slate-800 flex justify-between items-center bg-slate-900 shrink-0">
            <h1 class="text-xl font-bold tracking-tight text-white flex items-center gap-3">
                <div class="bg-blue-600 text-white p-1.5 rounded-lg shadow-lg shadow-blue-500/20"><i data-lucide="zap" class="w-5 h-5"></i></div>
                Dingle<span class="text-slate-500">AI</span>
            </h1>
            <div class="flex items-center gap-2">
                <div id="authContainer">
                    <button onclick="loginPuter()" class="bg-slate-800 hover:bg-slate-700 text-slate-300 px-3 py-1.5 rounded-lg text-[10px] font-bold transition-all flex items-center gap-1.5 border border-slate-700">
                        <i data-lucide="log-in" class="w-3 h-3"></i> Login
                    </button>
                </div>
                <button onclick="toggleSettings()" class="bg-slate-800 hover:bg-blue-600 hover:text-white text-slate-400 p-2 rounded-lg transition-all border border-slate-700">
                    <i data-lucide="settings-2" class="w-4 h-4"></i>
                </button>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto p-6 space-y-8 custom-scroll">

            <section class="space-y-4">
                <div class="flex items-center justify-between">
                    <h2 class="text-xs font-bold text-blue-400 tracking-wider flex items-center gap-2 uppercase">
                        <i data-lucide="file-text" class="w-4 h-4"></i> 1. The Story
                    </h2>
                    <div class="flex gap-2">
                        <button onclick="fetchReddit()" class="bg-orange-500/10 text-orange-400 border border-orange-500/20 hover:bg-orange-500/20 px-3 py-1.5 rounded-md text-[10px] font-bold transition-all flex items-center gap-1.5">
                            <i data-lucide="flame" class="w-3 h-3"></i> Viral Post
                        </button>
                        <button onclick="generateAIScript()" id="aiBtn" class="bg-blue-500/10 text-blue-400 border border-blue-500/20 hover:bg-blue-500/20 px-3 py-1.5 rounded-md text-[10px] font-bold transition-all flex items-center gap-1.5">
                            <i data-lucide="sparkles" class="w-3 h-3"></i> AI Write
                        </button>
                    </div>
                </div>
                <div class="space-y-2">
                    <input id="topicInput" type="text" value="r/confessions" class="w-full bg-slate-800 border border-slate-700 rounded-xl px-4 py-3 text-sm text-white focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition-all placeholder-slate-500" placeholder="Topic or Subreddit...">
                    <textarea id="scriptText" rows="5" class="w-full bg-slate-800 border border-slate-700 rounded-xl p-4 text-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none text-slate-300 resize-none leading-relaxed placeholder-slate-500" placeholder="Paste script or write topic above..."></textarea>
                </div>
            </section>

            <section class="space-y-4">
                <h2 class="text-xs font-bold text-emerald-400 tracking-wider flex items-center gap-2 uppercase">
                    <i data-lucide="mic-2" class="w-4 h-4"></i> 2. The Voice
                </h2>
                
                <div class="bg-slate-800 border border-slate-700 rounded-xl p-4 space-y-4">
                    <div id="browserVoiceContainer" class="hidden space-y-2">
                        <label class="text-[10px] font-bold text-slate-400 uppercase">System Voice</label>
                        <select id="browserVoiceSelect" class="w-full bg-slate-900 border border-slate-600 text-white text-xs rounded-lg px-2 py-2 outline-none"></select>
                    </div>

                    <div class="flex items-center justify-between bg-slate-900 rounded-lg p-3 border border-slate-700">
                         <div class="flex items-center gap-3">
                             <button onclick="document.getElementById('bgMusicInput').click()" class="w-8 h-8 rounded-full bg-emerald-500 hover:bg-emerald-400 text-white flex items-center justify-center transition-all shadow-lg shadow-emerald-500/20">
                                <i data-lucide="music" class="w-4 h-4"></i>
                             </button>
                             <div class="flex flex-col">
                                 <span class="text-[10px] font-bold text-slate-400 uppercase">Background Music</span>
                                 <span id="musicName" class="text-xs text-white font-medium truncate max-w-[150px]">None Selected</span>
                             </div>
                         </div>
                         <input type="file" id="bgMusicInput" accept="audio/*" class="hidden" onchange="handleMusicUpload(this)">
                    </div>
                    
                    <div class="grid grid-cols-2 gap-6 px-1">
                        <div>
                            <div class="flex justify-between text-[10px] font-bold text-slate-400 uppercase mb-2"><span>Music Vol</span><span id="volVal" class="text-white">20%</span></div>
                            <input type="range" id="musicVol" min="0" max="1" step="0.05" value="0.2" oninput="document.getElementById('volVal').innerText = Math.round(this.value*100)+'%'">
                        </div>
                        <div>
                            <div class="flex justify-between text-[10px] font-bold text-slate-400 uppercase mb-2"><span>Speed</span><span id="speedVal" class="text-white">1.0x</span></div>
                            <input type="range" id="voiceSpeed" min="0.8" max="1.5" step="0.1" value="1.0" oninput="document.getElementById('speedVal').innerText = this.value+'x'">
                        </div>
                    </div>
                </div>

                <button onclick="synthesizeAudio()" id="synthBtn" class="w-full bg-white text-slate-900 hover:bg-blue-50 py-3 rounded-xl font-bold text-sm transition-all flex justify-center items-center gap-2 active:scale-95 shadow-lg shadow-white/10">
                    <i data-lucide="play-circle" class="w-4 h-4"></i> Generate Audio
                </button>
                <div class="flex justify-between items-center px-1">
                    <p class="text-[10px] text-slate-500" id="ttsProviderLabel">Current: Default</p>
                    <button onclick="initBrowserVoices()" class="text-[10px] text-blue-400 hover:underline">Refresh Voices</button>
                </div>
            </section>

            <section class="space-y-4">
                <h2 class="text-xs font-bold text-purple-400 tracking-wider flex items-center gap-2 uppercase">
                    <i data-lucide="monitor" class="w-4 h-4"></i> 3. Visuals
                </h2>
                
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="setBgMode('minecraft')" class="bg-slate-800 hover:bg-slate-700 border border-slate-700 hover:border-purple-500 text-slate-300 py-2 rounded-lg text-xs font-bold transition-all">Minecraft</button>
                    <button onclick="document.getElementById('bgVideoInput').click()" class="bg-slate-800 hover:bg-slate-700 border border-slate-700 hover:border-purple-500 text-slate-300 py-2 rounded-lg text-xs font-bold transition-all">Upload Video</button>
                    <input type="file" id="bgVideoInput" accept="video/*" class="hidden" onchange="handleVideoUpload(this.files[0])">
                </div>

                <div class="bg-slate-800 border border-slate-700 rounded-xl p-4 space-y-4">
                    <div class="flex gap-4">
                        <div class="flex-1">
                            <label class="text-[10px] font-bold text-slate-400 uppercase block mb-1">Text Color</label>
                            <input type="color" id="textColor" value="#ffffff" class="w-full h-8 rounded cursor-pointer bg-transparent border border-slate-600">
                        </div>
                        <div class="flex-1">
                            <label class="text-[10px] font-bold text-slate-400 uppercase block mb-1">Highlight</label>
                            <input type="color" id="highlightColor" value="#fbbf24" class="w-full h-8 rounded cursor-pointer bg-transparent border border-slate-600">
                        </div>
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase mb-2 block">Text Position (Y-Axis)</label>
                        <input type="range" id="textY" min="-300" max="300" value="0" class="w-full" oninput="renderPreview()">
                    </div>
                </div>
            </section>
        </div>

        <div class="p-6 border-t border-slate-800 bg-slate-900 grid grid-cols-2 gap-4 z-40 shrink-0">
            <button onclick="togglePlay()" id="playBtn" class="bg-blue-600 hover:bg-blue-500 text-white py-3.5 rounded-xl font-bold text-sm transition-all flex items-center justify-center gap-2 shadow-lg shadow-blue-900/50">
                <i data-lucide="play" class="w-4 h-4"></i> PREVIEW
            </button>
            <button onclick="saveProjectToCloud()" id="saveBtn" disabled class="bg-slate-800 text-slate-600 cursor-not-allowed py-3.5 rounded-xl font-bold text-sm transition-all flex items-center justify-center gap-2 border border-slate-700">
                <i data-lucide="cloud" class="w-4 h-4"></i> SAVE
            </button>
        </div>
    </div>

    <div class="flex-1 bg-slate-950 relative flex justify-center items-center p-4 md:p-8 bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')]">
        
        <div id="toast" class="fixed top-5 right-5 z-50 transition-all opacity-0 translate-x-4 bg-slate-800 border border-slate-700 text-white shadow-2xl px-4 py-3 rounded-lg font-bold text-xs flex items-center gap-2"></div>

        <div class="canvas-container shadow-2xl" id="canvasWrapper">
            <canvas id="mainCanvas" class="w-full h-full object-contain bg-black"></canvas>
            <video id="bgVideo" class="absolute top-0 left-0 w-px h-px opacity-0 pointer-events-none" loop muted playsinline crossorigin="anonymous"></video>
        </div>
    </div>

    <div id="settingsModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm modal">
        <div class="bg-white rounded-2xl w-[90%] max-w-[500px] shadow-2xl overflow-hidden flex flex-col max-h-[85vh]">
            <div class="p-5 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                <h3 class="font-bold text-lg text-gray-900 flex items-center gap-2"><i data-lucide="sliders" class="w-5 h-5 text-blue-600"></i> Settings</h3>
                <button onclick="toggleSettings()" class="text-gray-400 hover:text-black transition-colors"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            
            <div class="p-6 overflow-y-auto space-y-6">
                
                <div class="space-y-2 bg-blue-50 p-3 rounded-lg border border-blue-100">
                    <label class="text-[10px] font-bold text-blue-800 uppercase tracking-widest block">Puter.js Version</label>
                    <select id="puterVersionSelector" class="w-full bg-white border border-blue-200 text-sm font-medium rounded-lg px-3 py-2 outline-none">
                        <option value="v2">Version 2 (Latest)</option>
                        <option value="v1">Version 1 (Legacy)</option>
                    </select>
                    <p class="text-[10px] text-blue-600">Page will reload upon saving if this changes.</p>
                </div>

                <div class="space-y-3">
                    <label class="text-[10px] font-bold text-gray-500 uppercase tracking-widest flex items-center gap-2">
                        <i data-lucide="cpu" class="w-3 h-3"></i> Text Generation
                    </label>
                    <select id="genProvider" onchange="updateSettingsUI()" class="w-full bg-white border border-gray-200 text-sm font-medium rounded-lg px-3 py-2 outline-none focus:border-black">
                        <option value="puter">Puter AI (Free / No Key)</option>
                        <option value="gemini">Google Gemini</option>
                        <option value="groq">Groq (Llama 3)</option>
                        <option value="openai">OpenAI (GPT-4)</option>
                    </select>
                    
                    <div id="key-gemini" class="provider-key hidden"><input id="geminiKey" type="password" class="w-full bg-gray-50 border border-gray-200 text-xs rounded-lg px-3 py-2 outline-none font-mono" placeholder="Gemini API Key"></div>
                    <div id="key-groq" class="provider-key hidden"><input id="groqKey" type="password" class="w-full bg-gray-50 border border-gray-200 text-xs rounded-lg px-3 py-2 outline-none font-mono" placeholder="Groq API Key"></div>
                    <div id="key-openai" class="provider-key hidden"><input id="openaiKey" type="password" class="w-full bg-gray-50 border border-gray-200 text-xs rounded-lg px-3 py-2 outline-none font-mono" placeholder="OpenAI API Key"></div>
                </div>

                <hr class="border-gray-100">

                <div class="space-y-3">
                    <label class="text-[10px] font-bold text-gray-500 uppercase tracking-widest flex items-center gap-2">
                        <i data-lucide="mic" class="w-3 h-3"></i> Voice Provider
                    </label>
                    <select id="ttsProvider" onchange="updateSettingsUI()" class="w-full bg-white border border-gray-200 text-sm font-medium rounded-lg px-3 py-2 outline-none focus:border-black">
                        <option value="browser">Browser Native (Free / Offline)</option>
                        <option value="puter">Puter TTS (Free)</option>
                        <option value="gemini">Google Gemini (Requires Key)</option>
                    </select>
                    <p class="text-[10px] text-gray-400">Browser Native uses voices installed on your computer. No keys required.</p>
                </div>
            </div>

            <div class="p-5 border-t border-gray-100 bg-gray-50 flex justify-end gap-2">
                <button onclick="saveSettings()" class="bg-black text-white px-6 py-2.5 rounded-xl text-xs font-bold hover:bg-gray-800 transition-all shadow-lg">Save Changes</button>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIG & STATE ---
        const CONFIG = { width: 1080, height: 1920 };
        let STATE = {
            voice: 'Puck',
            audioCtx: null,
            bgBuffer: null,
            ttsBuffer: null,
            words: [],
            isPlaying: false,
            startTime: 0,
            animationId: null,
            sourceNodes: [],
            user: null,
            guestDuration: 0,
            browserVoices: []
        };

        let SETTINGS = {
            genProvider: 'puter',
            ttsProvider: 'browser', // Defaulting to browser for ease of use
            puterVersion: 'v2',
            keys: { gemini: '', groq: '', openai: '' }
        };

        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d');
        const video = document.getElementById('bgVideo');

        // --- INIT ---
        window.onload = async () => {
            lucide.createIcons();
            canvas.width = CONFIG.width; canvas.height = CONFIG.height;
            loadSettingsLocal();
            updateSettingsUI();
            
            // Puter Auth Check
            if (window.puter) {
                try {
                    const resp = await puter.auth.getUser();
                    if (resp.user) handleLoginSuccess(resp.user);
                } catch (e) { console.log("Guest Mode Active"); }
            }

            document.body.addEventListener('click', initAudio, { once: true });
            
            // Set default video
            video.src = 'https://assets.mixkit.co/videos/preview/mixkit-stars-in-space-1610-large.mp4'; // Fallback space video
            video.onerror = () => { console.log("Video load error, using solid color"); };
            renderPreview();

            // Init Browser Voices
            initBrowserVoices();
            if(window.speechSynthesis.onvoiceschanged !== undefined) {
                window.speechSynthesis.onvoiceschanged = initBrowserVoices;
            }
        };

        function initAudio() {
            if (!STATE.audioCtx) STATE.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (STATE.audioCtx.state === 'suspended') STATE.audioCtx.resume();
        }

        // --- BROWSER VOICES ---
        function initBrowserVoices() {
            STATE.browserVoices = window.speechSynthesis.getVoices();
            const select = document.getElementById('browserVoiceSelect');
            select.innerHTML = '';
            
            STATE.browserVoices.forEach((v, i) => {
                const opt = document.createElement('option');
                opt.value = i;
                opt.text = `${v.name} (${v.lang})`;
                if(v.default) opt.selected = true;
                select.appendChild(opt);
            });

            // Show/Hide selector based on setting
            const isBrowser = document.getElementById('ttsProvider').value === 'browser';
            document.getElementById('browserVoiceContainer').classList.toggle('hidden', !isBrowser);
        }

        // --- UI LOGIC ---
        function toggleSettings() {
            const modal = document.getElementById('settingsModal');
            modal.classList.toggle('open');
        }

        function updateSettingsUI() {
            const gen = document.getElementById('genProvider').value;
            const tts = document.getElementById('ttsProvider').value;
            
            // Toggle Keys
            document.querySelectorAll('.provider-key').forEach(el => el.classList.add('hidden'));
            if(gen === 'gemini' || tts === 'gemini') document.getElementById('key-gemini').classList.remove('hidden');
            if(gen === 'groq') document.getElementById('key-groq').classList.remove('hidden');
            if(gen === 'openai') document.getElementById('key-openai').classList.remove('hidden');

            // Toggle Voice Selector
            document.getElementById('browserVoiceContainer').classList.toggle('hidden', tts !== 'browser');
            
            document.getElementById('ttsProviderLabel').innerText = `Provider: ${tts.toUpperCase()}`;
        }

        function saveSettings() {
            const oldVersion = SETTINGS.puterVersion;
            
            SETTINGS.genProvider = document.getElementById('genProvider').value;
            SETTINGS.ttsProvider = document.getElementById('ttsProvider').value;
            SETTINGS.puterVersion = document.getElementById('puterVersionSelector').value;
            SETTINGS.keys.gemini = document.getElementById('geminiKey').value;
            SETTINGS.keys.groq = document.getElementById('groqKey').value;
            SETTINGS.keys.openai = document.getElementById('openaiKey').value;
            
            localStorage.setItem('dingle_settings_v4', JSON.stringify(SETTINGS));
            localStorage.setItem('puter_version', SETTINGS.puterVersion); // For the head script

            showToast("Settings Saved", 'success');
            toggleSettings();
            updateSettingsUI();

            if(oldVersion !== SETTINGS.puterVersion) {
                setTimeout(() => location.reload(), 500);
            }
        }

        function loadSettingsLocal() {
            const raw = localStorage.getItem('dingle_settings_v4');
            if(raw) {
                SETTINGS = JSON.parse(raw);
                document.getElementById('genProvider').value = SETTINGS.genProvider;
                document.getElementById('ttsProvider').value = SETTINGS.ttsProvider;
                document.getElementById('puterVersionSelector').value = localStorage.getItem('puter_version') || 'v2';
                document.getElementById('geminiKey').value = SETTINGS.keys.gemini || '';
                document.getElementById('groqKey').value = SETTINGS.keys.groq || '';
                document.getElementById('openaiKey').value = SETTINGS.keys.openai || '';
            }
        }

        function handleLoginSuccess(user) {
            STATE.user = user;
            document.getElementById('authContainer').innerHTML = `<span class="text-[10px] font-bold text-emerald-400 mr-2 border border-emerald-900 bg-emerald-900/30 px-2 py-1 rounded">${user.username}</span>`;
            const saveBtn = document.getElementById('saveBtn');
            saveBtn.disabled = false; 
            saveBtn.classList.replace('bg-slate-800','bg-emerald-600'); 
            saveBtn.classList.replace('text-slate-600','text-white'); 
            saveBtn.classList.remove('cursor-not-allowed');
        }

        async function loginPuter() {
            try { const user = await puter.auth.signIn(); handleLoginSuccess(user); } catch (e) { showToast("Login Failed", 'error'); }
        }

        // --- AI GENERATION ---
        async function generateAIScript() {
            const btn = document.getElementById('aiBtn');
            const original = btn.innerHTML;
            btn.innerHTML = 'Thinking...'; btn.disabled = true;
            const topic = document.getElementById('topicInput').value;
            const prompt = `Write a viral short script about: ${topic}. Style: Reddit Story. Max 100 words. Hook first sentence. No bolding.`;
            
            try {
                let text = "";
                const p = SETTINGS.genProvider;

                if (p === 'puter') {
                    if(!STATE.user) { 
                        // Guest mode attempt
                         try { text = await puter.ai.chat(prompt); } 
                         catch(e){ throw new Error("Login required for Puter AI"); }
                    } else {
                        text = await puter.ai.chat(prompt);
                    }
                } else if (p === 'gemini') {
                    if(!SETTINGS.keys.gemini) throw new Error("Missing Gemini Key");
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${SETTINGS.keys.gemini}`, {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    const data = await res.json();
                    text = data.candidates[0].content.parts[0].text;
                }
                // (Groq/OpenAI logic omitted for brevity, essentially same fetch structure)

                document.getElementById('scriptText').value = typeof text === 'string' ? text : JSON.stringify(text);
                showToast(`Generated via ${p.toUpperCase()}`, 'success');
            } catch(e) { showToast(e.message, 'error'); }
            btn.innerHTML = original; btn.disabled = false;
        }

        // --- AUDIO SYNTHESIS ---
        async function synthesizeAudio() {
            const text = document.getElementById('scriptText').value;
            if(!text) return showToast("No Script Text", 'error');

            const btn = document.getElementById('synthBtn');
            const original = btn.innerHTML;
            btn.innerHTML = 'Synthesizing...'; btn.disabled = true;
            
            const p = SETTINGS.ttsProvider;

            try {
                let buffer = null;

                if (p === 'browser') {
                    // --- BROWSER NATIVE TTS ---
                    const u = new SpeechSynthesisUtterance(text);
                    const voices = window.speechSynthesis.getVoices();
                    const selectedIdx = document.getElementById('browserVoiceSelect').value;
                    u.voice = voices[selectedIdx] || voices[0];
                    u.rate = parseFloat(document.getElementById('voiceSpeed').value);
                    
                    // Sadly, Browser TTS doesn't give us a buffer easily.
                    // We will just calculate timing based on estimated rate for the preview
                    // and use real-time playback for the preview.
                    STATE.ttsBuffer = null; // Mark as null to trigger realtime mode
                    STATE.guestDuration = (text.split(' ').length / (u.rate * 3)) + 2; // rough estimate
                    
                    // We store the utterance to play it later
                    STATE.currentUtterance = u;
                    showToast("Ready (Browser Voice)", 'success');

                } else if (p === 'gemini') {
                    // --- GEMINI TTS ---
                    if(!SETTINGS.keys.gemini) throw new Error("Gemini Key required");
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${SETTINGS.keys.gemini}`, {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ 
                            contents: [{ parts: [{ text: text }] }], 
                            generationConfig: { responseModalities: ["AUDIO"], speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: STATE.voice } } } } 
                        })
                    });
                    const data = await res.json();
                    const binaryString = atob(data.candidates[0].content.parts[0].inlineData.data);
                    const bytes = new Uint8Array(binaryString.length);
                    for (let i = 0; i < binaryString.length; i++) bytes[i] = binaryString.charCodeAt(i);
                    initAudio();
                    buffer = await STATE.audioCtx.decodeAudioData(bytes.buffer);
                    STATE.ttsBuffer = buffer;
                    STATE.currentUtterance = null;
                } else if (p === 'puter') {
                    // --- PUTER TTS ---
                    const audio = await puter.ai.txt2speech(text);
                    const res = await fetch(audio.src);
                    const arr = await res.arrayBuffer();
                    initAudio();
                    buffer = await STATE.audioCtx.decodeAudioData(arr);
                    STATE.ttsBuffer = buffer;
                    STATE.currentUtterance = null;
                }

                // Timing Calculation for Words
                const totalDur = STATE.ttsBuffer ? STATE.ttsBuffer.duration : STATE.guestDuration * 1.5; // *1.5 padding for browser tts
                const sentences = text.match(/[^.!?]+[.!?]+/g) || [text];
                let charCount = text.length;
                let currentTime = 0;
                STATE.words = [];
                sentences.forEach(sent => {
                    const sentDur = (sent.length / charCount) * totalDur;
                    const sentWords = sent.trim().split(/\s+/);
                    const wordDur = sentDur / sentWords.length;
                    sentWords.forEach(w => {
                        STATE.words.push({ word: w, start: currentTime, end: currentTime + wordDur });
                        currentTime += wordDur;
                    });
                });

                if(p !== 'browser') showToast(`Audio Generated`, 'success');

            } catch(e) { showToast("TTS Error: " + e.message, 'error'); }
            btn.innerHTML = original; btn.disabled = false;
        }

        // --- PLAYBACK ---
        function togglePlay() { STATE.isPlaying ? stop() : play(); }
        
        function play() {
            initAudio(); 
            STATE.sourceNodes = []; 
            STATE.startTime = STATE.audioCtx.currentTime;

            // Handle Audio
            if (STATE.currentUtterance) {
                // Browser TTS Mode
                window.speechSynthesis.cancel();
                window.speechSynthesis.speak(STATE.currentUtterance);
                STATE.startTime = STATE.audioCtx.currentTime; // approximate
            } else if (STATE.ttsBuffer) {
                // Buffer Mode
                const n = STATE.audioCtx.createBufferSource(); 
                n.buffer = STATE.ttsBuffer; 
                n.playbackRate.value = parseFloat(document.getElementById('voiceSpeed').value); 
                n.connect(STATE.audioCtx.destination); 
                n.start(0); 
                n.onended = ()=>{if(STATE.isPlaying) stop()}; 
                STATE.sourceNodes.push(n);
            } else {
                showToast("Generating Visual Only", 'success');
                STATE.guestDuration = 10; // Default
            }

            // Background Music
            if(STATE.bgBuffer) { 
                const n = STATE.audioCtx.createBufferSource(); 
                n.buffer=STATE.bgBuffer; n.loop=true; 
                const g=STATE.audioCtx.createGain(); 
                g.gain.value=document.getElementById('musicVol').value; 
                n.connect(g).connect(STATE.audioCtx.destination); 
                n.start(0); 
                STATE.sourceNodes.push(n); 
            }

            video.currentTime=0; 
            video.play(); 
            STATE.isPlaying=true; 
            document.getElementById('playBtn').innerHTML='<i data-lucide="square" class="w-4 h-4"></i> STOP'; 
            document.getElementById('playBtn').classList.replace('bg-blue-600', 'bg-red-600');
            animate();
        }

        function stop() { 
            STATE.sourceNodes.forEach(n=>{try{n.stop()}catch(e){}}); 
            if(STATE.currentUtterance) window.speechSynthesis.cancel();
            
            video.pause(); 
            STATE.isPlaying=false; 
            cancelAnimationFrame(STATE.animationId); 
            document.getElementById('playBtn').innerHTML='<i data-lucide="play" class="w-4 h-4"></i> PREVIEW'; 
            document.getElementById('playBtn').classList.replace('bg-red-600', 'bg-blue-600');
            renderPreview(); 
        }

        function animate() {
            if(!STATE.isPlaying) return;
            const speed = (STATE.ttsBuffer || STATE.currentUtterance) ? parseFloat(document.getElementById('voiceSpeed').value) : 1.0;
            const elapsed = (STATE.audioCtx.currentTime - STATE.startTime) * speed;
            
            // Auto stop logic
            const max = STATE.ttsBuffer ? STATE.ttsBuffer.duration : STATE.guestDuration;
            if(!STATE.currentUtterance && elapsed > max) { stop(); return; }

            drawFrame(elapsed);
            STATE.animationId = requestAnimationFrame(animate);
        }

        function drawFrame(time) {
            // Background
            const aspect = video.videoWidth/video.videoHeight; const cAspect = canvas.width/canvas.height;
            let dw,dh,dx,dy; if(aspect>cAspect){dh=canvas.height; dw=dh*aspect; dx=(canvas.width-dw)/2; dy=0;}else{dw=canvas.width; dh=dw/aspect; dx=0; dy=(canvas.height-dh)/2;}
            ctx.drawImage(video,dx,dy,dw,dh);
            
            // Dim
            ctx.fillStyle='rgba(0,0,0,0.4)'; ctx.fillRect(0,0,canvas.width,canvas.height);
            
            // Text
            const active = STATE.words.find(w=>time>=w.start && time<w.end) || STATE.words[STATE.words.length-1];
            if(active && time < (STATE.ttsBuffer ? STATE.ttsBuffer.duration : 100)) {
                ctx.font = '900 70px "Montserrat"'; ctx.textAlign='center';
                const y = canvas.height/2 + parseInt(document.getElementById('textY').value);
                const w = active.word.toUpperCase().replace(/[^A-Z0-9\']/g,'');
                
                // Stroke
                ctx.lineJoin='round'; ctx.lineWidth=20; ctx.strokeStyle='black'; 
                ctx.strokeText(w,canvas.width/2,y);
                
                // Highlight logic (roughly centered word gets highlight)
                ctx.fillStyle = document.getElementById('textColor').value;
                ctx.fillText(w,canvas.width/2,y);
            }
        }

        function renderPreview() { 
            if(!STATE.isPlaying){ 
                ctx.fillStyle='#0f172a'; ctx.fillRect(0,0,canvas.width,canvas.height); 
                ctx.font='900 80px "Montserrat"'; ctx.fillStyle='#334155'; ctx.textAlign='center'; 
                ctx.fillText("PREVIEW",canvas.width/2,canvas.height/2); 
            } 
        }

        // --- UTILS ---
        function setBgMode(mode) {
            if(mode === 'minecraft') {
                video.src='https://assets.mixkit.co/videos/preview/mixkit-stars-in-space-1610-large.mp4';
            }
        }
        function handleMusicUpload(el) { 
            if(el.files[0]){
                const r=new FileReader(); 
                r.onload=async e=>{
                    initAudio(); 
                    STATE.bgBuffer=await STATE.audioCtx.decodeAudioData(e.target.result); 
                    document.getElementById('musicName').innerText=el.files[0].name;
                }; 
                r.readAsArrayBuffer(el.files[0]);
            }
        }
        function handleVideoUpload(f) { if(f) video.src=URL.createObjectURL(f); }
        async function fetchReddit() {
            const btn = document.querySelector('button[onclick="fetchReddit()"]');
            btn.innerHTML = '...'; btn.disabled = true;
            try {
                const sub = 'confessions';
                const res = await fetch(`https://www.reddit.com/r/${sub}/top.json?limit=15&t=day`);
                const json = await res.json();
                const posts = json.data.children.filter(p => p.data.selftext.length > 50 && p.data.selftext.length < 800);
                const post = posts[Math.floor(Math.random() * posts.length)]?.data;
                
                if(post){ 
                    document.getElementById('topicInput').value = `r/${sub}`; 
                    document.getElementById('scriptText').value = post.selftext; 
                    showToast('Fetched Viral Post', 'success'); 
                } else { showToast('No good posts found', 'error'); }
            } catch(e){ showToast('Reddit API Error', 'error'); }
            btn.innerHTML = '<i data-lucide="flame" class="w-3 h-3"></i> Viral Post'; btn.disabled = false;
        }
        function showToast(msg, type) { 
            const t=document.getElementById('toast'); 
            t.innerHTML = type === 'error' ? `<i data-lucide="alert-circle" class="w-4 h-4 text-red-400"></i> ${msg}` : `<i data-lucide="check-circle" class="w-4 h-4 text-emerald-400"></i> ${msg}`;
            lucide.createIcons();
            t.style.opacity=1; t.style.transform='translateX(0)'; 
            setTimeout(()=>{t.style.opacity=0; t.style.transform='translateX(20px)'},3000); 
        }
    </script>
</body>
</html>
