<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ViralGen Creator Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@800;900&family=Roboto:wght@700&family=Anton&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #020617; color: white; }
        .font-montserrat { font-family: 'Montserrat', sans-serif; }
        .font-roboto { font-family: 'Roboto', sans-serif; }
        .font-anton { font-family: 'Anton', sans-serif; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        .glass-panel {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .custom-range {
            -webkit-appearance: none;
            background: transparent;
        }
        .custom-range::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 14px;
            width: 14px;
            border-radius: 50%;
            background: #a855f7;
            margin-top: -5px;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(168, 85, 247, 0.4);
        }
        .custom-range::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #334155;
            border-radius: 2px;
        }
        
        .recording-pulse {
            animation: pulse-red 2s infinite;
        }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
    </style>
</head>
<body class="h-screen flex flex-col md:flex-row overflow-hidden selection:bg-purple-500 selection:text-white">

    <!-- Sidebar -->
    <div id="sidebar" class="w-full md:w-[420px] flex flex-col border-r border-gray-800 bg-[#0B0F19] z-30 shadow-2xl h-full transition-all duration-300">
        
        <!-- Header -->
        <div class="p-5 border-b border-gray-800 bg-[#0B0F19] flex justify-between items-center shrink-0">
            <div>
                <h1 class="text-lg font-black italic tracking-tighter bg-clip-text text-transparent bg-gradient-to-r from-purple-400 to-pink-500 flex items-center gap-2">
                    <i data-lucide="clapperboard" class="w-5 h-5 text-purple-400"></i> VIRALGEN STUDIO
                </h1>
                <p class="text-[9px] text-gray-500 font-mono mt-0.5">V4.1 | FIXED RECORDING</p>
            </div>
            <button onclick="window.location.reload()" class="text-xs text-gray-600 hover:text-white transition-colors" title="Reset Tool">
                <i data-lucide="rotate-ccw" class="w-4 h-4"></i>
            </button>
        </div>

        <!-- Scrollable Controls -->
        <div class="flex-1 overflow-y-auto p-5 space-y-5">

            <!-- API Key -->
            <div class="space-y-2">
                <label class="text-[10px] font-bold text-gray-400 uppercase tracking-wider flex items-center gap-1">
                    <i data-lucide="key" class="w-3 h-3"></i> Google API Key
                </label>
                <input id="apiKey" type="password" class="w-full bg-gray-800/50 border border-gray-700 rounded-lg px-3 py-2 text-xs focus:outline-none focus:border-purple-500 transition-colors placeholder-gray-600" placeholder="Paste Gemini Key (Required)">
            </div>

            <!-- Story Panel -->
            <div class="glass-panel rounded-xl p-4 space-y-3">
                <label class="text-xs font-bold text-purple-300 uppercase tracking-wider flex items-center gap-2">
                    <i data-lucide="pen-tool" class="w-3 h-3"></i> 1. Script
                </label>
                <div class="flex gap-2">
                    <input id="topicInput" type="text" value="r/confessions" class="flex-1 bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-xs focus:outline-none focus:border-purple-500" placeholder="Topic">
                    <button onclick="generateScript()" id="scriptBtn" class="bg-purple-600 hover:bg-purple-500 text-white px-3 rounded-lg font-bold text-xs transition-colors">Generate</button>
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-[10px] text-gray-400">Len:</span>
                    <input type="range" id="lengthSlider" min="50" max="300" value="130" step="10" class="custom-range flex-1">
                    <span id="lengthVal" class="text-[10px] text-gray-400 w-8">130w</span>
                </div>
                <textarea id="scriptText" rows="3" class="w-full bg-gray-900 border border-gray-700 rounded-lg p-2 text-xs focus:outline-none focus:border-purple-500 font-mono text-gray-300 resize-none" placeholder="Script..."></textarea>
            </div>

            <!-- Audio Panel -->
            <div class="glass-panel rounded-xl p-4 space-y-3">
                <label class="text-xs font-bold text-green-300 uppercase tracking-wider flex items-center gap-2">
                    <i data-lucide="mic-2" class="w-3 h-3"></i> 2. Audio
                </label>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="selectVoice('Puck')" id="voice-Puck" class="voice-btn bg-purple-600 border border-purple-400 rounded-lg py-1.5 text-xs font-bold">Puck (Male)</button>
                    <button onclick="selectVoice('Kore')" id="voice-Kore" class="voice-btn bg-gray-800 border border-gray-700 hover:bg-gray-700 rounded-lg py-1.5 text-xs font-bold">Kore (Female)</button>
                </div>
                <div class="flex items-center gap-2 pt-1">
                    <span class="text-[10px] text-gray-400 w-8">Speed</span>
                    <input type="range" id="speedSlider" min="0.8" max="1.5" step="0.05" value="1.0" class="custom-range flex-1">
                    <span id="speedVal" class="text-[10px] text-gray-400 w-8">1.0x</span>
                </div>
                <button onclick="generateAudio()" id="audioBtn" class="w-full bg-gray-800 hover:bg-gray-700 border border-gray-600 py-2 rounded-lg font-bold text-xs transition-all mt-1">
                    Generate TTS
                </button>
            </div>

            <!-- Visuals Panel -->
            <div class="glass-panel rounded-xl p-4 space-y-4">
                <label class="text-xs font-bold text-blue-300 uppercase tracking-wider flex items-center gap-2">
                    <i data-lucide="palette" class="w-3 h-3"></i> 3. Style
                </label>
                
                <!-- Background -->
                <select id="bgMode" onchange="toggleBgMode()" class="w-full bg-gray-900 border border-gray-700 rounded-lg px-2 py-1.5 text-xs">
                    <option value="upload">ðŸŽ¥ Upload Gameplay (mp4)</option>
                    <option value="tunnel">ðŸŒŒ 3D Tunnel</option>
                    <option value="particles">âœ¨ Particles</option>
                </select>
                <div id="videoUploadContainer" class="text-center">
                    <input type="file" id="bgVideoInput" accept="video/*" class="hidden">
                    <label for="bgVideoInput" class="block w-full border border-dashed border-gray-600 rounded-lg p-2 text-[10px] text-gray-400 cursor-pointer hover:bg-gray-800 hover:border-blue-500 transition-colors">
                        Click to Select Video File
                    </label>
                </div>

                <!-- Text Customization -->
                <div class="grid grid-cols-2 gap-x-4 gap-y-2 pt-2 border-t border-gray-700">
                    <div>
                        <label class="text-[9px] text-gray-400">Size</label>
                        <input type="range" id="textSizeSlider" min="2" max="6" step="0.5" value="3.5" class="custom-range w-full">
                    </div>
                    <div>
                        <label class="text-[9px] text-gray-400">Shadow</label>
                        <input type="range" id="textShadowSlider" min="0" max="20" step="1" value="4" class="custom-range w-full">
                    </div>
                    <div>
                        <label class="text-[9px] text-gray-400">Position Y</label>
                        <input type="range" id="textPosSlider" min="-20" max="20" step="1" value="0" class="custom-range w-full">
                    </div>
                     <div>
                        <label class="text-[9px] text-gray-400">Color</label>
                        <div class="flex gap-1">
                             <input type="color" id="textColor" value="#ffffff" class="w-6 h-4 bg-transparent border-0 cursor-pointer p-0">
                             <input type="color" id="highlightColor" value="#fbbf24" class="w-6 h-4 bg-transparent border-0 cursor-pointer p-0">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer Actions -->
        <div class="p-4 border-t border-gray-800 bg-[#0B0F19] space-y-2 shrink-0">
            <div class="grid grid-cols-2 gap-2">
                <button onclick="togglePlayback()" id="playBtn" disabled class="bg-gray-800 text-gray-500 cursor-not-allowed py-3 rounded-lg font-black text-xs shadow-lg transition-all flex items-center justify-center gap-2">
                    <i data-lucide="play" class="w-3 h-3"></i> PREVIEW
                </button>
                
                <!-- Replaced Auto-Record with Cinema Mode -->
                <button onclick="toggleCinemaMode()" id="recordBtn" disabled class="bg-gray-800 text-gray-500 cursor-not-allowed py-3 rounded-lg font-black text-xs shadow-lg transition-all flex items-center justify-center gap-2">
                    <i data-lucide="monitor" class="w-3 h-3"></i> CINEMA MODE
                </button>
            </div>
            <div id="statusText" class="text-[9px] text-center text-gray-500 font-mono h-3">Ready</div>
        </div>
    </div>

    <!-- Preview Area -->
    <div class="flex-1 bg-black relative flex justify-center items-center overflow-hidden bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]">
        
        <!-- Background Layer -->
        <div id="visual-container" class="absolute inset-0 z-0 flex items-center justify-center">
            <div id="canvas-container" class="absolute inset-0 w-full h-full"></div>
            <video id="bgVideoPlayer" class="absolute inset-0 w-full h-full object-cover hidden" loop muted playsinline></video>
        </div>

        <!-- Phone Frame -->
        <div id="phoneFrame" class="relative w-[340px] h-[680px] z-10 transition-all duration-300">
            <!-- Overlay Content (Captions) -->
            <div class="absolute inset-0 flex flex-col pointer-events-none z-20">
                
                <!-- Top Spacer -->
                <div class="h-1/4"></div>

                <!-- Caption Container -->
                <div class="flex-1 flex items-center justify-center px-6">
                    <div id="captionBox" class="text-4xl font-montserrat font-black text-center text-white leading-tight transition-transform duration-75 drop-shadow-xl select-none" style="text-shadow: 2px 2px 0 #000;">
                        <!-- Text -->
                    </div>
                </div>

                <!-- Bottom Spacer / Progress -->
                <div class="h-1/4 flex flex-col justify-end pb-12 px-8">
                     <div class="h-1.5 bg-white/20 rounded-full overflow-hidden backdrop-blur-sm">
                        <div id="progressBar" class="h-full bg-white w-0 shadow-[0_0_10px_white]"></div>
                     </div>
                </div>
            </div>

            <!-- Phone Bezel (Click through) -->
            <div class="absolute inset-0 border-[6px] border-gray-900 rounded-[3rem] pointer-events-none shadow-2xl"></div>
             <!-- Notch -->
            <div class="absolute top-0 left-1/2 -translate-x-1/2 w-32 h-6 bg-black rounded-b-xl z-30"></div>
        </div>

        <!-- Exit Cinema Button (Hidden by default) -->
        <button id="exitCinemaBtn" onclick="toggleCinemaMode()" class="hidden absolute top-4 right-4 bg-red-600 hover:bg-red-500 text-white px-4 py-2 rounded-lg font-bold text-xs shadow-lg z-50">
            EXIT CINEMA MODE
        </button>

    </div>

    <!-- Hidden Audio -->
    <audio id="speechPlayer" class="hidden"></audio>

    <script>
        lucide.createIcons();

        // --- Core State ---
        let audioBlob = null;
        let isPlaying = false;
        let animationFrame;
        let selectedVoice = "Puck";
        let wordMeta = []; // The Smart Sync Data
        let isCinemaMode = false;
        
        // --- 3D Vars ---
        let scene, camera, renderer, meshGroup;

        // --- Customization Logic ---
        const els = {
            captionBox: document.getElementById('captionBox'),
            speedSlider: document.getElementById('speedSlider'),
            speedVal: document.getElementById('speedVal'),
            lengthSlider: document.getElementById('lengthSlider'),
            lengthVal: document.getElementById('lengthVal'),
            textSize: document.getElementById('textSizeSlider'),
            textShadow: document.getElementById('textShadowSlider'),
            textPos: document.getElementById('textPosSlider'),
            textColor: document.getElementById('textColor'),
            highlightColor: document.getElementById('highlightColor'),
        };

        els.speedSlider.oninput = function() { els.speedVal.innerText = this.value + 'x'; };
        els.lengthSlider.oninput = function() { els.lengthVal.innerText = this.value + 'w'; };
        els.textSize.oninput = function() { els.captionBox.style.fontSize = this.value + 'rem'; };
        els.textShadow.oninput = function() { 
            const val = this.value;
            els.captionBox.style.textShadow = `${val}px ${val}px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000`; 
        };
        els.textPos.oninput = function() { els.captionBox.style.transform = `translateY(${this.value * 2}px)`; };
        els.textColor.oninput = function() { els.captionBox.style.color = this.value; };

        // --- Video Upload ---
        document.getElementById('bgVideoInput').onchange = function(e) {
            const file = e.target.files[0];
            if(file){
                const url = URL.createObjectURL(file);
                const vid = document.getElementById('bgVideoPlayer');
                vid.src = url;
                vid.play();
                document.getElementById('bgMode').value = 'upload';
                toggleBgMode();
            }
        };

        function setStatus(msg, type='normal') {
            const el = document.getElementById('statusText');
            el.innerText = msg;
            el.className = `text-[9px] text-center font-mono h-3 ${type==='error'?'text-red-500':'text-gray-500'}`;
        }

        // --- 1. Script Generation ---
        async function generateScript() {
            const apiKey = document.getElementById('apiKey').value;
            if(!apiKey) return alert("API Key Missing!");
            
            const btn = document.getElementById('scriptBtn');
            btn.innerHTML = '...';
            btn.disabled = true;

            try {
                const prompt = `Write a script for a viral short video about "${document.getElementById('topicInput').value}".
                Style: Reddit Story / Confession.
                Length: ~${els.lengthSlider.value} words.
                Format: Pure text only. No bold, no formatting, no title.
                Structure: Dramatic hook -> Twist -> Cliffhanger.`;

                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await res.json();
                document.getElementById('scriptText').value = data.candidates[0].content.parts[0].text;
                setStatus("Script Generated");
            } catch(e) {
                setStatus("Script Error", "error");
                console.error(e);
            }
            btn.innerHTML = 'Generate';
            btn.disabled = false;
        }

        // --- 2. Audio Generation + SMART SYNC ENGINE V2 ---
        function selectVoice(v) {
            selectedVoice = v;
            document.querySelectorAll('.voice-btn').forEach(b => {
                b.classList.remove('bg-purple-600', 'border-purple-400');
                b.classList.add('bg-gray-800', 'border-gray-700');
            });
            const active = document.getElementById(`voice-${v}`);
            active.classList.remove('bg-gray-800', 'border-gray-700');
            active.classList.add('bg-purple-600', 'border-purple-400');
        }

        async function generateAudio() {
            const apiKey = document.getElementById('apiKey').value;
            const text = document.getElementById('scriptText').value;
            if(!apiKey || !text) return alert("Missing Key or Text");

            const btn = document.getElementById('audioBtn');
            btn.innerText = "Synthesizing...";
            btn.disabled = true;

            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: text }] }],
                        generationConfig: {
                            responseModalities: ["AUDIO"],
                            speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: selectedVoice } } }
                        }
                    })
                });
                const data = await res.json();
                
                // Decode Audio
                const binary = atob(data.candidates[0].content.parts[0].inlineData.data);
                const bytes = new Uint8Array(binary.length);
                for(let i=0; i<binary.length; i++) bytes[i] = binary.charCodeAt(i);
                
                // Convert to WAV
                const wavBuffer = pcmToWav(bytes, 24000);
                audioBlob = new Blob([wavBuffer], { type: 'audio/wav' });
                
                const audio = document.getElementById('speechPlayer');
                audio.src = URL.createObjectURL(audioBlob);

                // --- SYNC ENGINE V2 ---
                const cleanText = text.replace(/\n/g, " ");
                const words = cleanText.split(" ").filter(w => w.length > 0);
                
                let totalWeight = 0;
                const wordWeights = words.map(w => {
                    let weight = w.length; // Base weight (1 per char)
                    if (w.includes(',') || w.includes(';')) weight += 5; // Comma pause
                    else if (w.includes('.') || w.includes('!') || w.includes('?')) weight += 10; // Period pause
                    totalWeight += weight;
                    return { word: w, weight: weight };
                });

                let weightAccumulator = 0;
                wordMeta = wordWeights.map(item => {
                    weightAccumulator += item.weight;
                    return {
                        word: item.word,
                        endPerc: weightAccumulator / totalWeight
                    };
                });

                audio.onloadedmetadata = () => {
                    document.getElementById('playBtn').disabled = false;
                    document.getElementById('playBtn').classList.remove('cursor-not-allowed', 'text-gray-500');
                    document.getElementById('playBtn').classList.add('text-white', 'hover:bg-gray-700');
                    
                    document.getElementById('recordBtn').disabled = false;
                    document.getElementById('recordBtn').classList.remove('cursor-not-allowed', 'text-gray-500');
                    document.getElementById('recordBtn').classList.add('text-white', 'bg-blue-600', 'hover:bg-blue-500');
                    
                    setStatus("Audio Ready");
                    btn.innerText = "Generate TTS";
                    btn.disabled = false;
                };

            } catch(e) {
                console.error(e);
                setStatus("TTS Error", "error");
                btn.innerText = "Generate TTS";
                btn.disabled = false;
            }
        }

        // --- 3. Playback & Cinema Mode ---
        function togglePlayback() {
            const btn = document.getElementById('playBtn');
            if (isPlaying) {
                stopAll();
                btn.innerHTML = '<i data-lucide="play" class="w-3 h-3"></i> PREVIEW';
                btn.classList.remove('text-red-400');
            } else {
                startAll();
                btn.innerHTML = '<i data-lucide="square" class="w-3 h-3"></i> STOP';
                btn.classList.add('text-red-400');
            }
            lucide.createIcons();
        }

        function toggleCinemaMode() {
            const sidebar = document.getElementById('sidebar');
            const btn = document.getElementById('recordBtn');
            const exitBtn = document.getElementById('exitCinemaBtn');
            
            isCinemaMode = !isCinemaMode;

            if(isCinemaMode) {
                sidebar.classList.add('hidden');
                exitBtn.classList.remove('hidden');
                btn.innerHTML = 'EXIT CINEMA';
                // Automatically start playing if not already
                if(!isPlaying) togglePlayback();
            } else {
                sidebar.classList.remove('hidden');
                exitBtn.classList.add('hidden');
                btn.innerHTML = '<i data-lucide="monitor" class="w-3 h-3"></i> CINEMA MODE';
            }
            lucide.createIcons();
        }

        function startAll() {
            const audio = document.getElementById('speechPlayer');
            const vid = document.getElementById('bgVideoPlayer');
            const bgMode = document.getElementById('bgMode').value;
            
            // Apply Speed
            audio.playbackRate = parseFloat(document.getElementById('speedSlider').value);
            
            audio.play();
            if(bgMode === 'upload') vid.play();
            else init3D(); // Ensure 3D is running

            isPlaying = true;
            animate();
        }

        function stopAll() {
            const audio = document.getElementById('speechPlayer');
            const vid = document.getElementById('bgVideoPlayer');
            
            audio.pause();
            audio.currentTime = 0;
            vid.pause();
            
            isPlaying = false;
            cancelAnimationFrame(animationFrame);
            
            document.getElementById('captionBox').innerText = "";
            document.getElementById('progressBar').style.width = "0%";
        }

        function animate() {
            if (!isPlaying) return;

            const audio = document.getElementById('speechPlayer');
            
            // Progress 0 to 1
            const progress = audio.currentTime / audio.duration;
            
            // Sync Logic
            const currentItem = wordMeta.find(m => progress <= m.endPerc);
            
            if (currentItem) {
                const rawWord = currentItem.word;
                const cleanWord = rawWord.replace(/[^a-zA-Z0-9]/g, "");
                const box = els.captionBox;

                if (box.innerText !== rawWord.toUpperCase()) {
                    box.innerText = rawWord.toUpperCase();
                    
                    // Highlight High-Impact Words
                    const isHighlight = cleanWord.length > 6 || 
                        ['WHAT', 'WHY', 'NO', 'STOP', 'DIED', 'KILLED', 'SECRET', 'MONEY', 'WTF'].includes(cleanWord.toUpperCase());
                    
                    box.style.color = isHighlight ? els.highlightColor.value : els.textColor.value;
                    box.style.transform = isHighlight ? `translateY(${els.textPos.value*2}px) scale(1.1)` : `translateY(${els.textPos.value*2}px) scale(1)`;
                }
            }

            document.getElementById('progressBar').style.width = `${progress * 100}%`;

            // Background Animation
            if(document.getElementById('bgMode').value !== 'upload') animate3D();

            if (audio.ended) {
                stopAll();
                // If we were in cinema mode, maybe we want to keep it open, or loop?
                // For now, just stop.
            } else {
                animationFrame = requestAnimationFrame(animate);
            }
        }

        // --- 3D Backgrounds ---
        function toggleBgMode() {
            const mode = document.getElementById('bgMode').value;
            const up = document.getElementById('videoUploadContainer');
            const vid = document.getElementById('bgVideoPlayer');
            const can = document.getElementById('canvas-container');
            
            up.style.display = mode === 'upload' ? 'block' : 'none';
            vid.classList.toggle('hidden', mode !== 'upload');
            can.classList.toggle('hidden', mode === 'upload');

            if(mode !== 'upload') init3D();
        }

        function init3D() {
            const container = document.getElementById('canvas-container');
            const mode = document.getElementById('bgMode').value;
            if(mode === 'upload') return;

            container.innerHTML = '';
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ alpha: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            container.appendChild(renderer.domElement);

            if (mode === 'tunnel') {
                const geo = new THREE.BoxGeometry(1, 1, 1);
                const mat = new THREE.MeshBasicMaterial({ color: 0x8b5cf6, wireframe: true });
                meshGroup = new THREE.Group();
                for(let i=0; i<150; i++) {
                    const m = new THREE.Mesh(geo, mat);
                    m.position.set(Math.sin(i)*2, Math.cos(i)*2, -i);
                    m.rotation.z = i;
                    meshGroup.add(m);
                }
                camera.position.z = 5;
            } else {
                const geo = new THREE.BufferGeometry();
                const verts = [];
                for(let i=0; i<2000; i++) verts.push((Math.random()-0.5)*10, (Math.random()-0.5)*10, (Math.random()-0.5)*10);
                geo.setAttribute('position', new THREE.Float32BufferAttribute(verts, 3));
                const mat = new THREE.PointsMaterial({ color: 0xffffff, size: 0.05 });
                meshGroup = new THREE.Points(geo, mat);
                camera.position.z = 2;
            }
            scene.add(meshGroup);
        }

        function animate3D() {
            if(!meshGroup) return;
            const mode = document.getElementById('bgMode').value;
            if (mode === 'tunnel') {
                camera.position.z -= 0.1;
                if(camera.position.z < -50) camera.position.z = 5;
                meshGroup.rotation.z += 0.002;
            } else {
                meshGroup.rotation.y += 0.005;
            }
            renderer.render(scene, camera);
        }

        // --- Wav Util ---
        function pcmToWav(samples, rate) {
            const b = new ArrayBuffer(44 + samples.length);
            const v = new DataView(b);
            const w = (o, s) => { for(let i=0; i<s.length; i++) v.setUint8(o+i, s.charCodeAt(i)); };
            w(0,'RIFF'); v.setUint32(4, 36+samples.length, true); w(8,'WAVE'); w(12,'fmt '); 
            v.setUint32(16, 16, true); v.setUint16(20, 1, true); v.setUint16(22, 1, true); 
            v.setUint32(24, rate, true); v.setUint32(28, rate*2, true); v.setUint16(32, 2, true); 
            v.setUint16(34, 16, true); w(36,'data'); v.setUint32(40, samples.length, true);
            new Uint8Array(b, 44).set(samples);
            return b;
        }

        // Init
        window.addEventListener('resize', () => {
             if(renderer && document.getElementById('canvas-container')) {
                 const c = document.getElementById('canvas-container');
                 renderer.setSize(c.clientWidth, c.clientHeight);
                 camera.aspect = c.clientWidth / c.clientHeight;
                 camera.updateProjectionMatrix();
             }
        });
        init3D();
    </script>
</body>
</html>
