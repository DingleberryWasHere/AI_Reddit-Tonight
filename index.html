<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dingle Studio | Enterprise</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #0f172a; overflow: hidden; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 2px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Minimal Range Slider */
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 14px; width: 14px; border-radius: 50%;
            background: #000; margin-top: -6px; cursor: pointer; border: 2px solid #fff;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 2px; cursor: pointer; background: #e2e8f0;
        }

        /* Canvas Container */
        .canvas-container {
            height: 85vh; aspect-ratio: 9/16; max-width: 100%; position: relative;
            background: #000; border: 1px solid #e2e8f0; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
        }

        /* Tab Transitions */
        .panel-section { display: none; }
        .panel-section.active { display: block; animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateX(-5px); } to { opacity: 1; transform: translateX(0); } }
        
        /* Loading Spinner */
        .loader { width: 16px; height: 16px; border: 2px solid #e2e8f0; border-top-color: #000; border-radius: 50%; animation: spin 0.6s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="h-screen w-screen flex flex-row">

    <nav class="w-16 h-full bg-white border-r border-gray-200 flex flex-col items-center py-6 z-40 shrink-0">
        <div class="mb-8 p-2 bg-black text-white rounded-lg">
            <i data-lucide="zap" class="w-5 h-5"></i>
        </div>

        <div class="space-y-4 w-full flex flex-col items-center">
            <button onclick="switchTab('studio')" id="nav-studio" class="nav-btn w-10 h-10 rounded-lg flex items-center justify-center text-gray-400 hover:text-black hover:bg-gray-50 transition-all active">
                <i data-lucide="layout-template" class="w-5 h-5"></i>
            </button>
            <button onclick="switchTab('projects')" id="nav-projects" class="nav-btn w-10 h-10 rounded-lg flex items-center justify-center text-gray-400 hover:text-black hover:bg-gray-50 transition-all">
                <i data-lucide="folder-open" class="w-5 h-5"></i>
            </button>
        </div>

        <div class="mt-auto flex flex-col gap-4">
             <button onclick="document.getElementById('settingsModal').classList.remove('hidden')" class="w-10 h-10 rounded-lg flex items-center justify-center text-gray-400 hover:text-black hover:bg-gray-50 transition-all">
                <i data-lucide="settings" class="w-5 h-5"></i>
            </button>
        </div>
    </nav>

    <div class="w-[400px] h-full bg-white border-r border-gray-200 flex flex-col z-30 shrink-0">
        
        <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center h-[70px]">
            <div>
                <h1 class="text-sm font-bold text-gray-900 tracking-tight" id="panelTitle">New Project</h1>
                <p class="text-[10px] text-gray-400 font-medium">Workspace</p>
            </div>
            <div class="flex gap-2">
                <button onclick="saveProject()" class="text-[10px] font-bold border border-gray-200 bg-gray-50 hover:bg-white px-3 py-1.5 rounded text-gray-600 transition-all flex items-center gap-1">
                    <i data-lucide="save" class="w-3 h-3"></i> SAVE
                </button>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto custom-scrollbar relative">
            
            <div id="tab-studio" class="panel-section active p-6 space-y-8">
                
                <section class="space-y-4">
                    <div class="flex items-center justify-between">
                        <label class="text-[11px] font-bold text-gray-400 uppercase tracking-wider">01. Narrative</label>
                        <div class="flex gap-1">
                            <button onclick="fetchReddit()" class="p-1.5 hover:bg-gray-100 rounded text-gray-500" title="Viral Fetch"><i data-lucide="flame" class="w-3.5 h-3.5"></i></button>
                            <button onclick="generateAI()" class="p-1.5 hover:bg-gray-100 rounded text-gray-500" title="AI Generate"><i data-lucide="sparkles" class="w-3.5 h-3.5"></i></button>
                        </div>
                    </div>
                    <div class="space-y-2">
                        <input id="topicInput" type="text" value="r/confessions" class="w-full bg-gray-50 border border-gray-200 rounded px-3 py-2 text-xs font-medium focus:bg-white focus:border-black outline-none transition-colors placeholder-gray-400" placeholder="Subject / Topic">
                        <textarea id="scriptText" rows="6" class="w-full bg-gray-50 border border-gray-200 rounded p-3 text-xs font-medium focus:bg-white focus:border-black outline-none transition-colors text-gray-700 resize-none leading-relaxed" placeholder="Script content..."></textarea>
                        <div class="flex justify-end">
                            <span id="wordCount" class="text-[10px] text-gray-300 font-mono">0 words</span>
                        </div>
                    </div>
                </section>

                <hr class="border-gray-100">

                <section class="space-y-4">
                    <label class="text-[11px] font-bold text-gray-400 uppercase tracking-wider">02. Audio Mix</label>
                    
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="selectVoice('Puck')" id="voice-Puck" class="voice-btn bg-black text-white py-2 text-xs font-bold rounded border border-transparent">Puck (M)</button>
                        <button onclick="selectVoice('Kore')" id="voice-Kore" class="voice-btn bg-white text-gray-500 py-2 text-xs font-bold rounded border border-gray-200 hover:border-gray-300">Kore (F)</button>
                    </div>

                    <div class="bg-gray-50 border border-gray-100 rounded p-3 space-y-3">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <button onclick="loadPresetAudio()" class="w-6 h-6 bg-gray-200 hover:bg-gray-300 rounded flex items-center justify-center text-gray-600 transition-colors"><i data-lucide="music" class="w-3 h-3"></i></button>
                                <span id="musicName" class="text-[10px] font-mono text-gray-400 truncate max-w-[120px]">No Music</span>
                            </div>
                            <input type="range" id="musicVol" min="0" max="1" step="0.1" value="0.2" class="w-16">
                        </div>
                    </div>

                    <button onclick="synthesizeAudio()" id="synthBtn" class="w-full bg-white border border-gray-200 hover:border-black text-gray-900 py-2.5 rounded text-xs font-bold transition-all flex justify-center items-center gap-2 shadow-sm">
                        <i data-lucide="refresh-cw" class="w-3 h-3"></i> Generate Audio
                    </button>
                </section>

                <hr class="border-gray-100">

                <section class="space-y-4">
                    <label class="text-[11px] font-bold text-gray-400 uppercase tracking-wider">03. Composition</label>
                    
                    <select id="bgMode" onchange="toggleBgMode()" class="w-full bg-white border border-gray-200 text-gray-900 text-xs font-bold rounded px-2 py-2 outline-none focus:border-black cursor-pointer">
                        <option value="minecraft">Gameplay: Minecraft</option>
                        <option value="upload">Custom Video</option>
                        <option value="solid">Solid Color</option>
                    </select>

                    <div id="uploadZone" class="hidden">
                         <input type="file" id="bgVideoInput" accept="video/*" class="hidden" onchange="handleVideoUpload(this.files[0])">
                         <button onclick="document.getElementById('bgVideoInput').click()" class="w-full border border-dashed border-gray-300 py-4 rounded text-[10px] font-bold text-gray-400 hover:border-gray-900 hover:text-gray-900 transition-colors">UPLOAD .MP4</button>
                    </div>

                    <div class="grid grid-cols-2 gap-2">
                        <div class="space-y-1">
                            <label class="text-[9px] font-bold text-gray-400 uppercase">Text</label>
                            <div class="flex items-center gap-2 border border-gray-200 rounded p-1 bg-white">
                                <input type="color" id="textColor" value="#ffffff" class="w-5 h-5 rounded cursor-pointer border-none p-0 bg-transparent">
                                <span class="text-[10px] font-mono text-gray-500">HEX</span>
                            </div>
                        </div>
                        <div class="space-y-1">
                            <label class="text-[9px] font-bold text-gray-400 uppercase">Accent</label>
                            <div class="flex items-center gap-2 border border-gray-200 rounded p-1 bg-white">
                                <input type="color" id="highlightColor" value="#fbbf24" class="w-5 h-5 rounded cursor-pointer border-none p-0 bg-transparent">
                                <span class="text-[10px] font-mono text-gray-500">HEX</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="space-y-1 pt-1">
                        <div class="flex justify-between text-[9px] font-bold text-gray-400 uppercase">
                            <span>Position Y</span>
                            <span id="yValDisplay">0</span>
                        </div>
                        <input type="range" id="textY" min="-300" max="300" value="0" class="w-full" oninput="renderPreview(); document.getElementById('yValDisplay').innerText = this.value">
                    </div>
                </section>

                <div class="h-12"></div> </div>

            <div id="tab-projects" class="panel-section p-6 space-y-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-xs font-bold uppercase tracking-wider text-gray-900">Archived Projects</h2>
                    <button onclick="clearAllProjects()" class="text-[10px] text-red-500 hover:underline">Clear All</button>
                </div>
                
                <div id="projectsList" class="space-y-3">
                    <div class="text-center py-10">
                        <p class="text-xs text-gray-400">No projects saved yet.</p>
                    </div>
                </div>
            </div>

        </div>

        <div class="p-4 border-t border-gray-200 bg-white grid grid-cols-2 gap-3 z-40">
            <button onclick="togglePlay()" id="playBtn" disabled class="bg-white border border-gray-200 text-gray-300 cursor-not-allowed py-3 rounded font-bold text-xs transition-all flex items-center justify-center gap-2 hover:border-gray-400">
                <i data-lucide="play" class="w-3.5 h-3.5"></i> PREVIEW
            </button>
            <button onclick="startExport()" id="exportBtn" disabled class="bg-black text-white opacity-50 cursor-not-allowed py-3 rounded font-bold text-xs transition-all flex items-center justify-center gap-2 hover:bg-gray-800">
                <i data-lucide="download" class="w-3.5 h-3.5"></i> EXPORT
            </button>
        </div>
    </div>

    <div class="flex-1 bg-gray-50 relative flex justify-center items-center p-8 bg-[url('https://www.transparenttextures.com/patterns/graphy.png')]">
        
        <div id="toast" class="fixed top-6 right-6 z-50 transition-all opacity-0 translate-y-[-10px] flex items-center gap-3 bg-white border border-gray-200 shadow-xl px-4 py-3 rounded-lg">
            <div id="toastIcon" class="w-2 h-2 rounded-full bg-black"></div>
            <span id="toastMsg" class="text-xs font-bold text-gray-800">Notification</span>
        </div>

        <div class="canvas-container" id="canvasWrapper">
            <canvas id="mainCanvas" class="w-full h-full object-contain"></canvas>
            <video id="bgVideo" class="absolute top-0 left-0 w-px h-px opacity-0 pointer-events-none" loop muted playsinline></video>
            
            <div id="exportOverlay" class="absolute inset-0 bg-white/95 backdrop-blur-sm z-50 flex flex-col items-center justify-center hidden">
                <div class="text-center space-y-4">
                    <div class="loader mx-auto"></div>
                    <div class="space-y-1">
                        <h3 class="font-bold text-gray-900 text-sm">RENDERING</h3>
                        <p id="renderTime" class="text-[10px] text-gray-500 font-mono">Initializing...</p>
                    </div>
                    <button onclick="cancelExport()" class="text-[10px] text-red-500 hover:underline font-bold">CANCEL OPERATION</button>
                </div>
            </div>
        </div>
    </div>

    <div id="settingsModal" class="fixed inset-0 bg-black/50 z-[100] hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded w-[400px] shadow-2xl p-6 space-y-4">
            <div class="flex justify-between items-center">
                <h3 class="font-bold text-sm">Engine Configuration</h3>
                <button onclick="document.getElementById('settingsModal').classList.add('hidden')" class="text-gray-400 hover:text-black"><i data-lucide="x" class="w-4 h-4"></i></button>
            </div>
            <div class="space-y-3">
                <label class="text-[10px] font-bold text-gray-400 uppercase">Gemini API Key</label>
                <input id="apiKey" type="password" class="w-full bg-gray-50 border border-gray-200 rounded px-3 py-2 text-xs font-mono" placeholder="AI Studio Key">
                
                <label class="text-[10px] font-bold text-gray-400 uppercase">Model Version</label>
                <select id="modelSelect" class="w-full bg-gray-50 border border-gray-200 rounded px-3 py-2 text-xs font-mono">
                    <option value="gemini-2.0-flash-exp">Gemini 2.0 Flash (Recommended)</option>
                    <option value="gemini-1.5-flash">Gemini 1.5 Flash</option>
                </select>
            </div>
            <button onclick="saveSettings()" class="w-full bg-black text-white py-2 rounded text-xs font-bold">Save Configuration</button>
        </div>
    </div>

    <script>
        // --- CORE STATE ---
        const CONFIG = { width: 1080, height: 1920 };
        let STATE = {
            voice: 'Puck',
            audioCtx: null,
            bgBuffer: null,
            ttsBuffer: null,
            words: [],
            isPlaying: false,
            isExporting: false,
            startTime: 0,
            animationId: null,
            sourceNodes: []
        };

        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d');
        const video = document.getElementById('bgVideo');

        // --- INIT ---
        window.onload = () => {
            lucide.createIcons();
            canvas.width = CONFIG.width; canvas.height = CONFIG.height;
            loadSettings();
            
            document.body.addEventListener('click', initAudio, { once: true });
            
            video.src = 'https://assets.mixkit.co/videos/preview/mixkit-stars-in-space-background-1610-large.mp4'; // Fallback / Default
            video.load();
            
            renderPreview();
            renderProjectsList(); // Load cookies/history
        };

        function initAudio() {
            if (!STATE.audioCtx) STATE.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (STATE.audioCtx.state === 'suspended') STATE.audioCtx.resume();
        }

        // --- NAVIGATION & UI ---
        function switchTab(tab) {
            document.querySelectorAll('.panel-section').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');
            
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('bg-black', 'text-white');
                btn.classList.add('text-gray-400', 'hover:text-black');
            });

            const activeBtn = document.getElementById(`nav-${tab}`);
            activeBtn.classList.remove('text-gray-400', 'hover:text-black');
            activeBtn.classList.add('bg-black', 'text-white');

            if(tab === 'projects') renderProjectsList();
        }

        function showToast(msg, type = 'neutral') {
            const t = document.getElementById('toast');
            const dot = document.getElementById('toastIcon');
            const txt = document.getElementById('toastMsg');
            
            txt.innerText = msg;
            dot.className = `w-2 h-2 rounded-full ${type === 'error' ? 'bg-red-500' : 'bg-emerald-500'}`;
            
            t.style.opacity = 1; t.style.transform = 'translateY(0)';
            setTimeout(() => { t.style.opacity = 0; t.style.transform = 'translateY(-10px)'; }, 3000);
        }

        // --- PROJECT SYSTEM (LOCALSTORAGE COOKIES) ---
        function saveProject() {
            const project = {
                id: Date.now(),
                title: document.getElementById('topicInput').value || 'Untitled Project',
                date: new Date().toLocaleDateString(),
                data: {
                    script: document.getElementById('scriptText').value,
                    voice: STATE.voice,
                    textColor: document.getElementById('textColor').value,
                    highlightColor: document.getElementById('highlightColor').value,
                    textY: document.getElementById('textY').value,
                    bgMode: document.getElementById('bgMode').value
                }
            };

            let projects = JSON.parse(localStorage.getItem('dingle_projects') || '[]');
            projects.unshift(project); // Add to top
            if(projects.length > 20) projects.pop(); // Keep last 20
            localStorage.setItem('dingle_projects', JSON.stringify(projects));
            
            showToast('Project Saved to Workspace', 'success');
        }

        function renderProjectsList() {
            const list = document.getElementById('projectsList');
            const projects = JSON.parse(localStorage.getItem('dingle_projects') || '[]');
            
            if(projects.length === 0) {
                list.innerHTML = '<div class="text-center py-10"><p class="text-xs text-gray-400">No projects saved yet.</p></div>';
                return;
            }

            list.innerHTML = projects.map(p => `
                <div class="group bg-white border border-gray-200 rounded p-3 hover:border-black transition-colors cursor-pointer relative" onclick="loadProject(${p.id})">
                    <div class="flex justify-between items-start mb-1">
                        <h3 class="font-bold text-xs text-gray-900 truncate pr-6">${p.title}</h3>
                        <span class="text-[9px] text-gray-400 font-mono">${p.date}</span>
                    </div>
                    <p class="text-[10px] text-gray-500 line-clamp-2">${p.data.script.substring(0, 60)}...</p>
                    <button onclick="event.stopPropagation(); deleteProject(${p.id})" class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 text-gray-300 hover:text-red-500 transition-all">
                        <i data-lucide="trash-2" class="w-3 h-3"></i>
                    </button>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function loadProject(id) {
            const projects = JSON.parse(localStorage.getItem('dingle_projects') || '[]');
            const p = projects.find(x => x.id === id);
            if(!p) return;

            document.getElementById('topicInput').value = p.title;
            document.getElementById('scriptText').value = p.data.script;
            selectVoice(p.data.voice);
            document.getElementById('textColor').value = p.data.textColor;
            document.getElementById('highlightColor').value = p.data.highlightColor;
            document.getElementById('textY').value = p.data.textY;
            document.getElementById('bgMode').value = p.data.bgMode;
            
            toggleBgMode();
            renderPreview();
            
            switchTab('studio');
            showToast('Project Loaded', 'success');
        }

        function deleteProject(id) {
            let projects = JSON.parse(localStorage.getItem('dingle_projects') || '[]');
            projects = projects.filter(p => p.id !== id);
            localStorage.setItem('dingle_projects', JSON.stringify(projects));
            renderProjectsList();
        }

        function clearAllProjects() {
            if(confirm('Delete all saved projects?')) {
                localStorage.removeItem('dingle_projects');
                renderProjectsList();
            }
        }

        function saveSettings() {
            const key = document.getElementById('apiKey').value;
            const model = document.getElementById('modelSelect').value;
            localStorage.setItem('dingle_conf', JSON.stringify({ key, model }));
            document.getElementById('settingsModal').classList.add('hidden');
            showToast('API Key Saved', 'success');
        }

        function loadSettings() {
            const conf = JSON.parse(localStorage.getItem('dingle_conf') || '{}');
            if(conf.key) document.getElementById('apiKey').value = conf.key;
            if(conf.model) document.getElementById('modelSelect').value = conf.model;
        }

        // --- ASSET FETCHING ---
        async function fetchReddit() {
            try {
                const sub = ['confessions', 'tifu', 'AmItheAsshole'][Math.floor(Math.random()*3)];
                showToast(`Scanning r/${sub}...`, 'neutral');
                const res = await fetch(`https://www.reddit.com/r/${sub}/top.json?limit=10&t=day`);
                const json = await res.json();
                const post = json.data.children.find(p => p.data.selftext.length > 50 && p.data.selftext.length < 800)?.data;
                
                if(!post) throw new Error("No suitable posts found");
                
                document.getElementById('topicInput').value = `r/${sub}: ${post.title}`;
                document.getElementById('scriptText').value = post.selftext.replace(/Edit:?.*$/si, '').trim();
                showToast('Content Acquired', 'success');
            } catch(e) { showToast('Fetch Failed', 'error'); }
        }

        async function generateAI() {
            const key = document.getElementById('apiKey').value;
            const model = document.getElementById('modelSelect').value;
            if(!key) return showToast("API Key Required", 'error');
            
            showToast("Generating Script...", "neutral");

            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${key}`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: `Write a viral short script about: ${document.getElementById('topicInput').value}. Style: Reddit Story. Max 100 words. Hook first sentence.` }] }] })
                });
                const data = await res.json();
                document.getElementById('scriptText').value = data.candidates[0].content.parts[0].text;
                showToast("Script Generated", 'success');
            } catch(e) { showToast("AI Error", 'error'); }
        }

        // --- AUDIO ENGINE ---
        async function loadPresetAudio() {
             // Mock preset for demo purposes - in real app would be local file
             showToast("Preset 'Lo-Fi' Active (Demo)", 'success');
        }

        async function synthesizeAudio() {
            const key = document.getElementById('apiKey').value;
            const text = document.getElementById('scriptText').value;
            const model = document.getElementById('modelSelect').value;
            
            if(!key || !text) return showToast("API Key & Script Required", 'error');

            const btn = document.getElementById('synthBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<div class="loader w-3 h-3"></div> processing...'; btn.disabled = true;

            try {
                // 1. Fetch Audio
                const endpoint = "gemini-2.0-flash-exp"; 
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${endpoint}:generateContent?key=${key}`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        contents: [{ parts: [{ text: text }] }], 
                        generationConfig: { responseModalities: ["AUDIO"], speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: STATE.voice } } } } 
                    })
                });
                const data = await res.json();
                const binaryString = atob(data.candidates[0].content.parts[0].inlineData.data);
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) bytes[i] = binaryString.charCodeAt(i);
                
                // 2. Decode
                initAudio();
                STATE.ttsBuffer = await STATE.audioCtx.decodeAudioData(bytes.buffer);
                
                // 3. Timing Calculation
                calculateTimings(text, STATE.ttsBuffer.duration);

                showToast("Audio Synthesized", 'success');
                enableControls();
            } catch(e) { showToast("Synthesis Failed", 'error'); console.error(e); }
            
            btn.innerHTML = originalText; btn.disabled = false;
        }

        function calculateTimings(text, duration) {
            const words = text.replace(/\s+/g, ' ').trim().split(' ');
            const durationPerWord = duration / words.length;
            let currentTime = 0;
            
            STATE.words = words.map(w => {
                const data = { word: w, start: currentTime, end: currentTime + durationPerWord };
                currentTime += durationPerWord;
                return data;
            });
        }

        // --- PLAYBACK ---
        function togglePlay() { STATE.isPlaying ? stop() : play(); }

        function play() {
            if (!STATE.ttsBuffer) return;
            STATE.sourceNodes = [];
            STATE.startTime = STATE.audioCtx.currentTime;
            
            const ttsNode = STATE.audioCtx.createBufferSource();
            ttsNode.buffer = STATE.ttsBuffer;
            ttsNode.connect(STATE.audioCtx.destination);
            ttsNode.start(0);
            ttsNode.onended = () => { if(STATE.isPlaying) stop(); };
            STATE.sourceNodes.push(ttsNode);

            video.currentTime = 0;
            video.play();
            STATE.isPlaying = true;
            
            const btn = document.getElementById('playBtn');
            btn.innerHTML = '<i data-lucide="square" class="w-3.5 h-3.5"></i> STOP';
            btn.classList.add('text-red-500', 'border-red-200', 'bg-red-50');
            
            animate();
        }

        function stop() {
            STATE.sourceNodes.forEach(n => { try{n.stop()}catch(e){} });
            video.pause();
            STATE.isPlaying = false;
            cancelAnimationFrame(STATE.animationId);
            
            const btn = document.getElementById('playBtn');
            btn.innerHTML = '<i data-lucide="play" class="w-3.5 h-3.5"></i> PREVIEW';
            btn.classList.remove('text-red-500', 'border-red-200', 'bg-red-50');
            
            renderPreview(); 
        }

        function animate() {
            if (!STATE.isPlaying) return;
            const elapsed = STATE.audioCtx.currentTime - STATE.startTime;
            drawFrame(elapsed);
            STATE.animationId = requestAnimationFrame(animate);
        }

        function drawFrame(time) {
            // Bg
            if (document.getElementById('bgMode').value !== 'solid') {
                const aspect = video.videoWidth / video.videoHeight;
                const canvasAspect = canvas.width / canvas.height;
                let dw, dh, dx, dy;
                if (aspect > canvasAspect) { dh = canvas.height; dw = dh * aspect; dx = (canvas.width - dw)/2; dy = 0; }
                else { dw = canvas.width; dh = dw / aspect; dx = 0; dy = (canvas.height - dh)/2; }
                ctx.drawImage(video, dx, dy, dw, dh);
            } else {
                ctx.fillStyle = '#000'; ctx.fillRect(0,0,canvas.width,canvas.height);
            }

            // Dimmer
            ctx.fillStyle = 'rgba(0,0,0,0.4)'; ctx.fillRect(0,0,canvas.width,canvas.height);

            // Text
            const activeData = STATE.words.find(w => time >= w.start && time < w.end) || STATE.words[STATE.words.length-1];
            
            if (activeData && time < STATE.ttsBuffer.duration + 0.5) {
                const fontSize = 80;
                ctx.font = `900 ${fontSize}px "Inter", sans-serif`;
                ctx.textAlign = 'center';
                
                const yPos = canvas.height/2 + parseInt(document.getElementById('textY').value);
                const currentWord = activeData.word.toUpperCase().replace(/[^A-Z0-9]/g, '');
                const isHighlight = ['WHAT','NO','STOP','DIED','KILLED','MONEY','SECRET'].some(h => currentWord.includes(h));
                
                ctx.lineJoin = 'round'; ctx.lineWidth = 15; ctx.strokeStyle = 'black';
                ctx.strokeText(currentWord, canvas.width/2, yPos);
                
                ctx.fillStyle = isHighlight ? document.getElementById('highlightColor').value : document.getElementById('textColor').value;
                ctx.fillText(currentWord, canvas.width/2, yPos);
            }
        }

        function renderPreview() {
            if(STATE.isPlaying) return;
            ctx.fillStyle = '#0f172a'; ctx.fillRect(0,0,canvas.width,canvas.height);
            ctx.font = '700 60px "Inter"'; ctx.fillStyle = '#334155'; ctx.textAlign = 'center';
            ctx.fillText("PREVIEW", canvas.width/2, canvas.height/2);
        }

        // --- EXPORT ---
        async function startExport() {
            if(!STATE.ttsBuffer) return;
            STATE.isExporting = true;
            document.getElementById('exportOverlay').classList.remove('hidden');
            
            const dest = STATE.audioCtx.createMediaStreamDestination();
            const tts = STATE.audioCtx.createBufferSource(); 
            tts.buffer = STATE.ttsBuffer; 
            tts.connect(dest);
            tts.start(0);
            video.currentTime = 0; video.play();

            const stream = canvas.captureStream(30);
            const combined = new MediaStream([...stream.getVideoTracks(), ...dest.stream.getAudioTracks()]);
            const recorder = new MediaRecorder(combined, { mimeType: 'video/webm;codecs=vp9', videoBitsPerSecond: 8000000 });
            
            const chunks = [];
            recorder.ondataavailable = e => chunks.push(e.data);
            recorder.onstop = () => {
                const blob = new Blob(chunks, {type:'video/webm'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href=url; a.download=`Dingle_${Date.now()}.webm`; a.click();
                STATE.isExporting = false;
                document.getElementById('exportOverlay').classList.add('hidden');
                stop();
            };

            recorder.start();
            
            const dur = STATE.ttsBuffer.duration;
            const start = STATE.audioCtx.currentTime;
            
            function loop() {
                if(!STATE.isExporting) return;
                const t = STATE.audioCtx.currentTime - start;
                drawFrame(t);
                document.getElementById('renderTime').innerText = `Rendering: ${Math.round((t/dur)*100)}%`;
                if(t >= dur) recorder.stop();
                else requestAnimationFrame(loop);
            }
            loop();
        }

        function cancelExport() { STATE.isExporting = false; stop(); document.getElementById('exportOverlay').classList.add('hidden'); }

        // --- UTILS ---
        function selectVoice(v) {
            STATE.voice = v;
            document.querySelectorAll('.voice-btn').forEach(b => {
                b.className = "voice-btn bg-white text-gray-500 py-2 text-xs font-bold rounded border border-gray-200 hover:border-gray-300";
            });
            document.getElementById('voice-'+v).className = "voice-btn bg-black text-white py-2 text-xs font-bold rounded border border-transparent";
        }
        function toggleBgMode() {
            const mode = document.getElementById('bgMode').value;
            document.getElementById('uploadZone').style.display = mode === 'upload' ? 'block' : 'none';
            if(mode === 'minecraft') { video.src = 'https://assets.mixkit.co/videos/preview/mixkit-stars-in-space-background-1610-large.mp4'; video.load(); }
            renderPreview();
        }
        function handleVideoUpload(f) { if(f) video.src = URL.createObjectURL(f); }
        function enableControls() { 
            ['playBtn','exportBtn'].forEach(id => {
                const el = document.getElementById(id);
                el.disabled=false;
                el.classList.remove('cursor-not-allowed','opacity-50');
            });
            document.getElementById('playBtn').classList.replace('text-gray-300','text-gray-900');
            document.getElementById('playBtn').classList.replace('border-gray-200','border-gray-900');
        }
        
        // Word Count
        document.getElementById('scriptText').addEventListener('input', function() {
            const count = this.value.trim().split(/\s+/).length;
            document.getElementById('wordCount').innerText = this.value === '' ? '0 words' : count + ' words';
        });

    </script>
</body>
</html>
