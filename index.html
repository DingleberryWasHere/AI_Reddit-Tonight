<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dingle Studio | Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root { --accent: #000000; --bg: #ffffff; --border: #e5e5e5; }
        body { font-family: 'Inter', sans-serif; background-color: #f3f3f3; color: #111; overflow: hidden; }
        
        /* Custom Scrollbar */
        .no-scrollbar::-webkit-scrollbar { width: 0px; display: none; }
        
        /* Range Slider */
        input[type=range] { -webkit-appearance: none; background: transparent; cursor: pointer; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%;
            background: var(--accent); margin-top: -7px; border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: transform 0.1s;
        }
        input[type=range]::-webkit-slider-thumb:active { transform: scale(1.2); }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 2px; background: #ddd; border-radius: 2px;
        }

        /* Canvas Wrapper */
        .canvas-container {
            height: 85vh; aspect-ratio: 9/16; 
            background: #000; border-radius: 12px;
            box-shadow: 0 50px 100px -20px rgba(0,0,0,0.2);
            position: relative; overflow: hidden; border: 4px solid #fff;
        }

        /* Animations */
        .fade-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .loader { width: 18px; height: 18px; border: 2px solid #ddd; border-top-color: #000; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="h-screen w-screen flex">

    <div class="w-[400px] bg-white h-full flex flex-col border-r border-gray-200 z-20 shrink-0 shadow-sm">
        
        <div class="px-6 py-5 border-b border-gray-100 flex justify-between items-center bg-white/50 backdrop-blur-sm">
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 bg-black text-white rounded-lg flex items-center justify-center shadow-lg shadow-black/20">
                    <i data-lucide="zap" class="w-4 h-4"></i>
                </div>
                <div>
                    <h1 class="font-bold text-sm tracking-tight">Dingle<span class="text-gray-400 font-normal">Studio</span></h1>
                    <p class="text-[10px] text-gray-400 font-medium">Viral Generator v3.1</p>
                </div>
            </div>
            <button onclick="toggleSettings()" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-400 hover:text-black transition-all" title="Settings">
                <i data-lucide="settings-2" class="w-4 h-4"></i>
            </button>
        </div>

        <div class="flex-1 overflow-y-auto no-scrollbar p-6 space-y-8">
            
            <section class="space-y-3 fade-in" style="animation-delay: 0ms;">
                <div class="flex justify-between items-center">
                    <label class="text-[11px] font-bold text-gray-900 uppercase tracking-wider flex items-center gap-2">
                        <span class="w-5 h-5 rounded bg-gray-100 flex items-center justify-center text-gray-500">1</span> Narrative
                    </label>
                    <div class="flex gap-2">
                        <button onclick="fetchReddit()" class="bg-orange-50 text-orange-600 border border-orange-100 hover:bg-orange-100 px-3 py-1.5 rounded-md text-[10px] font-bold transition-all flex items-center gap-1">
                            <i data-lucide="flame" class="w-3 h-3"></i> Viral
                        </button>
                        <button onclick="generateAI()" class="bg-blue-50 text-blue-600 border border-blue-100 hover:bg-blue-100 px-3 py-1.5 rounded-md text-[10px] font-bold transition-all flex items-center gap-1">
                            <i data-lucide="sparkles" class="w-3 h-3"></i> AI
                        </button>
                    </div>
                </div>
                <input id="topicInput" type="text" class="w-full bg-gray-50 border border-transparent hover:bg-white hover:border-gray-200 focus:bg-white focus:border-black rounded-xl px-4 py-3 text-xs font-medium outline-none transition-all placeholder-gray-400" placeholder="Topic or Subreddit...">
                <div class="relative">
                    <textarea id="scriptText" rows="5" class="w-full bg-gray-50 border border-transparent hover:bg-white hover:border-gray-200 focus:bg-white focus:border-black rounded-xl p-4 text-xs font-medium outline-none transition-all resize-none leading-relaxed text-gray-700" placeholder="Enter your script here..."></textarea>
                    <div class="absolute bottom-3 right-3 text-[9px] text-gray-300 font-mono" id="charCount">0/1000</div>
                </div>
            </section>

            <section class="space-y-4 fade-in" style="animation-delay: 50ms;">
                <label class="text-[11px] font-bold text-gray-900 uppercase tracking-wider flex items-center gap-2">
                    <span class="w-5 h-5 rounded bg-gray-100 flex items-center justify-center text-gray-500">2</span> Audio
                </label>
                
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="selectVoice('Puck')" id="voice-Puck" class="voice-btn relative overflow-hidden group bg-black text-white border border-transparent rounded-xl py-3 text-xs font-bold shadow-md transition-all">
                        <span class="relative z-10">Puck (Male)</span>
                    </button>
                    <button onclick="selectVoice('Kore')" id="voice-Kore" class="voice-btn relative overflow-hidden group bg-white text-gray-500 border border-gray-200 rounded-xl py-3 text-xs font-bold hover:border-gray-300 transition-all">
                        <span class="relative z-10">Kore (Female)</span>
                    </button>
                </div>

                <div class="bg-gray-50 rounded-xl p-4 border border-gray-100 space-y-3">
                    <div class="flex items-center gap-3">
                        <button onclick="document.getElementById('bgMusicInput').click()" class="w-10 h-10 bg-white rounded-lg flex items-center justify-center text-gray-400 hover:text-black border border-gray-200 hover:border-black transition-all">
                            <i data-lucide="music" class="w-4 h-4"></i>
                        </button>
                        <div class="flex-1 overflow-hidden">
                            <p class="text-[10px] text-gray-400 font-bold uppercase tracking-wider">Background Music</p>
                            <p id="musicName" class="text-xs font-bold text-gray-900 truncate">None Selected</p>
                            <input type="file" id="bgMusicInput" accept="audio/*" class="hidden" onchange="handleMusicUpload(this)">
                        </div>
                    </div>
                    <div class="pt-2">
                        <div class="flex justify-between text-[9px] font-bold text-gray-400 mb-1"><span>VOLUME</span> <span id="volDisp">20%</span></div>
                        <input type="range" id="musicVol" min="0" max="1" step="0.05" value="0.2" oninput="document.getElementById('volDisp').innerText = Math.round(this.value*100)+'%'">
                    </div>
                </div>

                <button onclick="synthesizeAudio()" id="synthBtn" class="w-full bg-white border-2 border-gray-100 hover:border-black text-gray-900 py-3.5 rounded-xl font-bold text-xs transition-all flex justify-center items-center gap-2 shadow-sm active:scale-[0.98]">
                    GENERATE AUDIO TRACK
                </button>
            </section>

            <section class="space-y-4 fade-in" style="animation-delay: 100ms;">
                <label class="text-[11px] font-bold text-gray-900 uppercase tracking-wider flex items-center gap-2">
                    <span class="w-5 h-5 rounded bg-gray-100 flex items-center justify-center text-gray-500">3</span> Visuals
                </label>

                <div class="relative">
                    <select id="bgMode" onchange="toggleBgMode()" class="w-full appearance-none bg-gray-50 border border-transparent hover:bg-white hover:border-gray-200 text-gray-900 text-xs font-bold rounded-xl px-4 py-3 outline-none focus:border-black cursor-pointer transition-all">
                        <option value="minecraft">Minecraft Gameplay</option>
                        <option value="slime">Satisfying Slime</option>
                        <option value="upload">Custom Upload</option>
                        <option value="solid">Solid Color</option>
                    </select>
                    <i data-lucide="chevron-down" class="absolute right-4 top-3.5 w-4 h-4 text-gray-400 pointer-events-none"></i>
                </div>
                
                <div id="uploadZone" class="hidden">
                     <input type="file" id="bgVideoInput" accept="video/*" class="hidden" onchange="handleVideoUpload(this.files[0])">
                     <button onclick="document.getElementById('bgVideoInput').click()" class="w-full border-2 border-dashed border-gray-200 py-6 rounded-xl text-[10px] font-bold text-gray-400 hover:border-black hover:text-black transition-all bg-gray-50/50">
                        CLICK TO UPLOAD .MP4
                     </button>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-[9px] font-bold text-gray-400 uppercase mb-2 block">Text Color</label>
                        <div class="h-10 w-full bg-white border border-gray-200 rounded-xl flex items-center px-2 cursor-pointer hover:border-black transition-colors">
                            <input type="color" id="textColor" value="#ffffff" class="w-full h-6 cursor-pointer bg-transparent border-none">
                        </div>
                    </div>
                    <div>
                        <label class="text-[9px] font-bold text-gray-400 uppercase mb-2 block">Highlight</label>
                        <div class="h-10 w-full bg-white border border-gray-200 rounded-xl flex items-center px-2 cursor-pointer hover:border-black transition-colors">
                            <input type="color" id="highlightColor" value="#fbbf24" class="w-full h-6 cursor-pointer bg-transparent border-none">
                        </div>
                    </div>
                </div>
                
                <div>
                    <div class="flex justify-between text-[9px] font-bold text-gray-400 mb-2"><span>Y-OFFSET</span> <span id="yVal">0</span></div>
                    <input type="range" id="textY" min="-300" max="300" value="0" class="w-full" oninput="renderPreview(); document.getElementById('yVal').innerText = this.value">
                </div>
            </section>
            
            <div class="h-10"></div>
        </div>

        <div class="p-5 border-t border-gray-200 bg-white z-30 grid grid-cols-2 gap-3">
            <button onclick="togglePlay()" id="playBtn" disabled class="bg-gray-100 text-gray-400 cursor-not-allowed py-4 rounded-xl font-black text-xs transition-all flex items-center justify-center gap-2 hover:bg-gray-200">
                <i data-lucide="play" class="w-4 h-4"></i> PREVIEW
            </button>
            <button onclick="startExport()" id="exportBtn" disabled class="bg-black text-white opacity-50 cursor-not-allowed py-4 rounded-xl font-black text-xs transition-all flex items-center justify-center gap-2 hover:bg-gray-800 shadow-xl shadow-black/10">
                <i data-lucide="download" class="w-4 h-4"></i> EXPORT
            </button>
        </div>
    </div>

    <div class="flex-1 bg-gray-50 relative flex justify-center items-center p-8 bg-[url('https://www.transparenttextures.com/patterns/grid-me.png')]">
        
        <div id="toast" class="absolute top-8 bg-white border border-gray-200 pl-3 pr-5 py-3 rounded-xl shadow-xl transition-all opacity-0 -translate-y-4 z-50 flex items-center gap-3">
            <div id="toastIcon" class="w-2 h-2 rounded-full bg-black"></div>
            <div>
                <p id="toastMsg" class="text-xs font-bold text-gray-900">Notification</p>
                <p id="toastSub" class="text-[9px] text-gray-500 font-mono hidden"></p>
            </div>
        </div>

        <div class="canvas-container">
            <canvas id="mainCanvas" class="w-full h-full object-contain"></canvas>
            <video id="bgVideo" class="absolute top-0 left-0 w-px h-px opacity-0 pointer-events-none" loop muted playsinline></video>
            
            <div id="renderOverlay" class="absolute inset-0 bg-white/98 backdrop-blur-md z-50 flex flex-col items-center justify-center hidden fade-in">
                <div class="loader mb-6 border-gray-200 border-t-black"></div>
                <h3 class="font-black text-lg tracking-tight mb-1">RENDERING VIDEO</h3>
                <p id="renderProgress" class="text-xs text-gray-500 font-mono mb-6">Processing Frames: 0%</p>
                <button onclick="cancelExport()" class="text-[10px] font-bold text-red-500 hover:text-red-600 tracking-wider">CANCEL OPERATION</button>
            </div>
        </div>
    </div>

    <div id="settingsModal" class="fixed inset-0 bg-black/60 z-[100] hidden flex items-center justify-center backdrop-blur-sm fade-in">
        <div class="bg-white rounded-2xl w-[400px] shadow-2xl p-8 space-y-6">
            <div class="flex justify-between items-center">
                <h3 class="font-bold text-lg">Engine Settings</h3>
                <button onclick="toggleSettings()" class="text-gray-400 hover:text-black"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            
            <div class="space-y-4">
                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-gray-400 uppercase">Gemini API Key</label>
                    <input id="apiKey" type="password" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-xs font-mono focus:border-black outline-none transition-all" placeholder="Paste your Google AI Studio Key">
                    <p class="text-[9px] text-gray-400">Required for AI Script & Audio generation.</p>
                </div>
                
                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-gray-400 uppercase">AI Model</label>
                    <select id="modelSelect" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-xs font-bold focus:border-black outline-none">
                        <option value="gemini-2.0-flash-exp">Gemini 2.0 Flash Exp (Experimental)</option>
                        <option value="gemini-1.5-pro">Gemini 1.5 Pro (Stable Text)</option>
                    </select>
                </div>
            </div>

            <button onclick="saveSettings()" class="w-full bg-black text-white py-4 rounded-xl text-xs font-bold hover:bg-gray-800 transition-all shadow-lg">Save Configuration</button>
        </div>
    </div>

    <script>
        // --- CORE CONFIG ---
        const CONFIG = { w: 1080, h: 1920 };
        let STATE = {
            voice: 'Puck',
            audioCtx: null,
            bgBuffer: null,
            ttsBuffer: null,
            words: [],
            isPlaying: false,
            isExporting: false,
            startTime: 0,
            animId: null,
            sourceNodes: []
        };

        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d');
        const video = document.getElementById('bgVideo');

        // --- INITIALIZATION ---
        window.onload = () => {
            lucide.createIcons();
            canvas.width = CONFIG.w; canvas.height = CONFIG.h;
            
            // Load Settings
            const conf = JSON.parse(localStorage.getItem('dingle_conf') || '{}');
            if(conf.key) document.getElementById('apiKey').value = conf.key;
            
            // Load Default Video (Minecraft)
            video.src = 'https://assets.mixkit.co/videos/preview/mixkit-stars-in-space-background-1610-large.mp4'; 
            video.load();
            
            // Interaction Listener for Audio Context
            document.body.addEventListener('click', initAudio, { once: true });
            
            renderPreview();
        };

        function initAudio() {
            if (!STATE.audioCtx) STATE.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (STATE.audioCtx.state === 'suspended') STATE.audioCtx.resume();
        }

        // --- UI MANAGERS ---
        function toggleSettings() { document.getElementById('settingsModal').classList.toggle('hidden'); }
        
        function saveSettings() {
            const key = document.getElementById('apiKey').value;
            const model = document.getElementById('modelSelect').value;
            localStorage.setItem('dingle_conf', JSON.stringify({ key, model }));
            toggleSettings();
            showToast('Configuration Saved', 'success');
        }

        function showToast(msg, type, subMsg = "") {
            const t = document.getElementById('toast');
            document.getElementById('toastMsg').innerText = msg;
            const sub = document.getElementById('toastSub');
            
            if(subMsg) { sub.innerText = subMsg; sub.classList.remove('hidden'); }
            else { sub.classList.add('hidden'); }

            document.getElementById('toastIcon').className = `w-2 h-2 rounded-full ${type=='error'?'bg-red-500':'bg-emerald-500'}`;
            t.style.opacity = 1; t.style.transform = 'translateY(0)';
            
            setTimeout(() => { t.style.opacity = 0; t.style.transform = 'translateY(-16px)'; }, 4000);
        }

        // --- REDDIT FETCH ---
        async function fetchReddit() {
            const subs = ['confessions', 'tifu', 'AmItheAsshole', 'TrueOffMyChest'];
            const sub = subs[Math.floor(Math.random() * subs.length)];
            
            showToast(`Scanning r/${sub}...`, 'neutral');
            
            try {
                // Fetch more posts to ensure variety
                const res = await fetch(`https://www.reddit.com/r/${sub}/top.json?limit=30&t=week`);
                const json = await res.json();
                
                // Filter: No NSFW, No Stickies, Good Length
                const valid = json.data.children.filter(c => {
                    const t = c.data.selftext;
                    return !c.data.over_18 && !c.data.stickied && t.length > 100 && t.length < 800;
                });

                if(valid.length === 0) throw new Error("No suitable posts found in batch.");

                // Select Random
                const post = valid[Math.floor(Math.random() * valid.length)].data;
                const cleanText = post.selftext.replace(/Edit:?.*$/si, '').replace(/\(http.*?\)/g, '').trim();
                
                document.getElementById('topicInput').value = `r/${sub}: ${post.title}`;
                document.getElementById('scriptText').value = cleanText;
                
                showToast('Viral Story Loaded', 'success');
                updateCharCount();

            } catch(e) {
                console.error(e);
                showToast('Fetch Failed', 'error', 'Try again or check network.');
            }
        }

        async function generateAI() {
            const key = document.getElementById('apiKey').value;
            if(!key) return toggleSettings();
            
            showToast('AI Drafting...', 'neutral');
            const model = document.getElementById('modelSelect').value;

            try {
                // We use standard Gemini for text (safe fallback)
                const safeModel = "gemini-1.5-flash"; 
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${safeModel}:generateContent?key=${key}`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: `Write a viral short video script about: ${document.getElementById('topicInput').value || 'a crazy secret'}. Style: First person Reddit confession. Max 100 words. No intro.` }] }] })
                });
                const data = await res.json();
                if(data.error) throw new Error(data.error.message);
                
                document.getElementById('scriptText').value = data.candidates[0].content.parts[0].text;
                showToast('Script Generated', 'success');
                updateCharCount();
            } catch(e) { showToast('AI Text Error', 'error', e.message); }
        }

        // --- AUDIO ENGINE (FIXED) ---
        async function synthesizeAudio() {
            const key = document.getElementById('apiKey').value;
            let text = document.getElementById('scriptText').value;
            
            if(!key) { toggleSettings(); return; }
            if(!text) return showToast('No Script Text', 'error');
            
            // Truncate if too long to prevent API error
            if(text.length > 2000) {
                text = text.substring(0, 2000);
                showToast('Text Truncated', 'neutral', 'Max 2000 chars for Audio');
            }

            const btn = document.getElementById('synthBtn');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = 'GENERATING...'; btn.disabled = true;

            try {
                // Ensure audio context is ready
                initAudio();
                
                // Using 2.0 Flash Exp for Audio - STRICT CONFIG
                const endpoint = "gemini-2.0-flash-exp"; 
                
                const payload = {
                    contents: [{ parts: [{ text: text }] }],
                    generationConfig: {
                        responseModalities: ["AUDIO"],
                        speechConfig: {
                            voiceConfig: {
                                prebuiltVoiceConfig: { voiceName: STATE.voice }
                            }
                        }
                    }
                };

                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${endpoint}:generateContent?key=${key}`, {
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });

                const data = await res.json();
                
                // DETAILED ERROR HANDLING
                if(data.error) throw new Error("API Error: " + data.error.message);
                if(!data.candidates || !data.candidates[0].content || !data.candidates[0].content.parts[0].inlineData) {
                    throw new Error("Model returned no audio. Try a shorter script or check API Key permissions.");
                }

                // Decode
                const binary = atob(data.candidates[0].content.parts[0].inlineData.data);
                const bytes = new Uint8Array(binary.length);
                for(let i=0; i<binary.length; i++) bytes[i] = binary.charCodeAt(i);

                STATE.ttsBuffer = await STATE.audioCtx.decodeAudioData(bytes.buffer);
                
                // Calc Timings (Density Check)
                const words = text.replace(/[\n\r]/g, ' ').replace(/\s+/g, ' ').trim().split(' ');
                const durPerWord = STATE.ttsBuffer.duration / words.length;
                let t = 0;
                STATE.words = words.map(w => {
                    const d = { word: w, start: t, end: t + durPerWord };
                    t += durPerWord;
                    return d;
                });

                showToast('Audio Synthesized', 'success');
                enableControls();

            } catch(e) {
                console.error(e);
                showToast('Synthesis Failed', 'error', e.message.substring(0, 40) + '...');
            }
            
            btn.innerHTML = originalHTML; btn.disabled = false;
        }

        // --- PLAYBACK ---
        function togglePlay() { STATE.isPlaying ? stop() : play(); }

        function play() {
            if(!STATE.ttsBuffer) return;
            STATE.sourceNodes = [];
            STATE.startTime = STATE.audioCtx.currentTime;

            // TTS
            const tts = STATE.audioCtx.createBufferSource();
            tts.buffer = STATE.ttsBuffer;
            tts.connect(STATE.audioCtx.destination);
            tts.start(0);
            tts.onended = () => { if(STATE.isPlaying) stop(); };
            STATE.sourceNodes.push(tts);

            // Music
            if(STATE.bgBuffer) {
                const bg = STATE.audioCtx.createBufferSource();
                bg.buffer = STATE.bgBuffer; bg.loop = true;
                const gain = STATE.audioCtx.createGain();
                gain.gain.value = parseFloat(document.getElementById('musicVol').value);
                bg.connect(gain).connect(STATE.audioCtx.destination);
                bg.start(0);
                STATE.sourceNodes.push(bg);
            }

            video.currentTime = 0; video.play();
            STATE.isPlaying = true;
            
            // UI Update
            const btn = document.getElementById('playBtn');
            btn.innerHTML = '<i data-lucide="square" class="w-4 h-4 fill-current"></i> STOP';
            btn.className = "bg-red-500 text-white py-4 rounded-xl font-black text-xs transition-all flex items-center justify-center gap-2 hover:bg-red-600 shadow-xl shadow-red-500/20";
            
            animate();
        }

        function stop() {
            STATE.sourceNodes.forEach(n => { try{n.stop()}catch(e){} });
            video.pause();
            STATE.isPlaying = false;
            cancelAnimationFrame(STATE.animId);
            
            const btn = document.getElementById('playBtn');
            btn.innerHTML = '<i data-lucide="play" class="w-4 h-4"></i> PREVIEW';
            btn.className = "bg-gray-100 text-gray-400 py-4 rounded-xl font-black text-xs transition-all flex items-center justify-center gap-2 hover:bg-gray-200 hover:text-black";
            
            renderPreview();
        }

        // --- RENDER ENGINE (With Wrapping) ---
        function animate() {
            if(!STATE.isPlaying) return;
            const t = STATE.audioCtx.currentTime - STATE.startTime;
            drawFrame(t);
            STATE.animId = requestAnimationFrame(animate);
        }

        function drawFrame(time) {
            // Background
            if(document.getElementById('bgMode').value !== 'solid') {
                const aspect = video.videoWidth / video.videoHeight;
                const canvasAspect = canvas.width / canvas.height;
                let dw, dh, dx, dy;
                if(aspect > canvasAspect) { dh = canvas.height; dw = dh * aspect; dx = (canvas.width - dw)/2; dy = 0; }
                else { dw = canvas.width; dh = dw / aspect; dx = 0; dy = (canvas.height - dh)/2; }
                ctx.drawImage(video, dx, dy, dw, dh);
            } else {
                ctx.fillStyle = '#000'; ctx.fillRect(0,0,canvas.width,canvas.height);
            }

            // Dimmer
            ctx.fillStyle = 'rgba(0,0,0,0.5)'; ctx.fillRect(0,0,canvas.width,canvas.height);

            // Text Logic
            if(time < STATE.ttsBuffer.duration + 0.5) {
                const activeData = STATE.words.find(w => time >= w.start && time < w.end) || STATE.words[STATE.words.length-1];
                
                if(activeData) {
                    const fontSize = 85;
                    ctx.font = `900 ${fontSize}px "Inter", sans-serif`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    
                    const word = activeData.word.toUpperCase().replace(/[^A-Z0-9']/g, '');
                    const centerX = canvas.width/2;
                    const centerY = (canvas.height/2) + parseInt(document.getElementById('textY').value);
                    
                    // Style
                    const isHighlight = ['WHAT','NO','STOP','DIED','KILLED','SECRET','CRAZY','WHY','HOW'].some(x => word.includes(x));
                    const fillColor = isHighlight ? document.getElementById('highlightColor').value : document.getElementById('textColor').value;
                    
                    ctx.lineJoin = 'round'; ctx.lineWidth = 20; ctx.strokeStyle = 'black';
                    ctx.strokeText(word, centerX, centerY);
                    ctx.fillStyle = fillColor;
                    ctx.fillText(word, centerX, centerY);
                }
            }
        }

        function renderPreview() {
            if(STATE.isPlaying) return;
            ctx.fillStyle = '#111'; ctx.fillRect(0,0,canvas.width,canvas.height);
            ctx.font = '700 40px "Inter"'; ctx.fillStyle = '#333'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            ctx.fillText("PREVIEW MODE", canvas.width/2, canvas.height/2);
        }

        // --- EXPORT ---
        async function startExport() {
            STATE.isExporting = true;
            document.getElementById('renderOverlay').classList.remove('hidden');
            
            // Audio Stream
            const dest = STATE.audioCtx.createMediaStreamDestination();
            const tts = STATE.audioCtx.createBufferSource(); tts.buffer = STATE.ttsBuffer; tts.connect(dest); tts.start(0);
            
            if(STATE.bgBuffer) {
                const bg = STATE.audioCtx.createBufferSource(); bg.buffer = STATE.bgBuffer; bg.loop=true;
                const g = STATE.audioCtx.createGain(); g.gain.value = parseFloat(document.getElementById('musicVol').value);
                bg.connect(g).connect(dest); bg.start(0);
            }
            
            video.currentTime = 0; video.play();
            
            // Capture
            const stream = canvas.captureStream(30);
            const combined = new MediaStream([...stream.getVideoTracks(), ...dest.stream.getAudioTracks()]);
            const recorder = new MediaRecorder(combined, { mimeType: 'video/webm;codecs=vp9', videoBitsPerSecond: 8000000 });
            
            const chunks = [];
            recorder.ondataavailable = e => chunks.push(e.data);
            recorder.onstop = () => {
                const url = URL.createObjectURL(new Blob(chunks, {type:'video/webm'}));
                const a = document.createElement('a'); a.href=url; a.download=`Dingle_${Date.now()}.webm`; a.click();
                cancelExport();
            };
            
            recorder.start();
            
            const dur = STATE.ttsBuffer.duration;
            const startT = STATE.audioCtx.currentTime;
            
            function loop() {
                if(!STATE.isExporting) return;
                const t = STATE.audioCtx.currentTime - startT;
                drawFrame(t);
                const pct = Math.min(100, Math.round((t/dur)*100));
                document.getElementById('renderProgress').innerText = `Processing: ${pct}%`;
                if(t >= dur) recorder.stop();
                else requestAnimationFrame(loop);
            }
            loop();
        }

        function cancelExport() { STATE.isExporting = false; stop(); document.getElementById('renderOverlay').classList.add('hidden'); }

        // --- HELPERS ---
        function selectVoice(v) {
            STATE.voice = v;
            document.querySelectorAll('.voice-btn').forEach(b => {
                b.className = "voice-btn relative overflow-hidden group bg-white text-gray-500 border border-gray-200 rounded-xl py-3 text-xs font-bold hover:border-gray-300 transition-all";
            });
            document.getElementById('voice-'+v).className = "voice-btn relative overflow-hidden group bg-black text-white border border-transparent rounded-xl py-3 text-xs font-bold shadow-md transition-all";
        }

        function toggleBgMode() {
            const m = document.getElementById('bgMode').value;
            document.getElementById('uploadZone').style.display = m === 'upload' ? 'block' : 'none';
            if(m === 'minecraft') video.src = 'https://assets.mixkit.co/videos/preview/mixkit-stars-in-space-background-1610-large.mp4'; 
            if(m === 'slime') video.src = 'https://assets.mixkit.co/videos/preview/mixkit-pink-and-blue-ink-swirling-in-water-1613-large.mp4';
            video.load();
            renderPreview();
        }
        function handleVideoUpload(f) { if(f) video.src = URL.createObjectURL(f); }
        function handleMusicUpload(f) { 
            if(!f.files[0]) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                initAudio();
                STATE.bgBuffer = await STATE.audioCtx.decodeAudioData(e.target.result);
                document.getElementById('musicName').innerText = f.files[0].name;
            };
            reader.readAsArrayBuffer(f.files[0]);
        }
        function enableControls() {
            ['playBtn','exportBtn'].forEach(id => {
                document.getElementById(id).disabled = false;
                document.getElementById(id).classList.remove('opacity-50','cursor-not-allowed');
            });
            document.getElementById('playBtn').classList.replace('text-gray-400','text-gray-900');
        }
        function updateCharCount() {
            const len = document.getElementById('scriptText').value.length;
            document.getElementById('charCount').innerText = `${len}/2000`;
            document.getElementById('charCount').className = `absolute bottom-3 right-3 text-[9px] font-mono ${len>1900?'text-red-500':'text-gray-300'}`;
        }
        document.getElementById('scriptText').addEventListener('input', updateCharCount);
    </script>
</body>
</html>
